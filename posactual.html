<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  // Configuraci√≥n segura para Marked
  marked.setOptions({
    breaks: true,      // Convierte saltos de l√≠nea en <br>
    sanitize: false,   // Desactivado porque usaremos DOMPurify
    mangle: false,     // No modificar caracteres
    headerIds: false   // No generar IDs para cabeceras
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true,
      processEnvironments: true
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#fbc318',
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #ffffff;
      color: #333;
      margin: 0;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    
    /* Forms and Inputs */
    input[type="text"], input[type="number"] {
      padding: 0.875rem;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      border: 2px solid #333;
      border-radius: 0.5rem;
      font-size: 1.125rem;
      outline: none;
      transition: all 0.3s;
    }
    
    input[type="text"]:focus, input[type="number"]:focus {
      border-color: #fbc318;
      box-shadow: 0 0 0 2px rgba(229, 57, 53, 0.2);
    }
    
    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.25rem;
      background: white;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    th {
      background-color: #fbc318;
      color: black;
      padding: 1rem;
      font-weight: 600;
      text-align: left;
      font-size: 1rem;
    }
    
    td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      font-size: 1rem;
    }
    
    /* Buttons */
    button {
      background-color: #fbc318;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 0.75rem;
      cursor: pointer;
      font-size: 1.125rem;
      font-weight: 600;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      min-width: 180px;
    }
    
    button:hover {
      background-color: #d32f2f;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    /* Modals and Dialogs */
    #dialog, #quantityDialog {
      display: none;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 400px;
    }
    
.modal {
  /* display: none; /* Initially hidden - controlled by JS */
  position: fixed; /* Or absolute, depending on context */
  z-index: 1000;  /* Or higher */
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto; /* Enable scroll if needed */
  background-color: rgba(0,0,0,0.5); /* Semi-transparent background */
  /* Added for alignment, adjust if needed */
  display: none; /* Start hidden */
  align-items: center;
  justify-content: center;
}

.modal-content {
  background-color: white;
  margin: 10% auto;
  padding: 2.5rem;
  border-radius: 1rem;
  width: 90%;
  max-width: 700px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  position: relative;
}
    
/* Screen Blocker with Spinner */
#screenBlocker {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100vh;
  background-color: rgba(255, 255, 255, 0.9);
  z-index: 9999;
  backdrop-filter: blur(8px);
  justify-content: center;
  align-items: center;
}

#screenBlocker.active {
  display: flex;
}

.blocker-content {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1.5rem;
  padding: 2rem;
  background: white;
  border-radius: 1rem;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.loader {
  width: 48px;
  height: 48px;
  border: 4px solid #e2e2e2;
  border-bottom-color: #fbc318;
  border-radius: 50%;
  animation: rotation 1s linear infinite;
  margin: 0;
}

#blockerMessage {
  color: #000;
  font-size: 1.95rem;
  font-weight: 900;
  margin: 0;
}

@keyframes rotation {
 0% { transform: rotate(0deg) }
 100% { transform: rotate(360deg) }
}
    
    /* Payment Modal Styles */
    #paymentModal button {
      min-width: 150px;
      font-size: 1.85rem;
      padding: 1.25rem 2.5rem;
      margin: 0 0.75rem;
    }
    
    #paymentModal input {
      font-size: 1.5rem;
      padding: 1.25rem;
    }
    
    #paymentModal .modal-content {
  max-width: 500px;
}
    
    @keyframes flash-green {
      0% { background-color: rgba(76, 175, 80, 0.5) }
      100% { background-color: transparent }
    }
    
    .flash-green {
      animation: flash-green 1s ease-out;
    }
    
    /* Client Display */
    .client-display {
      position: absolute;
      top: 1.25rem;
      left: 1.25rem;
      background-color: white;
      padding: 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    /* Total Container */
    #totalContainer {
      position: absolute;
      top: 1.25rem;
      right: 1.25rem;
      font-size: 2rem;
      font-weight: bold;
      color: #000;
      background-color: white;
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
    }
    
    /* Additional Utility Classes */
    .search-container {
      width: 60%;
      margin: 0 auto;
    }
    
    .cart-container {
      width: 88%;
      margin: 2rem auto;
    }

    .highlighted-row {
      box-shadow: 0 0 0 2px #4CAF50 inset;
    }

    .low-stock {
      background-color: #fee2e2;
    }

    .edit-mode-button {
      display: none;
      margin-top: 0.75rem;
      background-color: #4caf50;
      position: absolute;
      top: 1.25rem;
      left: 1.25rem;
      font-size: 1rem;
      padding: 0.75rem 1.25rem;
    }

    /* Alert Styles */
    #customAlert .modal-content {
      max-width: 450px;
      text-align: center;
    }

    #alertMessage {
      font-size: 1.25rem;
      margin-bottom: 1.5rem;
    }

    #alertOk {
      min-width: 180px;
      font-size: 1.125rem;
    }

    .close {
      color: #666;
      float: right;
      font-size: 2rem;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }
    
    .close:hover {
      color: #000;
    }

 /* Search Results Table Styles */
.search-container {
  width: 88%;
  margin: 0 auto;
}

#resultsContainer {
  width: 100%;
  margin: 20px 0;
}

#searchResults {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

#searchResults th {
  background-color: #fbc318;
  color: white;
  padding: 12px;
  text-align: left;
  position: sticky;
  top: 0;
  z-index: 10;
}

#searchResults td {
  padding: 12px;
  border: 1px solid #ddd;
}

#searchResults tr:not(.header-row).highlighted-search {
  background-color: #333;
  color: white;
}

#searchResults tr:not(.header-row).highlighted-search button {
  background-color: white;
  color: #333;
}

#searchResults tr:not(.header-row):hover {
  background-color: #af1a1a;
  color: white;
}
/* Button Styles */
#searchResults button {
  background-color: #fbc318;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.2s;
}

#searchResults button:hover {
  background-color: #fff;
  color: #000;
}

/* Estilos para el Toggle Switch */
.drag-container {
  position: relative;
  cursor: grab;
  user-select: none;
}

.drag-container:active {
  cursor: grabbing;
}

/* Estilos para el estado activo */
.toggle-active .drag-container {
  background-color: #fbc318;
}

.toggle-active #toggleThumb {
  transform: translateX(100%);
}

/* Estilo para impedir la selecci√≥n accidental */
.disabled-toggle {
  opacity: 0.6;
  pointer-events: none;
}

/* Mensaje de advertencia para tipo FACTURA */
.factura-warning {
  color: #fbc318;
  font-weight: bold;
  animation: pulse 2s infinite;
  margin-top: 8px;
  text-align: center;
}

@keyframes pulse {
  0% { opacity: 0.7; }
  50% { opacity: 1; }
  100% { opacity: 0.7; }
}

/* --- Profit Button Modifications --- */
#profitButton {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background-color: #1e88e5;
  color: white;
  border: none;
  
  /* --- Asegurar forma circular perfecta --- */
  width: 60px;
  height: 60px;
  min-width: 60px;    /* Prevenir deformaci√≥n */
  min-height: 60px;   /* Prevenir deformaci√≥n */
  border-radius: 50%;
  
  /* --- Centrado de contenido --- */
  display: flex;
  justify-content: center;
  align-items: center;
  
  /* --- Tipograf√≠a y decoraci√≥n --- */
  font-size: 28px;
  font-weight: bold;
  text-align: center;
  line-height: 1;     /* Corregir alineaci√≥n vertical */
  
  /* --- Interacci√≥n --- */
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  
  /* --- Transici√≥n para ambos estados --- */
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  overflow: hidden;
}

/* --- Profit Button Modifications --- */
#profitButton {
  position: fixed;
  bottom: 20px;
  left: 20px;
  background-color: #1e88e5;
  color: white;
  border: none;
  
  /* --- Asegurar forma circular perfecta --- */
  width: 60px;
  height: 60px;
  min-width: 60px;    /* Prevenir deformaci√≥n */
  min-height: 60px;   /* Prevenir deformaci√≥n */
  border-radius: 50%;
  
  /* --- Centrado de contenido --- */
  display: flex;
  justify-content: center;
  align-items: center;
  
  /* --- Tipograf√≠a y decoraci√≥n --- */
  font-size: 28px;
  font-weight: bold;
  text-align: center;
  line-height: 1;     /* Corregir alineaci√≥n vertical */
  
  /* --- Interacci√≥n --- */
  cursor: pointer;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  
  /* --- Transici√≥n para ambos estados --- */
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  overflow: hidden;
}


/* 
  SOLUCI√ìN COMPLETA PARA EL BOT√ìN DE GANANCIA
  - Forma circular perfecta
  - Loader perfectamente centrado
  - Posici√≥n fija en la esquina inferior izquierda
  - Transici√≥n suave a forma de c√°psula
*/

/* Reset completo del bot√≥n para eliminar cualquier estilo heredado */
#profitButton {
  /* --- Posicionamiento fijo --- */
  position: fixed !important;
  bottom: 20px !important;
  left: 20px !important;
  z-index: 1000 !important;
  
  /* --- Dimensiones base --- */
  width: 60px !important;
  height: 60px !important;
  min-width: 60px !important;
  min-height: 60px !important;
  
  /* --- Apariencia --- */
  background-color: #1e88e5 !important;
  color: white !important;
  border: none !important;
  border-radius: 50% !important;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;
  
  /* --- Centrado del contenido --- */
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  padding: 0 !important;
  margin: 0 !important;
  
  /* --- Comportamiento --- */
  cursor: pointer !important;
  transition: width 0.4s ease, height 0.4s ease, border-radius 0.4s ease, 
              background-color 0.3s, transform 0.2s !important;
  overflow: hidden !important;
}

/* Estilo base para el texto */
#profitButton .profit-text {
  font-size: 28px !important;
  font-weight: bold !important;
  display: block !important;
  line-height: 1 !important;
  margin: 0 !important;
  padding: 0 !important;
}

#profitButton .button-loader {
  display: none;
  width: 24px;
  height: 24px;
  border: 3px solid rgba(255, 255, 255, 0.4);
  border-top-color: white;
  border-radius: 50%;
  
  /* Centralizaci√≥n del loader */
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  
  /* Aplicar la animaci√≥n */
  animation-name: spin;
  animation-duration: 0.8s;
  animation-timing-function: linear;
  animation-iteration-count: infinite;
}

/* Animaci√≥n separada para la rotaci√≥n */
@keyframes spin {
  from { 
    transform: translate(-50%, -50%) rotate(0deg);
  }
  to { 
    transform: translate(-50%, -50%) rotate(360deg);
  }
}

/* Estado hover para el bot√≥n normal */
#profitButton:hover:not(.loading):not(.showing-profit) {
  background-color: #1565c0 !important;
  transform: scale(1.05) !important;
}

/* Estado de carga: mantiene color azul y muestra loader */
#profitButton.loading {
  cursor: wait !important;
  /* Mantener mismo azul */
}

#profitButton.loading .profit-text {
  visibility: hidden !important; /* Oculta texto pero mantiene espacio */
}

#profitButton.loading .button-loader {
  display: block !important;
}

/* Estado modo c√°psula mostrando ganancia */
#profitButton.showing-profit {
  width: auto !important;
  min-width: 180px !important;
  height: 50px !important;
  border-radius: 25px !important;
  background-color: #4caf50 !important;
  padding: 0 20px !important;
}

#profitButton.showing-profit .profit-text {
  font-size: 1.1rem !important;
  white-space: nowrap !important;
}

#profitButton.showing-profit:hover {
  background-color: #388e3c !important;
  transform: scale(1.02) !important;
}


.action-cell {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0;   /* ya no necesitas height fija */
}

.action-cell button {
  margin-top: 7px;  /* empuja el bot√≥n hacia abajo */
}

/*
  NUEVOS ESTILOS
  - A√±ade cursor de "no permitido" para botones deshabilitados.
  - Ajusta el tama√±o de la fuente de los botones en el modal post-guardado.
*/

/* Cursor para botones deshabilitados */
button:disabled {
  cursor: not-allowed;
}

/* Ajustes de texto para los botones del modal de cobro final */
#postSaveContainer button {
  font-size: 0.9rem; /* Reduce el tama√±o de la fuente */
  padding: 0.75rem 1rem; /* Ajusta el padding para que el bot√≥n no sea tan grande */
  min-width: 160px; /* Ajusta el ancho m√≠nimo si es necesario */
  text-transform: none; /* Opcional: para que no todo sea may√∫sculas */
}

/* --- Contenedor de Botones: Ya no necesita margen autom√°tico --- */
.button-container {
  position: relative; /* Sigue siendo necesario para los botones absolutos internos */
  width: 100px;      /* Ancho fijo del bot√≥n */
  height: 40px;     /* Alto fijo del bot√≥n */
  margin: 0;         /* <<< Ya no necesita margen para centrarse, flex lo hace */
  display: block;    /* Opcional, pero asegura que se comporte como bloque */
}

/* --- Bot√≥n de eliminar: Mantenemos las correcciones anteriores --- */
.delete-button {
  position: absolute;
  top: 0;
  left: 0;
  width: 100px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: white; /* <<< Mantiene el fondo blanco para ocultar */
  color: #777;
  border: 1px solid #ddd;
  border-radius: 20px;
  cursor: pointer;
  font-size: 1.5rem;
  z-index: 10;
  transition: all 0.3s ease;
  min-width: unset;
  padding: 0; /* Reseteamos padding por si acaso */
  /* Ajusta el padding interno si es necesario para el √≠cono */
   padding: 0.5rem;
  text-transform: none;
  letter-spacing: normal;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  margin: 0; /* <<< Asegurar que no haya margen por defecto */
}

.delete-button:hover {
  background-color: #fbc318;
  color: white;
  border-color: #fbc318;
  transform: translateY(-2px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* --- Bot√≥n de Ganancia: Sin cambios necesarios aqu√≠ --- */
.item-profit-button {
  position: absolute;
  top: 0;
  left: 0;
  width: 100px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #1e88e5;
  color: white;
  border: none;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: bold;
  cursor: default;
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  z-index: 5;
  transition: opacity 0.3s ease, visibility 0.3s ease;
  min-width: unset;
  padding: 0; /* Reseteamos padding */
  /* Ajusta el padding interno */
   padding: 0.5rem;
  text-transform: none;
  letter-spacing: normal;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  margin: 0; /* <<< Asegurar que no haya margen por defecto */
}

/* Estados seg√∫n el modo (sin cambios) */
.profit-mode .delete-button {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
  z-index: 5;
}

.profit-mode .item-profit-button {
  opacity: 1;
  visibility: visible;
  pointer-events: auto;
  z-index: 20;
}



/* --- Location Guide Button Styling --- */
#locationGuideButton {
  position: fixed !important;
  bottom: 20px !important;
  /* Position it next to the profit button (profit is left: 20px, width: 60px) */
  left: 90px !important; /* 20px (profit left) + 60px (profit width) + 10px (spacing) */
  z-index: 999 !important; /* Slightly lower than profit button if needed */

  /* --- Dimensions & Shape --- */
  width: 60px !important;
  height: 60px !important;
  min-width: 60px !important;
  min-height: 60px !important;
  border-radius: 50% !important;

  /* --- Appearance --- */
  background-color: #607d8b !important; /* Bluish-grey */
  color: white !important;
  border: none !important;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3) !important;

  /* --- Content Alignment --- */
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  padding: 0 !important;
  margin: 0 !important;

  /* --- Interaction --- */
  cursor: pointer !important;
  transition: background-color 0.3s, transform 0.2s !important;
  overflow: hidden !important;
}

#locationGuideButton .location-guide-icon {
  font-size: 28px !important; /* Adjust emoji size if needed */
  line-height: 1 !important;
}

#locationGuideButton:hover {
  background-color: #455a64 !important;
  transform: scale(1.05) !important;
}

/* --- Location Modal Button Styling --- */
#locationModal .store-button {
  color: white;
  border: none;
  padding: 1rem 1.5rem; /* Generous padding */
  border-radius: 0.75rem;
  cursor: pointer;
  font-size: 1rem; /* Slightly smaller font */
  font-weight: 600;
  transition: all 0.3s;
  text-transform: uppercase;
  letter-spacing: 0.025em;
  min-width: auto; /* Override default button min-width */
  width: 100%; /* Make buttons fill grid cells */
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#locationModal .store-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
}

/* Optional: Add specific hover colors if desired */
#locationModal .store-button.bg-blue-500:hover { background-color: #3b82f6; }
#locationModal .store-button.bg-green-500:hover { background-color: #10b981; }
#locationModal .store-button.bg-orange-500:hover { background-color: #f97316; }
#locationModal .store-button.bg-purple-500:hover { background-color: #a855f7; }

/* --- AI Chat Modal Specific Styles --- */
#aiChatModalContent {
  /* Adjust width and height */
  width: 75vw; /* 3/4 of viewport width */
  max-width: 900px; /* Max width if 75vw is too large */
  height: 80vh; /* 80% of viewport height */
  max-height: 700px; /* Max height */

  /* Use flexbox for layout */
  display: flex;
  flex-direction: column;
  padding: 1.5rem; /* Slightly less padding */
}

#chatbox {
  flex-grow: 1; /* Allows chatbox to fill available space */
  overflow-y: auto; /* Enable vertical scrolling */
  border: 1px solid #e2e8f0;
  border-radius: 0.5rem;
  padding: 1rem;
  background-color: #f8fafc; /* Light background for chat area */
  display: flex; /* Helps with scrolling */
  flex-direction: column; /* Stack messages vertically */
}
/* Estilo para mensajes del chat */
.chat-message {
  margin: 8px 0;
  padding: 10px 15px;
  border-radius: 15px;
  max-width: 80%;
  word-wrap: break-word;
}

/* Mensaje del usuario alineado a la derecha */
.user-message {
  background-color: #e1f5fe;
  color: #0277bd;
  align-self: flex-end;
  margin-left: auto;
  margin-right: 10px;
  text-align: right;
}

/* Mensaje de la IA alineado a la izquierda */
.ai-message {
  background-color: #dedede;
  color: #333333;
  align-self: flex-start;
  margin-right: auto;
  margin-left: 10px;
  text-align: left;
}

/* Convertir enlaces en botones tipo c√°psula */
.url-button {
  display: inline-block;
  padding: 6px 12px;
  margin: 4px 2px;
  background-color: #4CAF50;
  color: white !important; /* Forzar color blanco */
  text-decoration: none;
  border-radius: 20px; /* Forma de c√°psula */
  font-size: 0.9em;
  font-weight: 500;
  transition: background-color 0.3s, transform 0.2s;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  border: none;
  text-align: center;
}

.url-button:hover {
  background-color: #45a049;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* Input area adjustments */
#aiChatModalContent input[type="text"] {
    font-size: 1rem; /* Reset font size for chat input */
    margin: 0; /* Remove default margins */
}
#aiChatModalContent #sendButton {
    font-size: 1rem; /* Reset font size */
    padding: 0.75rem 1.25rem; /* Adjust padding */
}

/* Estilos para el bot√≥n de Promo Madre */
.promo-madre-button {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #888888;
  color: white;
  border: none;
  border-radius: 30px;
  padding: 12px 20px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  z-index: 999;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}

.promo-madre-button:hover {
  transform: translateX(-50%) translateY(-3px);
  box-shadow: 0 6px 8px rgba(0, 0, 0, 0.25);
}

.promo-madre-button.active {
  background-color: #ff1493; /* Color rosa para estado activo */
}

/* Estilos para el cambio de fondo con Promo Madre */
body {
  transition: background-color 0.5s ease;
}

body.promo-madre-active {
  background-color: #ffe6f2; /* Rosa pastel suave */
}

/* Ajustar otros elementos para que combinen con el nuevo fondo */
body.promo-madre-active .client-display,
body.promo-madre-active #totalContainer {
  background-color: rgba(255, 255, 255, 0.7);
}
  </style>
  </head>
<body class="bg-white min-h-screen">
  <div id="mainView">
    <div id="totalContainer" class="shadow-lg">
      <span id="totalGeneral">$0.00</span>
    </div>
    <div id="currentClientDisplay" class="client-display">
  <span class="client-label">Cliente actual:</span>
  <span id="currentClientName"></span>
</div>

<h1 class="text-4xl font-bold mb-8">FERRESOLUCIONES</h1>

<div class="search-container">
  <label for="productCode" class="text-lg font-medium">C√≥digo o Nombre del Producto:</label>
  <input type="text" id="productCode" class="focus:ring-2 focus:ring-primary focus:border-primary w-full" />
  
  <div id="info-message" class="text-gray-500 italic mt-4">Ingrese alg√∫n c√≥digo o nombre de producto</div>

  <div id="resultsContainer" class="hidden mt-8">
    <h3 class="text-2xl font-semibold mb-4">Resultados de b√∫squeda</h3>
    <table id="searchResults" class="w-full">
      <tr class="bg-primary text-white">
        <th class="text-left">Nombre</th>
        <th class="text-left">Precio</th>
        <th class="text-center">Acci√≥n</th>
      </tr>
    </table>
  </div>
</div>
  
<div id="cart-container" class="cart-container">
  <h2 class="text-2xl font-semibold mb-4">Carrito</h2>
  <table id="cart" class="w-full">
    <tr class="bg-primary text-white">
      <th>Stock Restante</th>
      <th>C√≥digo</th>
      <th>Nombre</th>
      <th>Precio</th>
      <th>Cantidad</th>
      <th>Total</th>
      <th>Acci√≥n</th>
    </tr>
  </table>
</div>

<button id="editModeButton" class="edit-mode-button">Modo Edici√≥n Activado</button>

    <!-- Bot√≥n flotante para promo madre -->
<button id="promoMadreButton" class="promo-madre-button" style="visibility: hidden;">
  Aplicar Promo Madre
</button>

<!-- Di√°logos -->
<div id="dialog" class="bg-white rounded-lg shadow-xl">
  <p class="mb-6 text-xl">¬øEst√°s seguro de guardar la venta y cobrar?</p>
  <div class="flex gap-4 justify-center">
    <button id="cobrarButton" class="bg-primary hover:bg-primary/90">Cobrar</button>
    <button id="cancelButton" class="bg-gray-500 hover:bg-gray-600">Cancelar</button>
  </div>
</div>

<div id="quantityDialog" class="bg-white rounded-lg shadow-xl">
  <p id="quantityDialogMessage" class="mb-4 text-lg"></p>
  <input type="number" id="quantityInput" min="0.01" step="0.01" class="w-full mb-6 p-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" />
  <div class="flex gap-4 justify-center">
    <button id="quantityOkButton" onclick="acceptQuantity()" class="bg-primary hover:bg-primary/90">Aceptar</button>
    <button id="quantityCancelButton" onclick="hideQuantityDialog()" class="bg-gray-500 hover:bg-gray-600">Cancelar</button>
  </div>
</div>



<!-- Estructura HTML simplificada que debe usarse -->
<button id="profitButton">
  <span class="profit-text">G</span>
  <span class="button-loader"></span>
</button>

<button id="locationGuideButton" title="Gu√≠a de Ubicaciones">
  <span class="location-guide-icon">üñ®Ô∏è</span> <!-- Printer Emoji -->
</button>


<div id="customAlert" class="modal">
  <div class="modal-content max-w-md mx-auto text-center">
    <p id="alertMessage" class="mb-6"></p>
    <button id="alertOk" class="bg-primary hover:bg-primary/90">Aceptar</button>
  </div>
</div>

<div id="paymentModal" class="modal">
    <div class="modal-content">
        <h2 class="text-2xl font-bold mb-6 text-center">Proceso de Cobro</h2>
        <div class="space-y-6">
            <p class="text-xl text-center">Total a pagar: <span id="modalTotalAmount" class="font-bold"></span></p>

            <div id="documentTypeContainer">
                <label class="text-lg font-medium block mb-2 text-center">Tipo de documento:</label>
                <div class="flex items-center justify-center space-x-4">
                    <span class="font-medium text-gray-600">RECIBO</span>
                    <div class="relative">
                        <div id="dragContainer" class="drag-container w-14 h-7 bg-gray-200 rounded-full p-1 cursor-grab transition-colors duration-300">
                            <div id="toggleThumb" class="absolute w-5 h-5 bg-white rounded-full shadow-md transform duration-300 ease-in-out" style="left: 4px; top: 4px;"></div>
                        </div>
                    </div>
                    <span class="font-medium text-gray-600">FACTURA</span>
                </div>
                <input type="hidden" id="tipoDocumento" value="RECIBO">
                <p id="switchInstruction" class="text-gray-500 text-sm mt-2 text-center">Desliza para cambiar</p>
            </div>

            <input type="number" id="amountPaid" placeholder="Monto pagado" class="w-full p-3 text-xl border-2 border-gray-300 rounded-lg text-center focus:border-primary focus:ring-2 focus:ring-primary/20" />
            <p class="text-2xl text-center">Cambio: <span id="changeAmount" class="font-bold">$0.00</span></p>

            <div class="border-t pt-4">
                <div id="initialButtons" class="flex gap-4 justify-center">
                    <button id="confirmPayment" class="bg-primary hover:bg-primary/90">Guardar</button>
                    <button id="cancelPayment" class="bg-gray-500 hover:bg-gray-600">Cancelar</button>
                </div>

                <div id="postSaveContainer" class="text-center" style="display: none;">
                    <div id="backgroundProgress" class="flex items-center justify-center gap-4 mb-4">
                        <div class="loader w-8 h-8 border-4"></div>
                        <p id="progressMessage" class="text-lg font-medium">Procesando...</p>
                    </div>
                    <div class="flex gap-4 justify-center">
                        <button id="reprintButton" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Reimprimir Comprobante</button>
                        <button id="closeModal" onclick="hidePaymentModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg" disabled>Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="clientDialog" class="modal">
  <div class="modal-content">
    <span class="close" onclick="hideClientDialog()">&times;</span>
    
    <div id="clientSearchDialog">
      <h2 class="text-2xl font-bold mb-6">Buscar Cliente</h2>
      <input type="text" id="clientSearchInput" placeholder="Buscar por c√©dula o nombre" class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg mb-6 focus:border-primary focus:ring-2 focus:ring-primary/20" />
      <table id="clientSearchResults" class="w-full"></table>
    </div>


<!-- Modificaci√≥n para el formulario de registro de cliente -->
<div id="registerClientDialog" class="hidden">
  <h2 class="text-2xl font-bold mb-6">Registrar Nuevo Cliente</h2>
  <div class="space-y-4">
    <input type="text" id="newClientCedula" placeholder="C√©dula" readonly class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" />
    <input type="text" id="newClientRazonSocial" placeholder="Raz√≥n Social" class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" />
    <input type="text" id="newClientDireccion" placeholder="Direcci√≥n" class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" />
    <input type="text" id="newClientTelefono" placeholder="Tel√©fono" class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" />
    <div class="flex items-center space-x-2">
      <input type="email" id="newClientCorreo" placeholder="Correo Electr√≥nico*" class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" required />
      <button id="newClientNoCorreo" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded-lg text-sm whitespace-nowrap">No tiene correo</button>
    </div>
    <p class="text-sm text-red-500">* Campo obligatorio</p>
  </div>
  <div class="mt-8 flex gap-4 justify-center">
    <button id="saveNewClientButton" class="hidden bg-primary hover:bg-primary/90">Guardar Cliente</button>
    <button id="cancelRegisterButton" onclick="hideRegisterDialog()" class="bg-gray-500 hover:bg-gray-600">Cancelar</button>
  </div>
</div>
<!-- Modificaci√≥n para el formulario de edici√≥n de cliente -->
<div id="editClientDialog" class="hidden">
  <h2 class="text-2xl font-bold mb-6">Editar Cliente</h2>
  <div class="space-y-4">
    <input type="text" id="editClientCedula" readonly class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" />
    <input type="text" id="editClientRazonSocial" class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" />
    <input type="text" id="editClientDireccion" class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" />
    <input type="text" id="editClientTelefono" class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" />
    <div class="flex items-center space-x-2">
      <input type="email" id="editClientCorreo" placeholder="Correo Electr√≥nico*" class="w-full p-4 text-lg border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-2 focus:ring-primary/20" required />
      <button id="editClientNoCorreo" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded-lg text-sm whitespace-nowrap">No tiene correo</button>
    </div>
    <p class="text-sm text-red-500">* Campo obligatorio</p>
  </div>
  <div class="mt-8 flex gap-4 justify-center">
    <button id="saveEditClientButton" class="bg-primary hover:bg-primary/90">Guardar Cambios</button>
    <button id="changeClientButton" class="bg-blue-600 hover:bg-blue-700">Cambiar Cliente</button>
  </div>
</div>
</div>
</div>

<!-- AI Chat Modal -->
<div id="aiChatModal" class="modal">
    <div id="aiChatModalContent" class="modal-content"> <!-- Unique ID for specific styling -->
        <span class="close" onclick="closeAiChatModal()">√ó</span>
        <h2 class="text-2xl font-bold mb-4 text-center">
           ManaBot <span class="text-sm font-normal text-gray-500">- Asistente IA</span>
        </h2>

        <!-- Chat Display Area -->
        <div id="chatbox" class="chatbox-container mb-4">
            <!-- Chat messages will be appended here -->
            <div class="ai-message">¬°Hola! Soy ManaBot, tu asistente virtual de FERRESOLUCIONES. ¬øEn qu√© puedo ayudarte hoy?</div>
        </div>

        <!-- Thinking Indicator -->
        <div id="thinkingIndicator" class="text-center text-gray-500 italic py-2" style="display: none;">
            ManaBot est√° pensando...
        </div>

        <!-- Input Area -->
        <div class="flex gap-2 items-center">
            <input type="text" id="userInput" placeholder="Escribe tu mensaje aqu√≠..." class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:border-primary focus:ring-primary/20 text-base" style="margin: 0;">
            <button id="sendButton" class="bg-primary hover:bg-primary/90 px-5 py-3 rounded-lg" style="min-width: auto;">
                Enviar
            </button>
        </div>
    </div>
</div>


<!-- Find this modal -->
<div id="locationModal" class="modal">
  <div class="modal-content" style="max-width: 450px;">
    <span class="close" onclick="closeLocationModal()">√ó</span>
    <h2 class="text-2xl font-bold mb-6 text-center">Gu√≠a de Ubicaciones</h2>

    <!-- Existing Section: Location Buttons -->
    <div id="locationOptionsContainer" class="grid grid-cols-2 gap-4">
       <button class="store-button bg-blue-500 hover:bg-blue-600" data-ferreteria="caracol">EL CARACOL</button>
       <button class="store-button bg-green-500 hover:bg-green-600" data-ferreteria="amperio">EL AMPERIO</button>
       <button class="store-button bg-orange-500 hover:bg-orange-600" data-ferreteria="disensa">DISENSA (ESCOBAR)</button>
       <button class="store-button bg-purple-500 hover:bg-purple-600" data-ferreteria="punto">EL PUNTO</button>
    </div>

    <!-- **** ADD THIS NEW SECTION **** -->
    <hr class="my-6 border-gray-300"> <!-- Visual Separator -->

    <div id="createListSection" class="text-center">
        <h3 class="text-xl font-semibold mb-4">Listado de Productos</h3>
                <button
            id="createListButton"
            class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg w-full transition duration-300 ease-in-out transform hover:scale-105"
            onclick="window.open('https://pos.manasakilla.com/crearlistado.html', '_blank'); closeLocationModal();"
            style="min-width: auto;">
            Crear Lista de Productos
        </button>
    </div>

     <div id="createListSection" class="text-center">
        <h3 class="text-xl font-semibold mb-4">Telefonos para brindar asistencia</h3>
                <button
            id="createList"
            class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg w-full transition duration-300 ease-in-out transform hover:scale-105"
            onclick="window.open('https://pos.manasakilla.com/ASISTENCIA.html', '_blank'); closeLocationModal();"
            style="min-width: auto;">
            Imprimir ticket de asistencia
        </button>
    </div>
    <!-- **** END OF NEW SECTION **** -->

  </div>
</div>


<div id="helpDialog" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeHelpDialog()">&times;</span>
    <h3 class="text-2xl font-bold mb-6">Ayuda</h3>
    <div class="space-y-4 text-gray-700">
      <p><strong>F1:</strong> Cobrar venta, solo hazlo si se vendi√≥ el producto.</p>
      <p><strong>F2:</strong> Modo edici√≥n, activa esto cuando quieras dar un precio especial o modificar cantidades.</p>
      <p><strong>F3:</strong> Seleccionar, cambiar o registrar un cliente, √∫salo para hacer facturas o recibos con datos.</p>
      <p><strong>F4:</strong> Para imprimir un <strong>RECIBO</strong>.</p>
      <p><strong>F5:</strong> Para imprimir una <strong>FACTURA</strong>.</p>
      <p><strong>F10:</strong> Para <strong>LIMPIAR</strong> el carrito, esto borra todos los productos y el cliente seleccionado.</p>
      <p><strong>SHIFT(‚áß):</strong> Para ingresar un producto con c√≥digo y cantidad directa. <em>(Se necesita el c√≥digo del producto)</em></p>
      <p><strong>Tab(‚áÑ):</strong> Para activar el buscador.</p>
      <p><strong>Control:</strong> Ayuda</p>
      <p><strong>Escape:</strong> Para cerrar algunas ventanas.</p>
    </div>
  </div>
</div>
</div>
<!--modal inicial-->
<div id="initialCashModal" class="modal" style="display: none; background: rgba(0,0,0,0.8); z-index: 9999;">
  <div class="modal-content" style="position: relative;">
    <h2 class="text-2xl font-bold mb-6">Registro de Caja Inicial</h2>
    <p class="mb-4">Caja del d√≠a anterior: <span id="yesterdayCash" class="font-bold"></span></p>
    <input type="number" id="initialCashAmount" placeholder="Ingrese el valor de la caja f√≠sica" class="w-full p-4 text-xl border-2 border-gray-300 rounded-lg mb-6 focus:border-primary focus:ring-2 focus:ring-primary/20" step="0.01" />
    <div id="verificationCodeContainer" class="hidden">
      <p class="text-red-600 mb-2">El valor ingresado es menor al de ayer. Se ha enviado un c√≥digo de verificaci√≥n al correo.</p>
      <input type="text" id="verificationCode" placeholder="Ingrese el c√≥digo de verificaci√≥n" class="w-full p-4 text-xl border-2 border-gray-300 rounded-lg mb-6 focus:border-primary focus:ring-2 focus:ring-primary/20" />
    </div>
    <button id="saveInitialCash" class="bg-primary hover:bg-primary/90 w-full">Guardar</button>
  </div>
</div>

<!-- Screen Blocker with Spinner -->
<div id="screenBlocker">
  <div class="blocker-content">
    <div class="loader"></div>
    <p id="blockerMessage">Cargando...</p>
  </div>
</div>

<div id="cuentasPorCobrarModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="hideCuentasPorCobrarModal()">&times;</span>
    <h2 class="text-2xl font-bold mb-6">Enviar a Cuentas por Cobrar</h2>
    
    <div class="mb-4">
      <p class="text-xl mb-2">Total: <span id="cpcTotalAmount" class="font-bold"></span></p>
      <p class="text-xl mb-4">ID Venta: <span id="cpcVentaId" class="font-bold"></span></p>
    </div>
    
    <div class="mb-4">
      <label for="cpcDeudor" class="block text-sm font-medium text-gray-700 mb-1">Deudor</label>
      <input list="deudoresList" type="text" id="cpcDeudor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" placeholder="Nombre del deudor">
      <datalist id="deudoresList"></datalist>
    </div>
    
    <div class="mb-4">
      <label for="cpcMotivo" class="block text-sm font-medium text-gray-700 mb-1">Motivo/Descripci√≥n</label>
      <input type="text" id="cpcMotivo" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" placeholder="Motivo de la cuenta por cobrar">
    </div>
    
    <div class="mb-4">
      <label for="cpcOtros" class="block text-sm font-medium text-gray-700 mb-1">Otros Detalles (opcional)</label>
      <textarea id="cpcOtros" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary" placeholder="Detalles adicionales"></textarea>
    </div>
    
    <div class="flex flex-wrap gap-4 justify-center mt-6">
      <button id="cpcGuardarBtn" onclick="guardarCuentaPorCobrar()" class="bg-primary text-white px-6 py-2 rounded hover:bg-opacity-90">
        Guardar CxC
      </button>
      <button id="cpcImprimirBtn" onclick="imprimirReciboCxC()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-opacity-90">
        Imprimir Recibo
      </button>
      <button onclick="hideCuentasPorCobrarModal()" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-opacity-90">
        Cancelar
      </button>
    </div>
  </div>
</div>


<script>
  let lastUpdateTimestamp = 0;
  

  var lastSaleData = {
  docNumber: null,
  claveAcceso: null,
  tipoDocumento: null,
  productos: [],
  cliente: null,
  total: 0
};


  let allSales = [];
    var products = [];
    var currentProduct;
    var currentSaleCode = null;
    var isEditing = false;
    var lastActiveElement = null;
    var isFirstLoad = true;

function updateInventoryPeriodically() {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.timestamp > lastUpdateTimestamp) {
        products = result.products;
        lastUpdateTimestamp = result.timestamp;
        updateProductDisplay();  // Actualiza la UI si es necesario
      }
    })
    .getAllProducts();
}

  let isProfitDisplayVisible = false;
   let isProfitShowing = false;

// Iniciar la actualizaci√≥n peri√≥dica
setInterval(updateInventoryPeriodically, 10000);  // 10000 ms = 10 segundos

function updateCellTotal(cell) {
  var row = cell.parentElement;
  var newPrice = parseFloat(row.cells[3].innerText.replace('$', '').replace(',', ''));
  var newQuantity = parseFloat(row.cells[4].innerText);
  var productCode = row.cells[1].innerText;
  var product = products.find(p => p.code == productCode);

  if (cell.cellIndex === 3) { // Si estamos editando el precio
    newPrice = parseFloat(cell.innerText.replace('$', '').replace(',', ''));
  } else if (cell.cellIndex === 4) { // Si estamos editando la cantidad
    var stockOriginal = product.stock; // Stock original del producto

    // Calcular el nuevo stock restante si se aplica el cambio
    var newRemainingStock = stockOriginal - newQuantity;

    if (newRemainingStock < 0) {
      showCustomAlert(`Stock insuficiente. Solo quedan ${stockOriginal} en inventario.`);
      cell.innerHTML = `<strong>${cell.getAttribute('data-old-value')}</strong>`; // Revertir al valor anterior
      cell.blur();
      return;
    } else if (newQuantity < 0) {
      showCustomAlert('La cantidad no puede ser negativa.');
      cell.innerHTML = `<strong>${cell.getAttribute('data-old-value')}</strong>`; // Revertir al valor anterior
      cell.blur();
      return;
    }

    // Actualizar el stock restante en la fila
    row.cells[0].innerHTML = `<strong>${newRemainingStock.toFixed(2)}</strong>`;
  }

  // Actualizar el total de la fila
  row.cells[5].innerHTML = `<strong>${formatCurrency(newPrice * newQuantity)}</strong>`;
  
  // Actualizar el color de fondo si es necesario
  if (parseFloat(row.cells[0].innerText) <= product.minStock) {
    row.classList.add("low-stock");
  } else {
    row.classList.remove("low-stock");
  }
  
  // Guardar el nuevo valor como el valor antiguo para la pr√≥xima edici√≥n
  cell.setAttribute('data-old-value', cell.innerText);
  
  updateTotal();
  saveCartToLocalStorage();
  cell.blur();
}


function showCustomAlert(message, focusOnProductCode = false) {
  return new Promise((resolve) => {
    var alertDiv = document.createElement('div');
    alertDiv.id = 'customAlert';
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '0';
    alertDiv.style.left = '0';
    alertDiv.style.width = '100%';
    alertDiv.style.height = '100%';
    alertDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
    alertDiv.style.display = 'flex';
    alertDiv.style.justifyContent = 'center';
    alertDiv.style.alignItems = 'center';
    alertDiv.style.zIndex = '10000';
    
    var alertContent = document.createElement('div');
    alertContent.style.backgroundColor = 'white';
    alertContent.style.padding = '20px';
    alertContent.style.borderRadius = '5px';
    alertContent.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
    alertContent.style.maxWidth = '300px';
    alertContent.style.width = 'auto';
    alertContent.style.textAlign = 'center';
    
    var alertMessage = document.createElement('p');
    alertMessage.textContent = message;
    alertMessage.style.margin = '0 0 15px 0';
    alertContent.appendChild(alertMessage);
    
    var alertButton = document.createElement('button');
    alertButton.textContent = 'OK';
    alertButton.style.padding = '5px 15px';
    alertButton.style.cursor = 'pointer';
    alertContent.appendChild(alertButton);
    
    alertDiv.appendChild(alertContent);
    document.body.appendChild(alertDiv);
    
    function closeAlert() {
      document.body.removeChild(alertDiv);
      if (focusOnProductCode) {
        document.getElementById("productCode").focus();
      }
      resolve();
    }

    alertButton.onclick = closeAlert;
    
    alertButton.focus();

    function handleKeydown(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        closeAlert();
      }
    }

    alertDiv.addEventListener('keydown', handleKeydown);
  });
}

function hideCustomAlert() {
  var alertDiv = document.getElementById('customAlert');
  if (alertDiv) {
    document.body.removeChild(alertDiv);
  }
}

function hideDialog() {
  document.getElementById("dialog").style.display = 'none';
  document.removeEventListener("keydown", handleDialogKeydown);
  document.getElementById('productCode').focus();
}

function hideQuantityDialog() {
  document.getElementById("quantityDialog").style.display = 'none';
  document.removeEventListener("keydown", handleQuantityDialogKeydown);
  document.getElementById('productCode').focus();
}

// Funci√≥n para formatear n√∫meros como moneda
function formatCurrency(value) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD'
  }).format(value);
}




function clearCart() {
  var cart = document.getElementById("cart");
  while (cart.rows.length > 1) {
    cart.deleteRow(1);
  }
  updateTotal();
  toggleCartVisibility();
  localStorage.removeItem('cartData');
  currentSaleCode = null;
  localStorage.removeItem('currentSaleCode');
  
  // Resetear los precios originales
  originalPrices = {};
  
  // Desactivar Promo Madre si est√° activa
  if (promoMadreActive) {
    const button = document.getElementById('promoMadreButton');
    if (button) {
      button.classList.remove('active');
      button.textContent = 'Aplicar Promo Madre';
    }
    document.body.classList.remove('promo-madre-active');
    promoMadreActive = false;
    localStorage.setItem('promoMadreActive', 'false');
  }
  
  // Resetear el cliente a los valores por defecto
  resetClientToDefault();
  
  // Actualizar la visualizaci√≥n del cliente actual
  updateCurrentClientDisplay();
  
  // Enfocar el campo de b√∫squeda
  document.getElementById("productCode").focus();
}

function saveCartToLocalStorage() {
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  var cartData = [];

  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    var ofertaBtn = cells[2].querySelector('.oferta-btn');
    cartData.push({
      stockRestante: cells[0].innerText,
      code: cells[1].innerText,
      name: cells[2].innerText,
      price: cells[3].innerText,
      quantity: cells[4].innerText,
      total: cells[5].innerText,
      backgroundColor: rows[i].style.backgroundColor,
      oferta: ofertaBtn ? {
        precioNormal: ofertaBtn.getAttribute('data-precio-normal'),
        precioOferta: ofertaBtn.getAttribute('data-precio-oferta'),
        estado: ofertaBtn.textContent.startsWith('E:') ? 'normal' : 'oferta'
      } : null
    });
  }

  localStorage.setItem('cartData', JSON.stringify(cartData));
  localStorage.setItem('currentSaleCode', currentSaleCode || generateSaleCode());
}

function loadCartFromLocalStorage() {
   var cartData = localStorage.getItem('cartData');
  if (cartData) {
    cartData = JSON.parse(cartData);
    var cart = document.getElementById("cart");

    // Limpiar el carrito existente
    while (cart.rows.length > 1) {
      cart.deleteRow(1);
    }

    // A√±adir los productos guardados al carrito
    cartData.forEach(function(item) {
      var newRow = cart.insertRow();
      newRow.insertCell(0).innerHTML = `<strong>${item.stockRestante}</strong>`;
      newRow.insertCell(1).innerHTML = `<strong>${item.code}</strong>`;
      newRow.insertCell(2).innerHTML = `<strong>${item.name}</strong>`;
      newRow.insertCell(3).innerHTML = `<strong>${item.price}</strong>`;
      newRow.insertCell(4).innerHTML = `<strong>${item.quantity}</strong>`;
      newRow.insertCell(5).innerHTML = `<strong>${item.total}</strong>`;
      
var actionCell = newRow.insertCell(6);
actionCell.className = 'action-cell'; // Agregar clase para posicionamiento

// Contenedor para mantener la posici√≥n relativa (¬°Esto es importante!)
var buttonContainer = document.createElement('div');
buttonContainer.style.position = 'relative';
buttonContainer.style.width = '100px';
buttonContainer.style.margin = '0 auto';

// Bot√≥n de eliminar
var deleteButton = document.createElement("button");
deleteButton.innerHTML = 'üóëÔ∏è';
deleteButton.classList.add("delete-button");
deleteButton.onclick = function() {
  deleteRow(deleteButton);
};
buttonContainer.appendChild(deleteButton);

// Bot√≥n de ganancia (inicialmente oculto)
var profitButton = document.createElement('button');
profitButton.className = 'item-profit-button';
profitButton.dataset.productCode = item.code;
profitButton.innerHTML = 'G: $0.00'; // Valor inicial
buttonContainer.appendChild(profitButton);

actionCell.appendChild(buttonContainer);

    if (item.oferta) {
      var ofertaBtn = document.createElement('button');
      ofertaBtn.className = 'oferta-btn';
      ofertaBtn.setAttribute('data-precio-normal', item.oferta.precioNormal);
      ofertaBtn.setAttribute('data-precio-oferta', item.oferta.precioOferta);
      ofertaBtn.innerHTML = item.oferta.estado === 'normal' ? 
        `<strong>E: ${formatCurrency(parseFloat(item.oferta.precioOferta))}</strong>` : 
        `<strong>N: ${formatCurrency(parseFloat(item.oferta.precioNormal))}</strong>`;
      ofertaBtn.style.backgroundColor = item.oferta.estado === 'normal' ? '#0000FF' : '#00FF00';
      ofertaBtn.style.color = 'white';
      ofertaBtn.style.marginLeft = '5px';
      ofertaBtn.style.padding = '5px 10px';
      ofertaBtn.style.border = 'none';
      ofertaBtn.style.borderRadius = '3px';
      ofertaBtn.style.cursor = 'pointer';
      ofertaBtn.onclick = function() { toggleOferta(this, newRow.cells[3]); };
      actionCell.appendChild(ofertaBtn);
    }

      // Restaurar el color de fondo basado en el stock restante
      var product = products.find(p => p.code == item.code);
      if (product && parseFloat(item.stockRestante) <= product.minStock) {
        newRow.classList.add("low-stock");
      }
    });

      updateTotal();
    toggleCartVisibility();

    // Cargar el c√≥digo de venta
    currentSaleCode = localStorage.getItem('currentSaleCode');
    if (!currentSaleCode) {
      currentSaleCode = generateSaleCode();
      localStorage.setItem('currentSaleCode', currentSaleCode);
    }
    
    // Aplicar promo madre si estaba activa
if (localStorage.getItem('promoMadreActive') === 'true') {
  setTimeout(function() {
    const button = document.getElementById('promoMadreButton');
    if (button && !button.classList.contains('active')) {
      button.classList.add('active');
      button.textContent = 'Quitar Promo Madre'; // Actualizar texto
      document.body.classList.add('promo-madre-active');
      promoMadreActive = true;
    }
  }, 500);
} else {
  // Asegurarse de que el texto sea correcto cuando est√° desactivado
  const button = document.getElementById('promoMadreButton');
  if (button) {
    button.textContent = 'Aplicar Promo Madre';
  }
}
  }
}

function deleteRow(button) {
  var row = button.parentElement.parentElement;
  row.remove();
  updateTotal();
  toggleCartVisibility();
  saveCartToLocalStorage();
}

function updateTotal() {
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  var total = 0;

  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    total += parseFloat(cells[5].innerText.replace('$', '').replace(',', ''));
  }

  document.getElementById("totalGeneral").innerText = formatCurrency(total);
}

function loadProducts(afterSale = false) {
  if (!afterSale && isFirstLoad) {
    showScreenBlocker('Cargando productos...');
  }
  google.script.run
    .withSuccessHandler(function(result) {
      console.log("Productos cargados:", result.products);
      products = result.products;
      lastUpdateTimestamp = result.timestamp;
      loadCartFromLocalStorage();
      if (!afterSale && isFirstLoad) {
        hideScreenBlocker();
        isFirstLoad = false;
      } else if (afterSale) {
        hideScreenBlocker();
      }
      updateProductDisplay();  // Aseg√∫rate de que esta funci√≥n exista para actualizar la UI
    })
    .withFailureHandler(function(error) {
      console.error("Error al cargar productos:", error);
      showCustomAlert("Error al cargar productos. Por favor, recarga la p√°gina.");
      if (isFirstLoad) {
        hideScreenBlocker();
      }
    })
    .getAllProducts();
}

function updateProductDisplay() {
  // Actualiza la visualizaci√≥n de productos en la UI
  // Por ejemplo, actualiza las cantidades en el carrito, la lista de productos, etc.
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');

  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    var productCode = cells[1].innerText;
    var product = products.find(p => p.code == productCode);
    if (product) {
      cells[0].innerHTML = `<strong>${product.stock}</strong>`;
      // Actualiza otros campos si es necesario
    }
  }

  // Si tienes una lista de productos visible, actual√≠zala aqu√≠
}

function clearSearchResults() {
  var resultsTable = document.getElementById("searchResults");
  while (resultsTable.rows.length > 0) {
    resultsTable.deleteRow(0);
  }
  document.getElementById("resultsContainer").style.display = 'none';
}

function searchProducts() {
  var query = document.getElementById("productCode").value;
  clearSearchResults();

  if (query === "") {
    return;
  }

  if (!query.match(/^\d+$/)) {
    var results = products.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));
    displaySearchResults(results);
    if (results.length > 0) {
      highlightSearchResult(0);
    }
  }
}

function highlightSearchResult(index) {
  var resultsTable = document.getElementById("searchResults");
  var rows = Array.from(resultsTable.getElementsByTagName('tr')).filter(row => !row.classList.contains('header-row'));
  
  rows.forEach(row => row.classList.remove("highlighted-search"));
  
  if (index >= 0 && index < rows.length) {
    rows[index].classList.add("highlighted-search");
    rows[index].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
  
  console.log('Highlighting index:', index, 'Actual highlighted row:', resultsTable.querySelector('.highlighted-search') ? rows.indexOf(resultsTable.querySelector('.highlighted-search')) : -1);
}

function getHighlightedSearchResult() {
  var resultsTable = document.getElementById("searchResults");
  var highlightedRow = resultsTable.querySelector('.highlighted-search');
  if (highlightedRow) {
    var cells = highlightedRow.getElementsByTagName('td');
    return {
      code: cells[0].textContent,
      name: cells[1].textContent,
      price: parseFloat(cells[2].textContent.replace('$', '').replace(',', '')),
      stock: parseFloat(cells[3].textContent)
    };
  }
  return null;
}

function searchProductByCode() {
  var query = document.getElementById("productCode").value;
  if (query.match(/^\d+$/)) {
    var productNormal = products.find(p => p.code == query);
    var productWithSuffix = products.find(p => p.code == query + "001");
    
    if (productNormal || productWithSuffix) {
      if (productNormal && productWithSuffix) {
        if (productNormal.stock > 0 || productWithSuffix.stock > 0) {
          showProductSelectionDialog(productNormal, productWithSuffix);
        } else {
          showCustomAlert(`Stock insuficiente para "${productNormal.name}" en ambas presentaciones`);
        }
      } else if (productWithSuffix) {
        if (productWithSuffix.stock > 0) {
          addProductToCart(productWithSuffix);
        } else {
          showCustomAlert(`Stock insuficiente para "${productWithSuffix.name}" (${productWithSuffix.unitType})`);
        }
      } else if (productNormal) {
        if (productNormal.stock > 0) {
          addProductToCart(productNormal);
        } else {
          showCustomAlert(`Stock insuficiente para "${productNormal.name}" (${productNormal.unitType})`);
        }
      }
    } else {
      showCustomAlert('Producto no encontrado');
    }
  }
}

function showProductSelectionDialog(productNormal, productWithSuffix) {
  var dialogOverlay = document.createElement('div');
  dialogOverlay.style.position = 'fixed';
  dialogOverlay.style.top = '0';
  dialogOverlay.style.left = '0';
  dialogOverlay.style.width = '100%';
  dialogOverlay.style.height = '100%';
  dialogOverlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
  dialogOverlay.style.display = 'flex';
  dialogOverlay.style.justifyContent = 'center';
  dialogOverlay.style.alignItems = 'center';
  dialogOverlay.style.zIndex = '1000';

  var dialogContent = document.createElement('div');
  dialogContent.style.backgroundColor = 'white';
  dialogContent.style.padding = '20px';
  dialogContent.style.borderRadius = '5px';
  dialogContent.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
  dialogContent.style.maxWidth = '400px';
  dialogContent.style.width = '100%';

  var contentHTML = `<h2 style="text-align: center; margin-bottom: 20px;">Seleccionar Producto</h2>`;

  if (productWithSuffix && productWithSuffix.stock > 0) {
    contentHTML += `
      <div style="margin-bottom: 20px;">
        <p><strong>${productWithSuffix.name}</strong> (Stock: ${productWithSuffix.stock}) - ${productWithSuffix.unitType}</p>
        <input type="number" id="quantitySuffix" min="1" max="${productWithSuffix.stock}" style="width: 100%; padding: 5px;">
      </div>
    `;
  }

  if (productNormal && productNormal.stock > 0) {
    contentHTML += `
      <div>
        <p><strong>${productNormal.name}</strong> (Stock: ${productNormal.stock}) - ${productNormal.unitType}</p>
        <input type="number" id="quantityNormal" min="1" max="${productNormal.stock}" style="width: 100%; padding: 5px;">
      </div>
    `;
  }

  if (productNormal && productWithSuffix && productNormal.stock > 0) {
    contentHTML += `
      <div style="margin-top: 20px;">
        <button id="convertButton" style="width: 100%; padding: 10px;">Convertir Paquete a Unidades</button>
      </div>
    `;
  }

  dialogContent.innerHTML = contentHTML;

  dialogOverlay.appendChild(dialogContent);
  document.body.appendChild(dialogOverlay);

  function handleEnter(event, product) {
    if (event.key === 'Enter') {
      var quantity = parseInt(event.target.value);
      if (quantity > 0 && quantity <= product.stock) {
        addProductToCart(product, quantity);
        document.body.removeChild(dialogOverlay);
        document.getElementById("productCode").focus();
      } else {
        showCustomAlert('Cantidad inv√°lida');
      }
    }
  }

  if (productWithSuffix && productWithSuffix.stock > 0) {
    document.getElementById('quantitySuffix').addEventListener('keydown', (e) => handleEnter(e, productWithSuffix));
    document.getElementById('quantitySuffix').focus();
  }

  if (productNormal && productNormal.stock > 0) {
    document.getElementById('quantityNormal').addEventListener('keydown', (e) => handleEnter(e, productNormal));
    if (!productWithSuffix || productWithSuffix.stock === 0) {
      document.getElementById('quantityNormal').focus();
    }
  }

  if (productNormal && productWithSuffix && productNormal.stock > 0) {
    document.getElementById('convertButton').addEventListener('click', () => {
      document.body.removeChild(dialogOverlay);
      showConversionDialog(productNormal, productWithSuffix);
    });
  }

  dialogOverlay.addEventListener('click', function(event) {
    if (event.target === dialogOverlay) {
      document.body.removeChild(dialogOverlay);
      document.getElementById("productCode").focus();
    }
  });
}

function showConversionDialog(productNormal, productWithSuffix) {
  var dialogOverlay = document.createElement('div');
  dialogOverlay.style.position = 'fixed';
  dialogOverlay.style.top = '0';
  dialogOverlay.style.left = '0';
  dialogOverlay.style.width = '100%';
  dialogOverlay.style.height = '100%';
  dialogOverlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
  dialogOverlay.style.display = 'flex';
  dialogOverlay.style.justifyContent = 'center';
  dialogOverlay.style.alignItems = 'center';
  dialogOverlay.style.zIndex = '1000';

  var dialogContent = document.createElement('div');
  dialogContent.style.backgroundColor = 'white';
  dialogContent.style.padding = '20px';
  dialogContent.style.borderRadius = '5px';
  dialogContent.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
  dialogContent.style.maxWidth = '400px';
  dialogContent.style.width = '100%';

  dialogContent.innerHTML = `
    <h2 style="text-align: center; margin-bottom: 20px;">Conversi√≥n de Paquete a Unidades</h2>
    <p><strong>${productNormal.name}</strong> (Stock de paquetes: ${productNormal.stock})</p>
    <p>Ingrese la cantidad de unidades por paquete:</p>
    <input type="number" id="unitsPerPackage" min="1" style="width: 100%; padding: 5px;">
    <p>Cantidad de paquetes a convertir:</p>
    <input type="number" id="packagesToConvert" min="1" max="${productNormal.stock}" style="width: 100%; padding: 5px;">
    <button id="confirmConversion" style="width: 100%; padding: 10px; margin-top: 10px;">Confirmar Conversi√≥n</button>
  `;

  dialogOverlay.appendChild(dialogContent);
  document.body.appendChild(dialogOverlay);

  document.getElementById('confirmConversion').addEventListener('click', function() {
    var unitsPerPackage = parseInt(document.getElementById('unitsPerPackage').value);
    var packagesToConvert = parseInt(document.getElementById('packagesToConvert').value);
    
    if (unitsPerPackage > 0 && packagesToConvert > 0 && packagesToConvert <= productNormal.stock) {
      document.body.removeChild(dialogOverlay);
      convertPackagesToUnits(productNormal, productWithSuffix, unitsPerPackage, packagesToConvert);
    } else {
      showCustomAlert('Por favor, ingrese valores v√°lidos');
    }
  });

  dialogOverlay.addEventListener('click', function(event) {
    if (event.target === dialogOverlay) {
      document.body.removeChild(dialogOverlay);
    }
  });

  document.getElementById('unitsPerPackage').focus();
}

function convertPackagesToUnits(productPackage, productUnit, unitsPerPackage, packagesToConvert) {
  if (!productUnit) {
    showCustomAlert('Error: No se puede realizar la conversi√≥n. No existe el producto en unidades.');
    return;
  }

  var totalUnits = unitsPerPackage * packagesToConvert;
  
  showScreenBlocker('Convirtiendo...');
  
  google.script.run
    .withSuccessHandler(function(result) {
      hideScreenBlocker();
      if (result.success) {
        showCustomAlert('Conversi√≥n exitosa. Se han a√±adido ' + totalUnits + ' unidades al stock.');
        
        // Actualizar los productos en memoria
        productPackage.stock -= packagesToConvert;
        productUnit.stock += totalUnits;
        // Actualizar la interfaz si es necesario
        updateProductDisplay();
      } else {
        showCustomAlert('Error en la conversi√≥n: ' + (result.message || 'Por favor, intente de nuevo.'));
      }
      // Cerrar la ventana de selecci√≥n de productos
      var selectionDialog = document.querySelector('div[style*="position: fixed"]');
      if (selectionDialog) {
        document.body.removeChild(selectionDialog);
      }
    })
    .withFailureHandler(function(error) {
      hideScreenBlocker();
      showCustomAlert('Error en la conversi√≥n: ' + error);
    })
    .convertPackagesToUnits(productPackage.code, unitsPerPackage, packagesToConvert);
}

// Funci√≥n auxiliar para actualizar la visualizaci√≥n de productos si es necesario
function updateProductDisplay() {
  // Implementa esta funci√≥n seg√∫n tus necesidades espec√≠ficas
  // Por ejemplo, podr√≠as actualizar una tabla de productos o refrescar la p√°gina
  console.log("Actualizando visualizaci√≥n de productos...");
  // Aqu√≠ puedes a√±adir l√≥gica para actualizar la interfaz de usuario
}

function showConfirmDialog(message, onConfirm) {
  // Primero removemos cualquier di√°logo existente
  var existingDialog = document.getElementById('confirmDialog1');
  if (existingDialog) {
    document.body.removeChild(existingDialog);
  }
  
  var dialogHTML = `
    <div id="confirmDialog1" style="display: block; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);">
      <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; text-align: center; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
        <p style="margin-bottom: 20px; font-size: 1.2rem;">${message}</p>
        <button id="confirmYes1" style="background-color: #4CAF50; color: white; padding: 10px 20px; margin: 10px; border: none; cursor: pointer; border-radius: 5px;">S√≠</button>
        <button id="confirmNo1" style="background-color: #f44336; color: white; padding: 10px 20px; margin: 10px; border: none; cursor: pointer; border-radius: 5px;">No</button>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', dialogHTML);
  
  function closeDialog() {
    var dialog = document.getElementById('confirmDialog1');
    if (dialog) {
      document.body.removeChild(dialog);
    }
    document.removeEventListener('keydown', handleKeyDown);
  }
  
  function handleKeyDown(event) {
    if (event.key === 'Enter') {
      closeDialog();
      onConfirm();
    } else if (event.key === 'Escape') {
      closeDialog();
    }
  }
  
  document.getElementById('confirmYes1').onclick = function() {
    closeDialog();
    onConfirm();
  };
  
  document.getElementById('confirmNo1').onclick = function() {
    closeDialog();
  };
  
  document.addEventListener('keydown', handleKeyDown);
  
  document.getElementById('confirmYes1').focus();
}


 function showConfirmaDialog(message, onConfirm) {
      var dialog = document.getElementById('confirmaDialog');
      var messageElement = document.getElementById('confirmMessage');
      var yesButton = document.getElementById('confirmYes');
      var noButton = document.getElementById('confirmNo');

      messageElement.textContent = message;
      dialog.style.display = 'block';

      function closeDialog() {
        dialog.style.display = 'none';
        yesButton.onclick = null;
        noButton.onclick = null;
      }

      yesButton.onclick = function() {
        closeDialog();
        onConfirm();
      };

      noButton.onclick = function() {
        closeDialog();
      };
    }



function getRemainingStock(code) {
  var product = products.find(p => p.code == code);
  var initialStock = product.stock;
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  var quantityInCart = 0;

  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    if (cells[1].innerText == code) {
      quantityInCart += parseFloat(cells[4].innerText);
    }
  }

  return initialStock - quantityInCart;
}

function displaySearchResults(results) {
  if (results.length > 0) {
    var resultsTable = document.getElementById("searchResults");
    resultsTable.innerHTML = ''; // Limpiar resultados anteriores
    
    var headerRow = resultsTable.insertRow();
    headerRow.classList.add('header-row');
    headerRow.innerHTML = "<th>C√≥digo</th><th>Nombre</th><th>Precio</th><th>Stock Restante</th><th>Zona</th><th>Acci√≥n</th>";
    
    results.forEach((product, index) => {
      var row = resultsTable.insertRow();
      var stockRestante = getRemainingStock(product.code);
      
      row.innerHTML = `
        <td>${product.code}</td>
        <td>${product.name}</td>
        <td>${formatCurrency(parseFloat(product.price))}</td>
        <td>${stockRestante}</td>
        <td>${product.zone || 'N/A'}</td>
        <td></td>
      `;
      
      var addButton = document.createElement("button");
      addButton.innerText = "A√±adir al carrito";
      addButton.onclick = function() {
        if (stockRestante > 0) {
          addProductToCart(product);
        } else {
          showCustomAlert(`Stock insuficiente. No quedan unidades en inventario.`);
        }
      };
      row.cells[5].appendChild(addButton);
      
      if (stockRestante <= product.minStock) {
        row.classList.add("low-stock");
      }
    });
    
    document.getElementById("resultsContainer").style.display = 'block';
    highlightSearchResult(0);  // Resaltar la primera fila de resultados (√≠ndice 0)
  }
}


function toggleCartVisibility() {
  var cart = document.getElementById("cart");
  var cartContainer = document.getElementById("cart-container");
  var infoMessage = document.getElementById("info-message");

  if (cart.rows.length > 1) {
    cartContainer.style.display = 'block';
    infoMessage.style.display = 'none';
  } else {
    cartContainer.style.display = 'none';
    infoMessage.style.display = 'block';
  }
}

function showDialog() {
  document.getElementById("dialog").style.display = 'block';
  document.addEventListener("keydown", handleDialogKeydown);
}

function hideDialog() {
  document.getElementById("dialog").style.display = 'none';
  document.getElementById("productCode").focus(); // Enfocar el campo de b√∫squeda
  document.removeEventListener("keydown", handleDialogKeydown);
}

function handleDialogKeydown(event) {
  if (event.key === 'Enter') {
    cobrar();
  } else if (event.key === 'Escape') {
    hideDialog();
  }
}


function hideQuantityDialog() {
  document.getElementById("quantityDialog").style.display = 'none';
  document.getElementById("productCode").focus(); // Enfocar el campo de b√∫squeda
  document.removeEventListener("keydown", handleQuantityDialogKeydown);
}

function handleQuantityDialogKeydown(event) {
  if (event.key === "Enter") {
    event.preventDefault(); // Previene el comportamiento por defecto del "Enter"
    var quantity = parseFloat(document.getElementById("quantityInput").value);
    var remainingStock = getRemainingStock(currentProduct.code);
    if (!isNaN(quantity) && quantity > 0 && quantity <= remainingStock) {
      addProductToCart(currentProduct, quantity);
      hideQuantityDialog();
    } else {
      showCustomAlert(`Por favor ingrese una cantidad v√°lida dentro del stock restante (${remainingStock}).`);
    }
  } else if (event.key === "Escape") {
    hideQuantityDialog();
  }
}

function acceptQuantity() {
  var quantity = parseFloat(document.getElementById("quantityInput").value);
  var remainingStock = getRemainingStock(currentProduct.code);
  if (!isNaN(quantity) && quantity > 0 && quantity <= remainingStock) {
    addProductToCart(currentProduct, quantity);
    hideQuantityDialog();
  } else {
    showCustomAlert(`Por favor ingrese una cantidad v√°lida dentro del stock restante (${remainingStock}).`);
  }
}

function cobrar() {
  showPaymentModal();
}

function generateUniqueTransactionId(saleCode) {
  return saleCode + '_' + Date.now();
}

let isSavingInBackground = false;
let isProcessingSale = false; // Ya la ten√≠as, la mantenemos

// Modificaci√≥n de funci√≥n processSale para limpiar el carrito inmediatamente despu√©s de guardar
// Funci√≥n para reservar un n√∫mero de factura
function reservarNumeroFactura() {
  return new Promise((resolve, reject) => {
    showScreenBlocker('Reservando n√∫mero de factura...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideScreenBlocker();
        if (result.success) {
          console.log("N√∫mero de factura reservado:", result.docNumber);
          resolve(result);
        } else {
          console.error("Error al reservar n√∫mero de factura:", result.mensaje);
          showCustomAlert("Error al reservar n√∫mero de factura: " + result.mensaje);
          reject(new Error(result.mensaje));
        }
      })
      .withFailureHandler(function(error) {
        hideScreenBlocker();
        console.error("Error al reservar n√∫mero de factura:", error);
        showCustomAlert("Error en el servidor al reservar n√∫mero de factura");
        reject(error);
      })
      .obtenerYReservarNumeroComprobante();
  });
}

// EN TU ETIQUETA <script> DENTRO DEL HTML
// EN TU ETIQUETA <script> DENTRO DEL HTML

/**
 * REEMPLAZA ESTA FUNCI√ìN
 * Versi√≥n final con una clara separaci√≥n entre la l√≥gica de RECIBO y FACTURA.
 */
async function processSale() {
    if (isProcessingSale) return;
    isProcessingSale = true;
    document.getElementById("confirmPayment").disabled = true;

    // 1. Recopilar datos (com√∫n para ambos)
    const tipoDocumento = document.getElementById("tipoDocumento").value;
    const totalGeneral = parseFloat(document.getElementById("totalGeneral").innerText.replace('$', '').replace(',', ''));
    const amountPaid = parseFloat(document.getElementById("amountPaid").value) || totalGeneral;
    const salesData = [];
    const productosParaImpresion = [];
    const rows = document.getElementById("cart").rows;
    for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].cells;
        const productCode = cells[1].innerText;
        salesData.push({
            saleCode: currentSaleCode, productCode: productCode, productName: cells[2].innerText,
            quantity: parseFloat(cells[4].innerText), price: parseFloat(cells[3].innerText.replace(/[$,]/g, '')),
            client: formatIdentificacion(currentClient.cedula), clientName: currentClient.razonSocial,
            amountPaid: amountPaid, change: amountPaid - totalGeneral, tipoDocumento: tipoDocumento
        });
        productosParaImpresion.push({
            codigo: productCode, nombre: cells[2].innerText, cantidad: parseFloat(cells[4].innerText),
            precio: parseFloat(cells[3].innerText.replace(/[$,]/g, '')), subtotal: parseFloat(cells[5].innerText.replace(/[$,]/g, ''))
        });
    }

    // 2. Actualizar UI a estado "Procesando"
    isSavingInBackground = true;
    document.getElementById("initialButtons").style.display = "none";
    document.getElementById("documentTypeContainer").style.display = "none";
    const postSaveContainer = document.getElementById("postSaveContainer");
    const progressMessage = document.getElementById("progressMessage");
    const loader = postSaveContainer.querySelector('.loader');
    loader.style.display = 'block';
    progressMessage.textContent = "Procesando venta...";
    postSaveContainer.style.display = "block";
    document.getElementById("closeModal").disabled = true;

    // --- BIFURCACI√ìN DE L√ìGICA ---
    if (tipoDocumento === 'RECIBO') {
        // --- CAMINO SIMPLE PARA RECIBOS ---
        
        // a. Preparar datos para imprimir y guardar.
        lastSaleData = {
            docNumber: '', claveAcceso: '', tipoDocumento: 'RECIBO', productos: productosParaImpresion,
            cliente: { ...currentClient }, total: totalGeneral, saleCode: currentSaleCode
        };
        const printFunction = openInvoicePageFromLastSale;
        
        // --- INICIO DEL CAMBIO ---
        // Solo abrir la ventana de impresi√≥n autom√°ticamente si el total es $4 o m√°s.
        if (totalGeneral >= 4) {
            printFunction(); 
        }
        // --- FIN DEL CAMBIO ---

        // El bot√≥n de reimprimir siempre funcionar√°, sin importar el monto.
        document.getElementById("reprintButton").onclick = printFunction;

        // b. Limpiar el carrito para el usuario
        clearCart();
        resetSaleCode();

        // c. Guardar en la hoja de c√°lculo en segundo plano
        google.script.run
            .withSuccessHandler(function(saveResult) {
                if (saveResult.success && saveResult.updatedProducts) {
                    products = saveResult.updatedProducts; // Actualizar inventario local
                }
                loader.style.display = 'none';
                progressMessage.textContent = "¬°Recibo guardado con √©xito!";
                document.getElementById("closeModal").disabled = false;
                isProcessingSale = false;
                isSavingInBackground = false;
            })
            .withFailureHandler(function(err) {
                loader.style.display = 'none';
                progressMessage.textContent = "Error al guardar el recibo.";
                document.getElementById("closeModal").disabled = false;
                isProcessingSale = false;
                isSavingInBackground = false;
            })
            .confirmarYGuardarVenta(salesData, { docNumber: '', claveAcceso: '' });

    } else { // tipoDocumento === 'FACTURA'
        // --- CAMINO OPTIMIZADO PARA FACTURAS (SE MANTIENE SIN CAMBIOS) ---
        
        // a. Validar que la reserva se hizo
        if (!window.facturaReservada || !window.facturaReservada.claveAcceso) {
            progressMessage.textContent = "Error: Faltan datos de reserva de factura.";
            loader.style.display = 'none';
            isProcessingSale = false;
            document.getElementById("closeModal").disabled = false;
            return;
        }
        
        // b. Usar los datos pre-reservados para imprimir y enviar al SRI
        const numeroReservado = window.facturaReservada;
        salesData[0].docNumberReservado = numeroReservado.docNumber;
        salesData[0].configDataReservado = numeroReservado.configData;
        salesData[0].claveAccesoReservada = numeroReservado.claveAcceso;
        
        lastSaleData = {
            docNumber: numeroReservado.docNumber, claveAcceso: numeroReservado.claveAcceso,
            tipoDocumento: 'FACTURA', productos: productosParaImpresion,
            cliente: {
            cedula: formatIdentificacion(currentClient.cedula),
            razonSocial: currentClient.razonSocial,
            direccion: currentClient.direccion || "S/N",
            telefono: currentClient.telefono || "S/N",
            correo: currentClient.correo || "consumidor@final.com"
          }
          , total: totalGeneral, saleCode: currentSaleCode
        };

        const printFunction = openInvoicePage1FromLastSale;
        printFunction(); // Imprimir factura inmediatamente
        document.getElementById("reprintButton").onclick = printFunction;

        clearCart();
        resetSaleCode();
        window.facturaReservada = null;
        
        // c. Iniciar el guardado y el env√≠o al SRI en paralelo
        progressMessage.textContent = "Enviando al SRI y guardando...";
        const webhookJson = prepareWebhookJson(salesData, lastSaleData); 
        sendWebhookToApi(webhookJson); 

        google.script.run
            .withSuccessHandler(function(saveResult){
                if (saveResult.updatedProducts) {
                    products = saveResult.updatedProducts;
                }
                console.log("Guardado en hoja finalizado en segundo plano.");
            })
            .withFailureHandler(function(err){ console.error("Error en guardado en segundo plano:", err); })
            .confirmarYGuardarVenta(salesData, lastSaleData);
    }
}


function processSaleData(salesData) {
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        products = result.updatedProducts;
        clearCart();
        document.getElementById("productCode").value = '';
        updateTotal();
        hidePaymentModal();
        toggleCartVisibility();
        localStorage.removeItem('cartData');
        resetSaleCode();
        resetClientToDefault(); // Reiniciamos el cliente a su valor predeterminado
        updateCurrentClientDisplay();
        hideClientDialog();
        hideScreenBlocker();
        showCustomAlert("Venta guardada con √©xito.", true);
        loadProducts(true);
      } else {
        hideScreenBlocker();
        showCustomAlert(result.message, true);
      }
      document.getElementById("cobrarButton").disabled = false;
      isProcessingSale = false;
    })
    .withFailureHandler(function(error) {
      console.error("Error al guardar la venta:", error);
      hideScreenBlocker();
      showCustomAlert("Error al guardar la venta. Por favor, intenta de nuevo.", true);
      document.getElementById("cobrarButton").disabled = false;
      isProcessingSale = false;
    })
    .recordSalesAndUpdateInventory(salesData);
}


// Aseg√∫rate de que esta funci√≥n est√© conectada al bot√≥n "Cobrar" en tu HTML
document.getElementById("cobrarButton").addEventListener("click", cobrar);

function showDialog() {
  document.getElementById("dialog").style.display = 'block';
  document.addEventListener("keydown", handleDialogKeydown);
}

function hideDialog() {
  document.getElementById("dialog").style.display = 'none';
  document.getElementById("productCode").focus();
  document.removeEventListener("keydown", handleDialogKeydown);
}

function handleDialogKeydown(event) {
  if (event.key === 'Enter') {
    cobrar();
  } else if (event.key === 'Escape') {
    hideDialog();
  }
}

function resetClientToDefault() {
  currentClient = {
    cedula: '9999999999999',
    razonSocial: 'CONSUMIDOR FINAL',
    direccion: 'S/N',
    telefono: 'S/N',
    correo: 'consumidor@final.com'
  };
  saveCurrentClientToStorage();
}

function updateCurrentClientDisplay() {
  const clientNameElement = document.getElementById('currentClientName');
  if (clientNameElement) {
    // Mostrar nombre y c√©dula/RUC
    clientNameElement.textContent = `${currentClient.razonSocial} (${currentClient.cedula})`;
    
    // A√±adir tooltip con m√°s informaci√≥n del cliente
    const clientInfo = `C√©dula/RUC: ${currentClient.cedula}
Direcci√≥n: ${currentClient.direccion}
Tel√©fono: ${currentClient.telefono}
Correo: ${currentClient.correo || 'No disponible'}`;
    
    clientNameElement.title = clientInfo;
    
    // Opcional: mostrar un indicador visual si es o no consumidor final
    if (currentClient.razonSocial === 'CONSUMIDOR FINAL') {
      clientNameElement.classList.add('text-gray-500');
    } else {
      clientNameElement.classList.remove('text-gray-500');
      clientNameElement.classList.add('text-blue-700', 'font-semibold');
    }
  }
}

function hideScreenBlocker() {
  var blockerDiv = document.getElementById('screenBlocker');
  if (blockerDiv) {
    blockerDiv.style.display = 'none';
  }
}

function toggleEditable() {
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  isEditing = !isEditing;

  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    if (isEditing) {
      cells[3].contentEditable = "true";
      cells[4].contentEditable = "true";
      cells[3].classList.add("editable");
      cells[4].classList.add("editable");
      cells[3].addEventListener("blur", handleCellBlur);
      cells[4].addEventListener("blur", handleCellBlur);
      cells[3].addEventListener("keydown", handleCellKeyDown);
      cells[4].addEventListener("keydown", handleCellKeyDown);
      cells[3].setAttribute('data-old-value', cells[3].innerText);
      cells[4].setAttribute('data-old-value', cells[4].innerText);
    } else {
      cells[3].contentEditable = "false";
      cells[4].contentEditable = "false";
      cells[3].classList.remove("editable");
      cells[4].classList.remove("editable");
      cells[3].removeEventListener("blur", handleCellBlur);
      cells[4].removeEventListener("blur", handleCellBlur);
      cells[3].removeEventListener("keydown", handleCellKeyDown);
      cells[4].removeEventListener("keydown", handleCellKeyDown);
    }
    rows[i].classList.remove("highlighted-row");
  }

  document.getElementById("editModeButton").classList.toggle("edit-mode");
  document.getElementById("productCode").disabled = isEditing;

  if (isEditing) {
    highlightRow(1);
  } else {
    document.getElementById("productCode").focus();
  }

  // Siempre mantenemos el event listener para handleArrowKeys
  document.removeEventListener("keydown", handleArrowKeys);
  document.addEventListener("keydown", handleArrowKeys);
}

function handleCellBlur(event) {
  var cell = event.target;
  if (cell.cellIndex === 3 || cell.cellIndex === 4) {
    updateCellTotal(cell);
  }
}

function formatIdentificacion(identificacion) {
  // Remover ap√≥strofe al inicio si existe
  if (identificacion.startsWith("'")) {
    identificacion = identificacion.substring(1);
  }
  
  // Eliminar espacios en blanco
  identificacion = identificacion.trim();
  
  // Determinar si es c√©dula o RUC y formatear adecuadamente
  if (identificacion.length === 13) {
    // Es un RUC completo, no necesita ajustes
    return identificacion;
  } else if (identificacion.length === 12) {
    // Es un RUC al que le falta un cero al inicio
    return '0' + identificacion;
  } else if (identificacion.length === 10) {
    // Es una c√©dula completa
    return identificacion;
  } else if (identificacion.length === 9) {
    // Es una c√©dula a la que le falta un cero al inicio
    return '0' + identificacion;
  } else if (identificacion.length < 9) {
    // Es una c√©dula incompleta, completar con ceros a la izquierda
    return identificacion.padStart(10, '0');
  } else if (identificacion.length < 13 && identificacion.length > 10) {
    // Es un RUC incompleto, completar con ceros a la izquierda
    return identificacion.padStart(13, '0');
  } else {
    // En cualquier otro caso, devolver la identificaci√≥n original
    console.warn("Formato de identificaci√≥n desconocido:", identificacion);
    return identificacion;
  }
}

function getTipoIdentificacion(identificacion) {
  // Consumidor final (identificaci√≥n especial)
  if (identificacion === '9999999999999') {
    return "07"; // Consumidor final
  }
  // RUC (13 d√≠gitos)
  else if (identificacion.length === 13) {
    return "04"; // RUC
  } 
  // C√©dula (10 d√≠gitos)
  else {
    return "05"; // C√©dula
  }
}

// Funci√≥n para formatear el tel√©fono al formato internacional Ecuador (593)
function formatearTelefonoEcuador(telefono) {
  if (!telefono || telefono === "S/N") return telefono;
  
  // Eliminar cualquier car√°cter que no sea d√≠gito
  let numeroLimpio = telefono.toString().replace(/\D/g, '');
  
  // Si el n√∫mero ya tiene el prefijo internacional de Ecuador (593), lo dejamos como est√°
  if (numeroLimpio.startsWith('593')) {
    return numeroLimpio;
  }
  
  // Si el n√∫mero comienza con 0, lo eliminamos
  if (numeroLimpio.startsWith('0')) {
    numeroLimpio = numeroLimpio.substring(1);
  }
  
  // Tomamos los √∫ltimos 9 d√≠gitos (o menos si el n√∫mero es m√°s corto)
  let ultimosDigitos = numeroLimpio.slice(-9);
  
  // A√±adimos el prefijo internacional de Ecuador (593)
  return '593' + ultimosDigitos;
}


function prepareWebhookJson(salesData, result) {
    // Verificar si tenemos datos v√°lidos
    if (!result.docNumber || !result.claveAcceso) {
        console.log("Error: No hay datos de factura disponibles para el webhook.");
        return null;
    }

    // Obtener datos de la venta
    var subtotal = 0;
    var codigosPrincipales = [];
    var codigosAuxiliares = [];
    var descripciones = [];
    var cantidades = [];
    var preciosUnitarios = [];
    var subtotalesSinIVA = [];
    var codigosPorcentaje = [];
    var tarifas = [];
    var ivas = [];
    var descuentos = [];

    // Procesar productos de la venta
    for (var i = 0; i < salesData.length; i++) {
        var sale = salesData[i];
        var codigo = sale.productCode.trim();
        // Reemplazar comas por puntos en la descripci√≥n del producto
        var descripcion = sale.productName.trim().replace(/,/g, ".");
        var precioUnitario = parseFloat(sale.price);
        var cantidad = parseFloat(sale.quantity);
        var subtotalProducto = precioUnitario * cantidad;

        subtotal += subtotalProducto;

        codigosPrincipales.push(codigo);
        codigosAuxiliares.push(codigo);
        descripciones.push(descripcion);
        cantidades.push(cantidad);
        preciosUnitarios.push(precioUnitario);
        subtotalesSinIVA.push(subtotalProducto);
        codigosPorcentaje.push("0"); // Asumimos IVA 0% para todos los productos
        tarifas.push("0");
        ivas.push("0");
        descuentos.push("0");
    }

    // Formatear cantidades y precios con 2 decimales usando punto como separador
    var cantidadesFormateadas = cantidades.map(cantidad => cantidad.toFixed(2));
    var preciosUnitariosFormateados = preciosUnitarios.map(precio => precio.toFixed(2));
    var subtotalesSinIVAFormateados = subtotalesSinIVA.map(subtotal => subtotal.toFixed(2));
    var ivasFormateados = ivas.map(iva => parseFloat(iva).toFixed(2));
    var descuentosFormateados = descuentos.map(descuento => parseFloat(descuento).toFixed(2));

    // Crear formato adecuado para los arrays
    var codigosPrincipalesStr = codigosPrincipales.join(' , ');
    var codigosAuxiliaresStr = codigosAuxiliares.join(' , ');
    var descripcionesStr = descripciones.join(' , ');
    var cantidadesStr = cantidadesFormateadas.join(' , ');
    var preciosUnitariosStr = preciosUnitariosFormateados.join('|');
    var subtotalesSinIVAStr = subtotalesSinIVAFormateados.join('|');
    var codigosPorcentajeStr = codigosPorcentaje.join(',');
    var tarifasStr = tarifas.join(',');
    var ivasStr = ivasFormateados.join('|');
    var descuentosStr = descuentosFormateados.join('|');

    // Obtener partes del n√∫mero de documento
    var docParts = result.docNumber.split('-');
    var estab = docParts[0];
    var ptoEmi = docParts[1];
    var secuencial = docParts[2];

    // Obtener ambiente (1 para PRUEBAS, 2 para PRODUCCI√ìN)
    var ambiente = result.ambiente || "2";

    // Obtener la fecha actual en formato dd/mm/yyyy
    var now = new Date();
    var fechaEmision = now.toLocaleDateString('es-EC', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });

    // --- INICIO DE LA CORRECCI√ìN ---
    // Obtener toda la informaci√≥n del cliente desde el objeto 'result.cliente'
    var identificacionComprador = formatIdentificacion(result.cliente.cedula);
    var tipoIdentificacionComprador = getTipoIdentificacion(identificacionComprador);
    var telefonoCliente = formatearTelefonoEcuador(result.cliente.telefono || "S/N");

    // Usar valores fijos para instance_id y access_token
    var instanceId = "67C8964C93564";
    var accessToken = "661b9b91e7fc7";

    // Crear el JSON con los datos recopilados y corregidos
    var jsonData = {
        "instance_id": instanceId,
        "access_token": accessToken,
        "archivo": `FACTURA-${estab}-${ptoEmi}-${secuencial}.xml`,
        "facturaPDF": `FACTURA-${estab}-${ptoEmi}-${secuencial}.pdf`,
        "correo": result.cliente.correo || "consumidor@final.com",
        "ambiente": ambiente,
        "razonSocial": "NISHVE CORO JESSICA NATALIA",
        "nombreComercial": "FERRESOLUCIONES",
        "ruc": "1727849695001",
        "claveAcceso": result.claveAcceso,
        "estab": estab,
        "ptoEmi": ptoEmi,
        "secuencial": secuencial,
        "dirMatriz": "Calle: LUIS CORDERO Numero: 132 Interseccion: JOSE MEJIA",
        "contribuyenteRimpe": "",
        "contribuyenteRIDE": "CONTRIBUYENTE R√âGIMEN RIMPE NEGOCIO POPULAR",
        "fechaEmision": fechaEmision,
        "dirEstablecimiento": "Calle: LUIS CORDERO Numero: 132 Interseccion: JOSE MEJIA",
        "obligadoContabilidad": "NO",
        "tipoIdentificacionComprador": tipoIdentificacionComprador,
        "razonSocialComprador": result.cliente.razonSocial,
        "identificacionComprador": identificacionComprador,
        "direccionComprador": result.cliente.direccion || "S/N",
        "telefonoCliente": telefonoCliente,
        "telefonoContribuyente": "0963160804",
        "factura": result.docNumber,
        "formaPago": "01",
        "formaPagoRIDE": "01 SIN UTILIZACI√ìN DEL SISTEMA FINANCIERO",
        "codigoPorcentajeTotales": "0",
        "baseImponibleTotales": subtotal.toFixed(2),
        "valorTotales": "0.00",
        "totalSinImpuestos": subtotal.toFixed(2),
        "importeTotal": subtotal.toFixed(2),
        "totalDescuento": "0.00",
        "valor": "0.00",
        "codigoPrincipal": codigosPrincipalesStr,
        "codigoAuxiliar": codigosAuxiliaresStr,
        "descripcion": descripcionesStr,
        "cantidad": cantidadesStr,
        "precioUnitario": preciosUnitariosStr,
        "subtotalSinIVA": subtotalesSinIVAStr,
        "codigoPorcentaje": codigosPorcentajeStr,
        "tarifa": tarifasStr,
        "iva": ivasStr,
        "descuento": descuentosStr,
        "subtotal12": "0.00",
        "subtotal0": subtotal.toFixed(2),
        "subtotalNoObjeto": "0.00",
        "subtotalExento": "0.00",
        "campoAdicional": "campoAdicional nombre=\"Correo de cliente\"",
        "codigoArtesano": result.cliente.correo || "consumidor@final.com",
        "artesanoRide": "-",
        "clave_12": "Jnnc1998",
        "urlLogo": "https://i.ibb.co/8gLPXfjh/FERRISOLUCIONES-1.png",
        "urlLogoPieCorreo": "https://i.ibb.co/sv9RgHTk/Blue-and-Yellow-Modern-Illustrated-Artificial-Intelligence-Solutions-Twitter-Header.jpg",
        "correoRemitente": "contacto@luispinta.com",
        "clavecorreoRemitente": "mkiagqnssyaixyvf",
        "hostcorreoRemitente": "smtp.gmail.com",
        "puertocorreoRemitente": "587",
        "nombrep12": "luisPinta.p12",
        "ambientesri": "https://cel.sri.gob.ec"
    };
    // --- FIN DE LA CORRECCI√ìN ---

    // Mostrar en consola para verificaci√≥n
    console.log("JSON preparado para webhook:", JSON.stringify(jsonData, null, 2));

    return jsonData;
}

let sriCheckInterval = null;



function formatCedulaOrRuc(numero) {
  // Asegurarse de que el n√∫mero sea una cadena
  numero = String(numero);
  // Eliminar cualquier espacio en blanco
  numero = numero.trim();
  
  // Si el n√∫mero tiene 13 d√≠gitos, es un RUC
  if (numero.length === 13) {
    return numero;
  }
  
  // Si el n√∫mero tiene menos de 10 d√≠gitos, a√±adir ceros al principio
  while (numero.length < 10) {
    numero = '0' + numero;
  }
  
  return numero;
}

function handleCellKeyDown(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    event.target.blur();
  } else if (event.key === "Escape") {
    event.preventDefault();
    event.target.innerText = event.target.getAttribute('data-old-value');
    event.target.blur();
  }
}

function showScreenBlocker(message = 'Procesando...') {
  // Buscar si ya existe un screen blocker
  let blocker = document.getElementById('screenLocker');
  
  // Si no existe, crear uno nuevo
  if (!blocker) {
    blocker = document.createElement('div');
    blocker.id = 'screenLocker';
    
    // Estilos para el blocker
    blocker.style.position = 'fixed';
    blocker.style.top = '0';
    blocker.style.left = '0';
    blocker.style.width = '100%';
    blocker.style.height = '100%';
    blocker.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    blocker.style.display = 'flex';
    blocker.style.justifyContent = 'center';
    blocker.style.alignItems = 'center';
    blocker.style.flexDirection = 'column';
    blocker.style.zIndex = '999999'; // Un valor mayor que el del modal (que es 99999)
    
    // Contenido del blocker
    const spinner = document.createElement('div');
    spinner.className = 'loader';
    spinner.style.width = '48px';
    spinner.style.height = '48px';
    spinner.style.border = '5px solid #FFF';
    spinner.style.borderBottomColor = '#FF3D00';
    spinner.style.borderRadius = '50%';
    spinner.style.animation = 'rotation 1s linear infinite';
    
    const messageEl = document.createElement('p');
    messageEl.textContent = message;
    messageEl.style.color = 'white';
    messageEl.style.marginTop = '16px';
    messageEl.style.fontWeight = 'bold';
    
    blocker.appendChild(spinner);
    blocker.appendChild(messageEl);
    document.body.appendChild(blocker);
    
    // A√±adir keyframes para la animaci√≥n si no existen
    if (!document.getElementById('loaderAnimation')) {
      const style = document.createElement('style');
      style.id = 'loaderAnimation';
      style.textContent = `
        @keyframes rotation {
          0% { transform: rotate(0deg) }
          100% { transform: rotate(360deg) }
        }
      `;
      document.head.appendChild(style);
    }
  } else {
    // Si ya existe, actualizar el mensaje
    const messageEl = blocker.querySelector('p');
    if (messageEl) {
      messageEl.textContent = message;
    }
    
    // Mostrar el blocker
    blocker.style.display = 'flex';
    blocker.style.zIndex = '999999'; // Asegurar que tenga el z-index correcto
  }
}

function generateSaleCode() {
  return currentSaleCode || ('S' + Date.now());
}

function resetSaleCode() {
  currentSaleCode = null;
  localStorage.removeItem('currentSaleCode');
}

// EN TU ETIQUETA <script> DENTRO DEL HTML
// EN TU ETIQUETA <script> DENTRO DEL HTML

/**
 * REEMPLAZA ESTA FUNCI√ìN (VERSI√ìN FINAL CORREGIDA)
 * Eval√∫a el √©xito de la factura bas√°ndose en 'sriResponse.status === "0"'
 * en lugar de 'sriResponse.detalle'.
 */
function sendWebhookToApi(webhookJson) {
    console.log("==========================================");
    console.log("Enviando datos al servicio de firma para procesamiento y autorizaci√≥n...");
    console.log("==========================================");

    const progressMessage = document.getElementById("progressMessage");
    const closeModalBtn = document.getElementById("closeModal");
    const idVenta = lastSaleData.saleCode;
    const loader = document.querySelector("#postSaveContainer .loader");

    progressMessage.textContent = "Procesando factura con el SRI...";

    google.script.run
        .withSuccessHandler(function(result) {
            console.log("==========================================");
            console.log("Respuesta recibida del servicio de firma:", result);
            console.log("==========================================");

            let estadoFinal = "FALLIDO";
            let mensajeFinalUI = "Ocurri√≥ un error inesperado.";
            let colorClass = "text-red-600";

            try {
                if (result && result.responseText && typeof result.responseText === 'string') {
                    const sriResponse = JSON.parse(result.responseText);

                    // --- INICIO DE LA CORRECCI√ìN ---
                    // Evaluamos por 'status === "0"' como indicador principal de √©xito,
                    // seg√∫n la estructura real de la respuesta de tu API.
                    if (result.success && sriResponse.status === "0") {
                        // Caso de √©xito
                        estadoFinal = "AUTORIZADO";
                        // Usamos el 'detalle' para el mensaje de √©xito si existe, si no, un mensaje gen√©rico.
                        mensajeFinalUI = `¬°Factura AUTORIZADA por el SRI! (${sriResponse.detalle || 'Procesada correctamente'})`;
                        colorClass = "text-green-600";
                    } else {
                        // Caso de fallo (status diferente de "0" o error)
                        estadoFinal = "FALLIDO";
                        // Usamos el 'message' de la respuesta para el mensaje de error.
                        mensajeFinalUI = `Factura no autorizada. Motivo: ${sriResponse.message || 'Error desconocido del servicio'}`;
                    }
                    // --- FIN DE LA CORRECCI√ìN ---

                } else {
                    throw new Error("La respuesta del servicio de firma es inv√°lida.");
                }
            } catch (e) {
                console.error("Error al parsear la respuesta del servidor:", e);
                estadoFinal = "FALLIDO";
                mensajeFinalUI = "No se pudo interpretar la respuesta del servidor.";
            }

            if (loader) {
                loader.style.display = 'none';
            }

            progressMessage.innerHTML = `<strong class="${colorClass}">${mensajeFinalUI}</strong>`;
            console.log(`Actualizando estado de la venta ${idVenta} a: ${estadoFinal}`);
            google.script.run.actualizarEstadoVenta(idVenta, estadoFinal);

            closeModalBtn.disabled = false;
            closeModalBtn.focus();
            isSavingInBackground = false;
            isProcessingSale = false;
        })
        .withFailureHandler(function(error) {
            console.error("Fallo de comunicaci√≥n con el servicio de firma:", error);
            if (loader) {
                loader.style.display = 'none';
            }
            progressMessage.innerHTML = `<strong class="text-red-600">Error de comunicaci√≥n. No se pudo procesar la factura.</strong>`;
            google.script.run.actualizarEstadoVenta(idVenta, "FALLIDO");
            closeModalBtn.disabled = false;
            isSavingInBackground = false;
            isProcessingSale = false;
        })
        .enviarDatosAlServicioFirma(webhookJson);
}


function openInvoicePage1FromLastSale() {
  // Verificar que haya datos guardados
  if (!lastSaleData.docNumber) {
    showCustomAlert("No hay datos de factura disponibles");
    return;
  }
  
  var cantidades = [];
  var servicios = [];
  var unit_prices = [];
  var total_prices = [];
  
  // Usar los datos guardados de los productos
  for (var i = 0; i < lastSaleData.productos.length; i++) {
    var producto = lastSaleData.productos[i];
    cantidades.push(producto.cantidad);
    // Reemplazar comas por puntos en el nombre del producto antes de codificarlo
    var nombreProducto = producto.nombre.replace(/,/g, ".");
    servicios.push(encodeURIComponent(nombreProducto));
    unit_prices.push(producto.precio);
    total_prices.push(producto.subtotal);
  }

  var now = new Date();
  var formattedDate = now.toLocaleString('es-EC', { 
    timeZone: 'America/Guayaquil', 
    day: '2-digit', 
    month: '2-digit', 
    year: '2-digit', 
    hour: '2-digit', 
    minute: '2-digit', 
    second: '2-digit', 
    hour12: false 
  }).replace(/[/]/g, '/').replace(',', '');

  // Determinar el ambiente basado en la clave de acceso
  // La posici√≥n 23 (√≠ndice 22) de la clave de acceso contiene el valor del ambiente
  var ambienteValue = lastSaleData.claveAcceso ? lastSaleData.claveAcceso.charAt(23) : "2";
  var ambiente = ambienteValue === "1" ? "PRUEBAS" : "PRODUCCI√ìN";
  
  var url = "https://pos.manasakilla.com/FACTURA.html" +
    "?invoice_date=" + encodeURIComponent(formattedDate) +
    "&venta=" + encodeURIComponent(lastSaleData.saleCode) +
    "&subtotal=" + encodeURIComponent(lastSaleData.total.toFixed(2)) +
    "&discount=" + encodeURIComponent("0.00") +
    "&attendant=" + encodeURIComponent("CAJAPC") +
    "&customer_name=" + encodeURIComponent(lastSaleData.cliente.razonSocial) +
    "&customer_id=" + encodeURIComponent(lastSaleData.cliente.cedula) +
    "&customer_address=" + encodeURIComponent(lastSaleData.cliente.direccion) +
    "&customer_phone=" + encodeURIComponent(lastSaleData.cliente.telefono) +
    "&customer_email=" + encodeURIComponent(lastSaleData.cliente.correo) +
    "&quantities=" + cantidades.join(',') +
    "&descriptions=" + servicios.join(',') +
    "&unit_prices=" + unit_prices.join(',') +
    "&total=" + encodeURIComponent(lastSaleData.total.toFixed(2)) +
    "&total_prices=" + total_prices.join(',') +
    "&invoice_number=" + encodeURIComponent(lastSaleData.docNumber) +
    "&environment=" + encodeURIComponent(ambiente) +
    "&auth_number=" + encodeURIComponent(lastSaleData.claveAcceso) +
    "&emission=" + encodeURIComponent("NORMAL");

  window.open(url, '_blank');
}

// Nueva funci√≥n para abrir el recibo basado en los datos guardados de la √∫ltima venta
function openInvoicePageFromLastSale() {
  // Verificar que haya datos guardados
  if (!lastSaleData.cliente) {
    showCustomAlert("No hay datos de venta disponibles");
    return;
  }
  
  var cantidades = [];
  var servicios = [];
  var p_units = [];
  var p_total = [];
  
  // Usar los datos guardados de los productos
  for (var i = 0; i < lastSaleData.productos.length; i++) {
    var producto = lastSaleData.productos[i];
    cantidades.push(producto.cantidad);
    // Reemplazar comas por puntos en el nombre del producto antes de codificarlo
    var nombreProducto = producto.nombre.replace(/,/g, ".");
    servicios.push(encodeURIComponent(nombreProducto));
    p_units.push(producto.precio);
    p_total.push(producto.subtotal);
  }

  var now = new Date();
  var formattedDate = now.toLocaleString('es-EC', { 
    timeZone: 'America/Guayaquil', 
    day: '2-digit', 
    month: '2-digit', 
    year: '2-digit', 
    hour: '2-digit', 
    minute: '2-digit', 
    second: '2-digit', 
    hour12: false 
  }).replace(/[/]/g, '/').replace(',', '');

  var url = "https://pos.manasakilla.com/RECIBO.html" +
    "?fecha=" + encodeURIComponent(formattedDate) +
    "&venta=" + encodeURIComponent(lastSaleData.saleCode) +
    "&subtotal=" + encodeURIComponent(lastSaleData.total.toFixed(2)) +
    "&descuento=0" +
    "&vendedor=CAJAPC" +
    "&nombre_cliente=" + encodeURIComponent(lastSaleData.cliente.razonSocial) +
    "&cedula_cliente=" + encodeURIComponent(lastSaleData.cliente.cedula) +
    "&direccion_cliente=" + encodeURIComponent(lastSaleData.cliente.direccion) +
    "&telefono_cliente=" + encodeURIComponent(lastSaleData.cliente.telefono) +
    "&cantidades=" + cantidades.join(',') +
    "&servicios=" + servicios.join(',') +
    "&p_units=" + p_units.join(',') +
    "&total=" + encodeURIComponent(lastSaleData.total.toFixed(2)) +
    "&p_total=" + p_total.join(',') +
    "&tipo_documento=RECIBO";

  window.open(url, '_blank');
}

let clients = [];
let currentClient = {
  cedula: '1700000000',
  razonSocial: 'CONSUMIDOR FINAL',
  direccion: 'S/N',
  telefono: 'S/N'
};


function loadCurrentClientFromStorage() {
  const storedClient = localStorage.getItem('currentClient');
  if (storedClient) {
    currentClient = JSON.parse(storedClient);
  }
}

function saveCurrentClientToStorage() {
  localStorage.setItem('currentClient', JSON.stringify(currentClient));
}

function hideClientDialog() {
  document.getElementById('clientDialog').style.display = 'none';
  
  // Remover el manejo de la tecla Escape al cerrar el cuadro de di√°logo
  document.removeEventListener('keydown', handleClientDialogKeydown);
}

function handleClientDialogKeydown(event) {
  if (event.key === 'Escape') {
    hideClientDialog();
  }
}



function clearClientSearchResults() {
  const resultsTable = document.getElementById('clientSearchResults');
  resultsTable.innerHTML = '';
  resultsTable.style.display = 'none';
}


function validateCedula() {
  const cedula = document.getElementById('newClientCedula').value.trim();
  const saveButton = document.getElementById('saveNewClientButton');
  
  if (cedula.length === 10 || cedula.length === 13) {
    document.getElementById('consultCedulaButton').style.display = cedula.length === 10 ? 'inline-block' : 'none';
    document.getElementById('consultRucButton').style.display = cedula.length === 13 ? 'inline-block' : 'none';
    saveButton.style.display = 'inline-block';
  } else {
    document.getElementById('consultCedulaButton').style.display = 'none';
    document.getElementById('consultRucButton').style.display = 'none';
    saveButton.style.display = 'none';
  }
}





function showEditClientDialog() {
  document.getElementById('editClientCedula').value = currentClient.cedula;
  document.getElementById('editClientRazonSocial').value = currentClient.razonSocial;
  document.getElementById('editClientDireccion').value = currentClient.direccion;
  document.getElementById('editClientTelefono').value = currentClient.telefono;
  document.getElementById('editClientCorreo').value = currentClient.correo || '';
  document.getElementById('editClientDialog').style.display = 'block';
}

function hideEditClientDialog() {
  document.getElementById('editClientDialog').style.display = 'none';
}

function saveEditClient() {
  const correo = document.getElementById('editClientCorreo').value.trim();
  
  // Validar formato de correo electr√≥nico
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!correo || !emailRegex.test(correo)) {
    showCustomAlert("Por favor, ingrese un correo electr√≥nico v√°lido.");
    return;
  }
  
  // Mostrar indicador de carga
  showScreenBlocker('Guardando informaci√≥n del cliente...');
  
  // Actualizar cliente local
  currentClient.razonSocial = document.getElementById('editClientRazonSocial').value;
  currentClient.direccion = document.getElementById('editClientDireccion').value;
  currentClient.telefono = document.getElementById('editClientTelefono').value;
  currentClient.correo = correo;
  
  // Guardar en localStorage
  saveCurrentClientToStorage();
  
  // Actualizar el cliente en la base de datos
  google.script.run
    .withSuccessHandler(function(success) {
      console.log("Cliente actualizado en la base de datos:", success);
      
      // Actualizar el cliente en el array local
      for (let i = 0; i < clients.length; i++) {
        if (clients[i].cedula === currentClient.cedula) {
          clients[i] = {...currentClient};
          break;
        }
      }
      
      // Recargar todos los clientes para asegurar datos actualizados
      reloadClients();
      
      // Quitar el bloqueador y mostrar mensaje
      hideScreenBlocker();
      showCustomAlert("Cliente actualizado correctamente.");
      
      // Cerrar di√°logos y actualizar interfaz
      hideEditClientDialog();
      hideClientDialog();
      updateCurrentClientDisplay();
    })
    .withFailureHandler(function(error) {
      hideScreenBlocker();
      console.error("Error al actualizar el cliente:", error);
      showCustomAlert("Error al actualizar el cliente. Por favor, intente de nuevo.");
    })
    .updateClient(currentClient);
}

// Constante para el correo por defecto
const DEFAULT_CLIENT_EMAIL = "nishvenatalia99@gmail.com";

// Funci√≥n mejorada para configurar los botones "No tiene correo"
function setupNoEmailButtons() {
  console.log("Configurando botones 'No tiene correo'...");
  
  // Bot√≥n para el formulario de registro
  const newClientNoCorreoBtn = document.getElementById('newClientNoCorreo');
  if (newClientNoCorreoBtn) {
    console.log("Bot√≥n newClientNoCorreo encontrado, a√±adiendo event listener");
    newClientNoCorreoBtn.onclick = function(event) {
      event.preventDefault();
      console.log("Bot√≥n 'No tiene correo' en registro clickeado");
      const emailInput = document.getElementById('newClientCorreo');
      emailInput.value = DEFAULT_CLIENT_EMAIL;
      emailInput.classList.remove('border-red-500');
      emailInput.classList.add('border-green-500');
      // Actualizar la validaci√≥n del formulario para mostrar el bot√≥n de guardar
      validateClientForm();
    };
  } else {
    console.warn("Bot√≥n newClientNoCorreo no encontrado");
  }

  // Bot√≥n para el formulario de edici√≥n
  const editClientNoCorreoBtn = document.getElementById('editClientNoCorreo');
  if (editClientNoCorreoBtn) {
    console.log("Bot√≥n editClientNoCorreo encontrado, a√±adiendo event listener");
    editClientNoCorreoBtn.onclick = function(event) {
      event.preventDefault();
      console.log("Bot√≥n 'No tiene correo' en edici√≥n clickeado");
      const emailInput = document.getElementById('editClientCorreo');
      emailInput.value = DEFAULT_CLIENT_EMAIL;
      emailInput.classList.remove('border-red-500');
      emailInput.classList.add('border-green-500');
      // Habilitar el bot√≥n de guardar
      document.getElementById('saveEditClientButton').disabled = false;
    };
  } else {
    console.warn("Bot√≥n editClientNoCorreo no encontrado");
  }
}

function configureClientDialogObserver() {
  // Funci√≥n para verificar si un modal est√° visible
  function checkClientDialogVisibility() {
    const clientDialog = document.getElementById('clientDialog');
    if (clientDialog && window.getComputedStyle(clientDialog).display === 'block') {
      console.log("Di√°logo de cliente detectado como visible, configurando botones");
      setTimeout(setupNoEmailButtons, 100);
    }
  }

  // Crear un observador para detectar cambios en el DOM
  const observer = new MutationObserver(function(mutations) {
    checkClientDialogVisibility();
  });

  // Configurar y empezar la observaci√≥n
  observer.observe(document.body, {
    childList: true,
    subtree: true,
    attributes: true,
    attributeFilter: ['style', 'class']
  });

  // Tambi√©n verificar al inicio
  checkClientDialogVisibility();
}

// Funci√≥n para asegurar que se configuren los botones cuando se muestre el di√°logo
function configureClientDialogButtons() {
  // Crear un observador para detectar cuando el di√°logo se hace visible
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
        const dialog = document.getElementById('clientDialog');
        if (dialog && dialog.style.display === 'block') {
          console.log("Di√°logo de cliente visible, configurando botones");
          // Esperar un poco para asegurar que los elementos ya est√°n disponibles
          setTimeout(setupNoEmailButtons, 100);
        }
      }
    });
  });

  // Observar cambios en el estilo del di√°logo
  const clientDialog = document.getElementById('clientDialog');
  if (clientDialog) {
    observer.observe(clientDialog, { attributes: true });
  }
}


function reloadClients() {
  google.script.run
    .withSuccessHandler(function(data) {
      clients = data;
      console.log("Lista de clientes actualizada:", clients.length, "clientes cargados");
    })
    .withFailureHandler(function(error) {
      console.error("Error al recargar clientes:", error);
    })
    .getAllClients();
}

function changeClient() {
  hideClientDialog();
  showClientDialog();
}

function updateCurrentClientDisplay() {
  const clientDisplay = document.getElementById('currentClientDisplay');
  if (clientDisplay) {
    clientDisplay.textContent = `Cliente actual: ${currentClient.razonSocial}`;
  }
}


function formatCurrency(value) {
  // Asegurarse de que value sea un n√∫mero
  value = parseFloat(value);
  if (isNaN(value)) {
    return "$0.00";
  }
  // Formatear el n√∫mero con dos decimales
  return "$" + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
}


function formatDateTimeEcuador() {
  var now = new Date();
  var ecuadorTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Guayaquil"}));
  
  var day = ("0" + ecuadorTime.getDate()).slice(-2);
  var month = ("0" + (ecuadorTime.getMonth() + 1)).slice(-2);
  var year = ecuadorTime.getFullYear();
  var hours = ("0" + ecuadorTime.getHours()).slice(-2);
  var minutes = ("0" + ecuadorTime.getMinutes()).slice(-2);
  var seconds = ("0" + ecuadorTime.getSeconds()).slice(-2);

  return day + "/" + month + "/" + year + " " + hours + ":" + minutes + ":" + seconds;
}

function showSaleQuantityDialog(product) {
  var existingDialog = document.getElementById('saleQuantityDialog');
  if (existingDialog) {
    existingDialog.parentNode.removeChild(existingDialog);
  }

  // Obtener el stock restante actual
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  var stockRestante = product.stock;

  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    if (cells[1].innerText == product.code) {
      var currentQuantity = parseFloat(cells[4].innerText);
      stockRestante -= currentQuantity;
    }
  }

  // Verificar si hay suficiente stock antes de mostrar el di√°logo
  if (stockRestante <= 0) {
    showCustomAlert('Stock insuficiente para el producto: ' + product.name);
    return;
  }

  var dialogHTML = `
    <div id="saleQuantityDialog" class="modal" style="display: flex; justify-content: center; align-items: center;">
      <div class="modal-content">
        <h3>A√±adir al carrito</h3>
        <p>Producto: ${product.name}</p>
        <p>Stock disponible: ${stockRestante}</p>
        <input type="number" id="saleQuantityInput" min="1" max="${stockRestante}" value="">
        <button id="confirmSaleQuantity">Confirmar</button>
        <button onclick="closeSaleQuantityDialog()">Cancelar</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', dialogHTML);
  console.log("Cuadro de di√°logo insertado en el DOM");

  var confirmButton = document.getElementById('confirmSaleQuantity');
  var quantityInput = document.getElementById('saleQuantityInput');
  
  console.log("confirmButton:", confirmButton);
  console.log("quantityInput:", quantityInput);

  confirmButton.onclick = function() {
    var quantity = parseInt(quantityInput.value);
    console.log("Confirmar cantidad:", quantity);
    if (quantity > 0 && quantity <= stockRestante) {
      console.log("Cantidad v√°lida, a√±adiendo al carrito");
      addProductToCart(product, quantity);
      closeSaleQuantityDialog();
    } else {
      console.log("Cantidad inv√°lida, mostrando alerta");
      showCustomAlert('Por favor, ingrese una cantidad v√°lida.');
    }
  };

  quantityInput.onkeydown = function(event) {
    console.log("Tecla presionada en quantityInput:", event.key);
    if (event.key === 'Enter') {
      event.preventDefault();
      console.log("Enter presionado, haciendo clic en confirmar");
      confirmButton.click();
    }
  };

  // Intentamos enfocar el input varias veces si es necesario
  const tryFocusInput = (attemptsLeft) => {
    quantityInput.focus();
    console.log("quantityInput enfocado:", document.activeElement === quantityInput);
    if (document.activeElement !== quantityInput && attemptsLeft > 0) {
      setTimeout(() => tryFocusInput(attemptsLeft - 1), 100);
    }
  };

  tryFocusInput(5); // Intentamos enfocar el input hasta 5 veces

  // A√±adir event listener para cerrar con Escape
  document.addEventListener('keydown', handleQuantityDialogEscape);

  console.log("Eventos registrados");
}




function handleQuantityDialogEscape(event) {
  if (event.key === 'Escape') {
    closeSaleQuantityDialog();
  }
}

function closeSaleQuantityDialog() {
  console.log("Cerrando cuadro de di√°logo de cantidad de venta");
  var dialog = document.getElementById('saleQuantityDialog');
  if (dialog) {
    dialog.parentNode.removeChild(dialog);
  }
  // Restablecer el valor del input de cantidad
  var quantityInput = document.getElementById('saleQuantityInput');
  if (quantityInput) {
    quantityInput.value = '';
  }
  // Remover event listener para Escape
  document.removeEventListener('keydown', handleQuantityDialogEscape);

  // Enfocar el campo de b√∫squeda
  document.getElementById('productCode').focus();
}



function addProductToCart(product, quantity = 1) {
  console.log("A√±adiendo producto al carrito:", product, "Cantidad:", quantity);
  if (!currentSaleCode) {
    currentSaleCode = generateSaleCode();
  }
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  var productExists = false;
  var initialStock = product.stock;

  // Verificar si hay suficiente stock antes de a√±adir o actualizar
  if (initialStock <= 0 || quantity > initialStock) {
    showCustomAlert(`Stock insuficiente. Solo hay ${initialStock} en inventario.`);
    return;
  }

  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    if (cells[1].innerText == product.code) {
      var currentQuantity = parseFloat(cells[4].innerText);
      var newQuantity = currentQuantity + quantity;
      if (newQuantity > initialStock) {
        showCustomAlert(`Stock insuficiente. Solo hay ${initialStock} en inventario.`);
        return;
      }
      cells[4].innerHTML = `<strong>${newQuantity.toFixed(2)}</strong>`;
      
      // Obtener el precio actual (que podr√≠a ya tener descuento)
      var currentPrice = parseFloat(cells[3].innerText.replace('$', '').replace(',', ''));
      cells[5].innerHTML = `<strong>${formatCurrency(newQuantity * currentPrice)}</strong>`;
      
      var stockRestante = initialStock - newQuantity;
      cells[0].innerHTML = `<strong>${stockRestante.toFixed(2)}</strong>`;
      productExists = true;

      // Actualizar el color de fondo basado en el stock restante
      if (stockRestante <= product.minStock) {
        rows[i].classList.add("low-stock");
      } else {
        rows[i].classList.remove("low-stock");
      }

      if (isProfitShowing) {
          calculateAndShowProfit();
      }
      
      break;
    }
  }

  
  if (!productExists) {
    var stockRestante = initialStock - quantity;
    var newRow = cart.insertRow(1);
    newRow.insertCell(0).innerHTML = `<strong>${stockRestante.toFixed(2)}</strong>`;
    newRow.insertCell(1).innerHTML = `<strong>${product.code}</strong>`;
    newRow.insertCell(2).innerHTML = `<strong>${product.name}</strong>`;
    
    var precioCell = newRow.insertCell(3);
    var precioMostrado = parseFloat(product.price);
    
    // Guardar precio original en caso de que est√© activa la promoci√≥n
    if (promoMadreActive) {
      originalPrices[product.code] = precioMostrado;
      precioMostrado = precioMostrado * 0.9; // Aplicar 10% de descuento
    }
    
    precioCell.innerHTML = `<strong>${formatCurrency(precioMostrado)}</strong>`;
    
    newRow.insertCell(4).innerHTML = `<strong>${quantity.toFixed(2)}</strong>`;
    newRow.insertCell(5).innerHTML = `<strong>${formatCurrency(quantity * precioMostrado)}</strong>`;
    
    var actionCell = newRow.insertCell(6);
    actionCell.className = 'action-cell'; // Agregar clase para posicionamiento

    // Contenedor para mantener la posici√≥n relativa
    var buttonContainer = document.createElement('div');
    buttonContainer.style.position = 'relative';
    buttonContainer.style.width = '100px';
    buttonContainer.style.margin = '0 auto';

    // Bot√≥n de eliminar
    var deleteButton = document.createElement("button");
    deleteButton.innerHTML = 'üóëÔ∏è';
    deleteButton.classList.add("delete-button");
    deleteButton.onclick = function() {
      deleteRow(deleteButton);
    };
    buttonContainer.appendChild(deleteButton);

    // Bot√≥n de ganancia (inicialmente oculto pero en la misma posici√≥n)
    var profitButton = document.createElement('button');
    profitButton.className = 'item-profit-button';
    profitButton.dataset.productCode = product.code;
    profitButton.innerHTML = 'G: $0.00'; // Valor inicial
    buttonContainer.appendChild(profitButton);

    actionCell.appendChild(buttonContainer);

    // Colorear en rojo si el stock restante es bajo
    if (stockRestante <= product.minStock) {
      newRow.classList.add("low-stock");
    }
  }

  document.getElementById("productCode").value = '';
  document.getElementById("productCode").focus();
  updateTotal();
  clearSearchResults();
  toggleCartVisibility();
  saveCartToLocalStorage();
}

function showHelpDialog() {
  var existingDialog = document.getElementById('helpDialog');
  if (existingDialog) {
    existingDialog.parentNode.removeChild(existingDialog);
  }

  var dialogHTML = `
    <div id="helpDialog" class="modal" style="display: flex; justify-content: center; align-items: center;">
      <div class="modal-content">
        <span class="close" onclick="closeHelpDialog()">&times;</span>
        <h3>Ayuda</h3>
<p><strong>F1:</strong> Cobrar venta, solo hazlo si se vendi√≥ el producto.</p>
<p><strong>F2:</strong> Modo edici√≥n, activa esto cuando quieras dar un precio especial o modificar cantidades.</p>
<p><strong>F3:</strong> Seleccionar, cambiar o registrar un cliente, √∫salo para hacer facturas o recibos con datos.</p>
<p><strong>F4:</strong> Para imprimir un <strong>RECIBO</strong>.</p>
<p><strong>F5:</strong> Para imprimir una <strong>FACTURA</strong>.</p>
<p><strong>F10:</strong> Para <strong>LIMPIAR</strong> el carrito, esto borra todos los productos y el cliente seleccionado.</p>
<p><strong>SHIFT(‚áß):</strong> Para ingresar un producto con c√≥digo y cantidad directa. <em>(Se necesita el c√≥digo del producto)</em></p>
<p><strong>Tab(‚áÑ):</strong> Para activar el buscador.</p>
<p><strong>Control:</strong> Ayuda</p>
<p><strong>Escape:</strong> Para cerrar algunas ventanas.</p>

      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', dialogHTML);
  
  document.addEventListener('keydown', handleHelpDialogEscape);
}

function closeHelpDialog() {
  var dialog = document.getElementById('helpDialog');
  if (dialog) {
    dialog.parentNode.removeChild(dialog);
  }
  document.removeEventListener('keydown', handleHelpDialogEscape);
  document.getElementById("productCode").focus();
}

function handleHelpDialogEscape(event) {
  if (event.key === 'Escape'  || event.code === "ControlRight" ) {
    closeHelpDialog();
  }
}

function isAnyDialogOpen() {
  return document.querySelector('.modal[style*="display: flex"]') !== null;
}


// Funci√≥n auxiliar para formatear moneda (asumiendo que ya tienes esta funci√≥n)
function formatCurrency(value) {
  return '$' + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
}

// Funciones para mostrar y ocultar el bloqueador de pantalla
function showScreenBlocker(message) {
  var blockerDiv = document.getElementById('screenBlocker');
  if (!blockerDiv) {
    blockerDiv = document.createElement('div');
    blockerDiv.id = 'screenBlocker';
    blockerDiv.style.position = 'fixed';
    blockerDiv.style.top = '0';
    blockerDiv.style.left = '0';
    blockerDiv.style.width = '100%';
    blockerDiv.style.height = '100%';
    blockerDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
    blockerDiv.style.display = 'flex';
    blockerDiv.style.justifyContent = 'center';
    blockerDiv.style.alignItems = 'center';
    blockerDiv.style.zIndex = '9999';
    
    var messageDiv = document.createElement('div');
    messageDiv.style.backgroundColor = 'white';
    messageDiv.style.padding = '20px';
    messageDiv.style.borderRadius = '5px';
    messageDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
    
    blockerDiv.appendChild(messageDiv);
    document.body.appendChild(blockerDiv);
  }
  
  blockerDiv.querySelector('div').textContent = message;
  blockerDiv.style.display = 'flex';
}

function hideScreenBlocker() {
  var blockerDiv = document.getElementById('screenBlocker');
  if (blockerDiv) {
    blockerDiv.style.display = 'none';
  }
}

//FUNCIONES DE FLECHAS

function handleArrowKeys(event) {
  if (isEditing) {
    handleEditModeKeys(event);
  } else {
    handleSearchModeKeys(event);
  }
}

function handleEditModeKeys(event) {
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  var currentRow = document.querySelector('.highlighted-row');
  var currentIndex = Array.from(rows).indexOf(currentRow);

  switch (event.key) {
    case "ArrowUp":
      if (currentIndex > 1) {
        highlightRow(currentIndex - 1);
        event.preventDefault();
      }
      break;
    case "ArrowDown":
      if (currentIndex < rows.length - 1) {
        highlightRow(currentIndex + 1);
        event.preventDefault();
      }
      break;
    case "+":
      updateQuantity(currentRow, 1);
      event.preventDefault();
      break;
    case "-":
      updateQuantity(currentRow, -1);
      event.preventDefault();
      break;
  }
}

function handleSearchModeKeys(event) {
    var resultsTable = document.getElementById("searchResults");
  var rows = Array.from(resultsTable.getElementsByTagName('tr')).filter(row => !row.classList.contains('header-row'));
  var highlightedRow = resultsTable.querySelector('.highlighted-search');
  var highlightedIndex = highlightedRow ? rows.indexOf(highlightedRow) : -1;

  console.log('Current highlighted index before:', highlightedIndex);

  switch (event.key) {
    case "ArrowUp":
      event.preventDefault();
      if (highlightedIndex > 0) {
        highlightSearchResult(highlightedIndex - 1);
      } else {
        highlightSearchResult(rows.length - 1);
      }
      break;
    case "ArrowDown":
      event.preventDefault();
      if (highlightedIndex === -1 || highlightedIndex === rows.length - 1) {
        highlightSearchResult(0);
      } else {
        highlightSearchResult(highlightedIndex + 1);
      }
      break;
    case "Enter":
      var selectedProduct = getHighlightedSearchResult();
      if (selectedProduct) {
        addProductToCart(selectedProduct);
        clearSearchResults();
        event.preventDefault();
      }
      break;
    case "Shift":
      var selectedProduct = getHighlightedSearchResult();
      if (selectedProduct) {
        showSaleQuantityDialog(selectedProduct);
        event.preventDefault();
      }
      break;
  }
  console.log('Current highlighted index after:', resultsTable.querySelector('.highlighted-search') ? rows.indexOf(resultsTable.querySelector('.highlighted-search')) : -1);
}

function highlightRow(index) {
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  
  for (var i = 1; i < rows.length; i++) {
    rows[i].classList.remove("highlighted-row");
  }
  
  if (index >= 1 && index < rows.length) {
    rows[index].classList.add("highlighted-row");
  }
}

function updateQuantity(row, change) {
  var quantityCell = row.cells[4];
  var currentQuantity = parseFloat(quantityCell.innerText);
  var newQuantity = currentQuantity + change;
  
  if (newQuantity < 0) {
    showCustomAlert("La cantidad no puede ser negativa.");
    return;
  }
  
  var productCode = row.cells[1].innerText;
  var product = products.find(p => p.code == productCode);
  var stockOriginal = product.stock;
  var stockRestante = stockOriginal - newQuantity;
  
  if (stockRestante < 0) {
    showCustomAlert(`Stock insuficiente. Solo quedan ${stockOriginal} en inventario.`);
    return;
  }
  
  quantityCell.innerHTML = `<strong>${newQuantity.toFixed(2)}</strong>`;
  row.cells[0].innerHTML = `<strong>${stockRestante.toFixed(2)}</strong>`;
  
  if (stockRestante <= product.minStock) {
    row.classList.add("low-stock");
  } else {
    row.classList.remove("low-stock");
  }
  
  updateCellTotal(quantityCell);
  flashCell(quantityCell);
}

function flashCell(cell) {
  cell.classList.add("flash-green");
  setTimeout(() => {
    cell.classList.remove("flash-green");
  }, 300);
}


//PARA VUELTO

function showPaymentModal() {
¬†¬†// Limpiar cualquier mensaje previo
¬†¬†limpiarMensajesConfirmacion();
¬†¬†
¬†¬†// Configurar los valores iniciales del modal
¬†¬†var total = document.getElementById("totalGeneral").innerText;
¬†¬†document.getElementById("modalTotalAmount").innerText = total;
¬†¬†document.getElementById("amountPaid").value = "";
¬†¬†document.getElementById("changeAmount").innerText = "$0.00";
¬†¬†document.getElementById("tipoDocumento").value = "RECIBO";
¬†¬†
¬†¬†// Restablecer la UI del modal a su estado inicial
¬†¬†var toggleThumb = document.getElementById("toggleThumb");
¬†¬†if (toggleThumb) {
¬†¬†¬†¬†toggleThumb.style.transform = 'translateX(0)';
¬†¬†¬†¬†var parent = document.querySelector('.drag-container');
¬†¬†¬†¬†if (parent && parent.parentElement) {
¬†¬†¬†¬†¬†¬†parent.parentElement.classList.remove('toggle-active');
¬†¬†¬†¬†}
¬†¬†}
¬†¬†document.getElementById("switchInstruction").innerHTML = 'Desliza el interruptor para cambiar';
¬†¬†
¬†¬†// Mostrar los contenedores y botones correctos
¬†¬†document.getElementById("documentTypeContainer").style.display = "block";
¬†¬†document.getElementById("initialButtons").style.display = "flex";
¬†¬†document.getElementById("postSaveContainer").style.display = "none"; // Ocultar el nuevo contenedor
¬†¬†
¬†¬†// Habilitar el bot√≥n de confirmar
¬†¬†var confirmButton = document.getElementById("confirmPayment");
¬†¬†if (confirmButton) confirmButton.disabled = false;
¬†¬†
¬†¬†// Mostrar el modal
¬†¬†document.getElementById("paymentModal").style.display = "block";
¬†¬†
¬†¬†// Enfocar el campo de monto pagado
¬†¬†setTimeout(() => document.getElementById("amountPaid").focus(), 100);
}

function hidePaymentModal() {
    // Solo permitir cerrar si no hay un proceso de guardado en fondo
    if (isSavingInBackground) {
        showCustomAlert("Por favor, espere a que la venta termine de guardarse.");
        return;
    }
    document.getElementById("paymentModal").style.display = "none";
    document.getElementById('productCode').focus();
}

// Funci√≥n para limpiar mensajes de confirmaci√≥n
function limpiarMensajesConfirmacion() {
  // Remover todos los mensajes tipo notificaci√≥n
  var mensajes = document.querySelectorAll('.mt-4.p-2.text-center.font-bold, .confirmation-message');
  mensajes.forEach(function(msg) {
    if (msg && msg.parentNode) {
      msg.parentNode.removeChild(msg);
    }
  });
}

function calculateChange() {
  var total = parseFloat(document.getElementById("modalTotalAmount").innerText.replace('$', '').replace(',', ''));
  var amountPaidInput = document.getElementById("amountPaid");
  var amountPaid;

  if (amountPaidInput.value.trim() === "") {
    amountPaid = total;
    amountPaidInput.value = total.toFixed(2); // Usar el valor num√©rico sin formatear
  } else {
    amountPaid = parseFloat(amountPaidInput.value);
  }
  
  var change = amountPaid - total;
  document.getElementById("changeAmount").innerText = formatCurrency(Math.max(change, 0));
  document.getElementById("confirmPayment").disabled = false;
}

// Funci√≥n para manejar la tecla Enter en el campo de monto pagado
function handlePaymentInput(event) {
  if (event.key === "Enter") {
    event.preventDefault();
    if (document.getElementById("confirmPayment").disabled) {
      calculateChange();
    } else {
      processSale();
    }
  }
}
// Funci√≥n para mostrar el screen blocker
function showScreenBlocker(message, targetView = 'mainView') {
  var blockerDiv = document.getElementById('screenBlocker');
  if (!blockerDiv) {
    blockerDiv = document.createElement('div');
    blockerDiv.id = 'screenBlocker';
    blockerDiv.style.position = 'absolute';
    blockerDiv.style.top = '0';
    blockerDiv.style.left = '0';
    blockerDiv.style.width = '100%';
    blockerDiv.style.height = '100%';
    blockerDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
    blockerDiv.style.display = 'flex';
    blockerDiv.style.justifyContent = 'center';
    blockerDiv.style.alignItems = 'center';
    blockerDiv.style.zIndex = '9999';
    
    var messageDiv = document.createElement('div');
    messageDiv.style.backgroundColor = 'white';
    messageDiv.style.padding = '20px';
    messageDiv.style.borderRadius = '5px';
    messageDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
    
    blockerDiv.appendChild(messageDiv);
  }
  
  blockerDiv.querySelector('div').textContent = message;
  document.getElementById(targetView).appendChild(blockerDiv);
  blockerDiv.style.display = 'flex';
}

// Funci√≥n para ocultar el screen blocker
function hideScreenBlocker() {
  var blockerDiv = document.getElementById('screenBlocker');
  if (blockerDiv) {
    blockerDiv.style.display = 'none';
  }
}


//PARA CONSULTAS DE CEDULA Y RUC
async function consultarCedula(cedula) {
 try {
   const url = 'https://webservices.ec/api/cedula/' + cedula;
   const response = await fetch(url, {
     headers: {
       'Authorization': 'Bearer 7ej8ursgYRncwh2yCADxcfjxrkM7ha8XaGcA3ATv', 
       'Accept': 'application/json'
     }
   });
   return await response.json();
 } catch (error) {
   console.error('Error consultando c√©dula:', error);
   return null;
 }
}

async function consultarRuc(ruc) {
  try {
    const url = 'https://webservices.ec/api/ruc/' + ruc;
    const response = await fetch(url, {
      headers: {
        'Authorization': 'Bearer UYivOMdOlfXWbw5mpi6e0P585fuOqSrTiEGzwCwq',
        'Accept': 'application/json'
      }
    });
    return await response.json();
  } catch (error) {
    console.error('Error consultando RUC:', error);
    return null;
  }
}

// Update existing functions
function showClientDialog() {
  resetClientDialog();
  document.getElementById('clientDialog').style.display = 'block';
  document.getElementById('clientSearchInput').focus();
  
  // Configurar los botones inmediatamente despu√©s de mostrar el di√°logo
  setTimeout(setupNoEmailButtons, 100);
}


function resetClientDialog() {
  document.getElementById('clientSearchDialog').style.display = 'block';
  document.getElementById('registerClientDialog').style.display = 'none';
  document.getElementById('editClientDialog').style.display = 'none';
  document.getElementById('clientSearchInput').value = '';
  clearClientSearchResults();
}


function searchClients() {
  const query = document.getElementById('clientSearchInput').value.toLowerCase().trim();
  const resultsTable = document.getElementById('clientSearchResults');
  
  if (query === '') {
    clearClientSearchResults();
    return;
  }

  // Asegurarnos de usar la lista m√°s actualizada de clientes
  const results = clients.filter(client => 
    client.cedula.toLowerCase().includes(query) || 
    client.razonSocial.toLowerCase().includes(query)
  );

  if (results.length === 0) {
    resultsTable.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">' +
      'B√∫squeda sin resultados. Escribe la c√©dula o RUC en el campo de b√∫squeda para registrar al nuevo cliente.' +
      '</td></tr>';
    
    if (/^\d+$/.test(query)) {
      if (query.length === 10 || query.length === 13) {
        showConsultButtons(query);
      }
    }
  } else {
    displayClientSearchResults(results);
  }
}


function showConsultButtons(query) {
  const resultsTable = document.getElementById('clientSearchResults');
  const buttonRow = document.createElement('tr');
  
  const buttonText = query.length === 10 ? 'Consultar C√©dula' : 'Consultar RUC';
  const onclickAction = "consultarIdentificacion('" + query + "')";
  
  buttonRow.innerHTML = '<td colspan="3" style="text-align: center; padding: 10px;">' +
    '<button onclick="' + onclickAction + '" class="consult-button">' +
    buttonText +
    '</button>' +
    '</td>';
  
  resultsTable.appendChild(buttonRow);
}


async function consultarIdentificacion(numero) {
  showScreenBlocker('Consultando identificaci√≥n...');
  const isCedula = numero.length === 10;
  
  try {
    const response = isCedula ? 
      await consultarCedula(numero) : 
      await consultarRuc(numero);
    
    if (!response || !response.data) {
      hideScreenBlocker();
      showCustomAlert('Error en la consulta. Por favor, intente nuevamente.');
      return;
    }
    
    showRegisterForm(numero, response.data, isCedula);
  } catch (error) {
    console.error('Error en consulta:', error);
    hideScreenBlocker();
    showCustomAlert('Error en la consulta. Por favor, intente nuevamente.');
  }
}

function showRegisterForm(numero, data, isCedula) {
  document.getElementById('registerClientDialog').style.display = 'block';
  document.getElementById('clientSearchDialog').style.display = 'none';
  
  const newClientForm = {
    cedula: numero,
    razonSocial: isCedula ? 
      data.response.nombreCompleto : 
      data.main[0].razonSocial,
    direccion: !isCedula ? 
      data.addit.find(est => est.tipoEstablecimiento === 'MAT')?.direccionCompleta || '' : 
      '',
    telefono: ''
  };
  
  fillRegisterForm(newClientForm);
  hideScreenBlocker();
  
  // Configurar los botones inmediatamente despu√©s de mostrar el formulario
  setTimeout(setupNoEmailButtons, 100);
}


function fillRegisterForm(data) {
  document.getElementById('newClientCedula').value = data.cedula;
  document.getElementById('newClientRazonSocial').value = data.razonSocial;
  document.getElementById('newClientDireccion').value = data.direccion;
  document.getElementById('newClientTelefono').value = data.telefono;
  document.getElementById('newClientCorreo').value = data.correo || '';
  validateClientForm();
}

function validateClientForm() {
  const cedula = document.getElementById('newClientCedula').value.trim();
  const razonSocial = document.getElementById('newClientRazonSocial').value.trim();
  const direccion = document.getElementById('newClientDireccion').value.trim();
  const correo = document.getElementById('newClientCorreo').value.trim();
  
  // Validar formato de correo electr√≥nico con una expresi√≥n regular b√°sica
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const isEmailValid = emailRegex.test(correo);
  
  document.getElementById('saveNewClientButton').style.display = 
    cedula && razonSocial && direccion && correo && isEmailValid ? 'block' : 'none';
}


function hideRegisterDialog() {
  document.getElementById('registerClientDialog').style.display = 'none';
  document.getElementById('clientSearchDialog').style.display = 'block';
  document.getElementById('clientSearchInput').focus();
}

function clearClientSearchResults() {
  const resultsTable = document.getElementById('clientSearchResults');
  if (resultsTable) {
    resultsTable.innerHTML = '';
  }
}

function selectClient(client) {
  // Verificar si el cliente tiene correo electr√≥nico
  if (!client.correo) {
    showAddEmailDialog(client);
    return;
  }
  
  // Asegurarnos de que el objeto cliente tenga todos los campos necesarios
  if (!client.hasOwnProperty('correo')) {
    client.correo = ''; // Inicializar si no existe
  }
  
  // Continuar con la selecci√≥n normal si tiene correo
  currentClient = {...client}; // Usar una copia para evitar modificar el original
  saveCurrentClientToStorage();
  hideClientDialog();
  updateCurrentClientDisplay();
  
  // Log para depuraci√≥n
  console.log("Cliente seleccionado:", currentClient);
}


function displayClientSearchResults(results) {
  const table = document.getElementById('clientSearchResults');
  table.innerHTML = '<tr><th>C√©dula</th><th>Raz√≥n Social</th><th>Correo</th><th>Acci√≥n</th></tr>';
  
  results.forEach(client => {
    const row = table.insertRow();
    row.insertCell(0).textContent = client.cedula;
    row.insertCell(1).textContent = client.razonSocial;
    
    const emailCell = row.insertCell(2);
    emailCell.textContent = client.correo || 'No disponible';
    
    // Marcar en rojo si no tiene correo
    if (!client.correo) {
      emailCell.style.color = 'red';
    }
    
    const actionCell = row.insertCell(3);
    const selectButton = document.createElement('button');
    
    // Si no tiene correo, mostrar bot√≥n para a√±adir correo
    if (!client.correo) {
      selectButton.textContent = 'A√±adir Correo';
      selectButton.onclick = () => showAddEmailDialog(client);
    } else {
      selectButton.textContent = 'Seleccionar';
      selectButton.onclick = () => selectClient(client);
    }
    
    actionCell.appendChild(selectButton);
  });
}


function showAddEmailDialog(client) {
  // Ocultar di√°logo de b√∫squeda
  document.getElementById('clientSearchDialog').style.display = 'none';
  
  // Crear una copia del cliente para editar
  const clientToEdit = {...client};
  
  // Mostrar formulario de edici√≥n con datos del cliente
  document.getElementById('editClientCedula').value = clientToEdit.cedula;
  document.getElementById('editClientRazonSocial').value = clientToEdit.razonSocial;
  document.getElementById('editClientDireccion').value = clientToEdit.direccion;
  document.getElementById('editClientTelefono').value = clientToEdit.telefono;
  document.getElementById('editClientCorreo').value = '';
  
  // Asignar el cliente actual para que se actualice al guardar
  currentClient = clientToEdit;
  
  // Mostrar mensaje indicando que el correo es obligatorio
  const emailField = document.getElementById('editClientCorreo');
  emailField.classList.add('border-red-500');
  emailField.placeholder = "Correo Electr√≥nico (OBLIGATORIO)";
  emailField.focus();
  
  // Deshabilitar el bot√≥n de guardar hasta que se ingrese un correo v√°lido
  document.getElementById('saveEditClientButton').disabled = true;
  
  // Mostrar el di√°logo de edici√≥n
  document.getElementById('editClientDialog').style.display = 'block';
  
  // Configurar los botones inmediatamente despu√©s de mostrar el di√°logo
  setTimeout(setupNoEmailButtons, 100);
}



function initEmailButtonsFeature() {
  // Configurar observador para detectar cambios en el DOM
  configureClientDialogObserver();
  
  // Configurar botones al inicio
  setupNoEmailButtons();
  
  // A√±adir esta configuraci√≥n justo despu√©s de cargar la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(setupNoEmailButtons, 500);
  });
}

function saveNewClient() {
  const cedula = document.getElementById('newClientCedula').value.trim();
  const razonSocial = document.getElementById('newClientRazonSocial').value.trim();
  const direccion = document.getElementById('newClientDireccion').value.trim();
  const telefono = document.getElementById('newClientTelefono').value.trim();
  const correo = document.getElementById('newClientCorreo').value.trim();

  if (!cedula || !razonSocial || !direccion || !correo) {
    // No hacemos nada si faltan datos esenciales
    return;
  }

  // Validar formato de correo electr√≥nico
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(correo)) {
    showCustomAlert("Por favor, ingrese un correo electr√≥nico v√°lido.");
    return;
  }
  
  // Mostrar indicador de carga
  showScreenBlocker('Guardando nuevo cliente...');

  const newClient = {
    cedula: cedula.padStart(10, '0'),
    razonSocial: razonSocial,
    direccion: direccion,
    telefono: telefono,
    correo: correo
  };

  // Actualizamos el cliente actual y la interfaz
  currentClient = newClient;
  saveCurrentClientToStorage();

  // Guardamos el cliente en la base de datos
  google.script.run
    .withSuccessHandler(function() {
      console.log("Cliente guardado en la base de datos");
      
      // A√±adir el cliente al array local
      clients.push({...newClient});
      
      // Recargar todos los clientes para asegurar datos actualizados
      reloadClients();
      
      // Quitar bloqueador y mostrar mensaje
      hideScreenBlocker();
      showCustomAlert("Cliente guardado correctamente.");
      
      // Ocultar di√°logo y actualizar interfaz
      hideRegisterDialog();
      hideClientDialog();
      updateCurrentClientDisplay();
      
      // Limpiar los campos del formulario
      document.getElementById('newClientCedula').value = '';
      document.getElementById('newClientRazonSocial').value = '';
      document.getElementById('newClientDireccion').value = '';
      document.getElementById('newClientTelefono').value = '';
      document.getElementById('newClientCorreo').value = '';
      
      // Ocultar bot√≥n
      document.getElementById('saveNewClientButton').style.display = 'none';
      
      // Enfocar el campo de b√∫squeda
      document.getElementById('productCode').focus();
    })
    .withFailureHandler(function(error) {
      hideScreenBlocker();
      console.error("Error al guardar el cliente:", error);
      showCustomAlert("Error al guardar el cliente. Por favor, intente de nuevo.");
    })
    .saveClient(newClient);
}



function saveClient(client) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName('Clientes');

  // Agregar el cliente al final de la hoja
  sheet.appendRow([
    client.cedula,
    client.razonSocial,
    client.direccion,
    client.telefono
  ]);

  // Puedes devolver un resultado si lo deseas
  return { success: true };
}

function selectFirstClient() {
  const resultsTable = document.getElementById('clientSearchResults');
  const firstRow = resultsTable.querySelector('tr:nth-child(2)'); // Saltamos el encabezado si existe
  if (firstRow) {
    const selectButton = firstRow.querySelector('button');
    if (selectButton) {
      selectButton.click();
    }
  }
}

//PARA EMPEZAR LA APLICACION NO TOCAR
 document.addEventListener('DOMContentLoaded', function() {
    // Check initial cash and initialize the app
    checkInitialCashAndInit(); // Or your main init function

    // Attach the click listener for the profit button
    var profitButton = document.getElementById('profitButton');
    if (profitButton) {
      profitButton.addEventListener('click', calculateAndShowProfit);
    } else {
      console.error("Bot√≥n de ganancia no encontrado!");
    }

    // Optional: Clicking outside the profit button when it shows profit could reset it
    document.addEventListener('click', function(event) {
       var profitButton = document.getElementById('profitButton');
       // If profit is showing and the click was *not* on the button itself
       if (isProfitShowing && profitButton && !profitButton.contains(event.target)) {
           resetProfitButton();
       }
    });

     // Listener for the new Printer button
    const locationButton = document.getElementById('locationGuideButton');
    console.log("Location Button Element:", locationButton); // <-- Add this
    if (locationButton) {
        console.log("Attaching click listener to location button."); // <-- Add this
        locationButton.addEventListener('click', showLocationModal);
    } else {
        console.error("Location guide button (#locationGuideButton) NOT FOUND!"); // <-- Enhanced error
    }

    // Add listeners to the store buttons inside the location modal
    const storeButtons = document.querySelectorAll('#locationModal .store-button');
    console.log("Store Buttons Found:", storeButtons.length); // <-- Add this
    storeButtons.forEach(button => {
        button.addEventListener('click', handleStoreButtonClick);
    });


  });

function initApp() {
  console.log("Iniciando aplicaci√≥n...");
  initializeSystem();
}

function initializeSystem() {
  console.log("DOM cargado, inicializando aplicaci√≥n...");

  var productCodeInput = document.getElementById("productCode");
  if (productCodeInput) {
    productCodeInput.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        searchProductByCode();
      }
    });

    productCodeInput.addEventListener("input", function() {
      var query = this.value;
      if (query === "") {
        clearSearchResults();
      } else if (!query.match(/^\d+$/)) {
        searchProducts();
      }
    });
  }

  // Cargar clientes - versi√≥n mejorada
  loadClients();

  document.addEventListener("keydown", function(event) {
    if (event.code === "F1") {
      event.preventDefault();
      cobrar();
    } else if (event.key === "Shift") {
      var query = productCodeInput ? productCodeInput.value : '';
      if (query.match(/^\d+$/)) {
        var product = products.find(p => p.code == query);
        if (product) {
          showSaleQuantityDialog(product);
        } else {
          showCustomAlert('Producto no encontrado');
        }
      }
    } else if (event.code === "F2") {
      event.preventDefault();
      toggleEditable();
    } else if (event.code === "F3") {
      event.preventDefault();
      showClientDialog();
    } else if (event.code === "F8") {
      event.preventDefault();
      openInvoicePage();
    } else if (event.code === "F10") {
      event.preventDefault();
      showConfirmDialog("¬øEst√°s seguro de que quieres limpiar el carrito?", clearCart);
    } else if (event.code === "ControlRight") {
      event.preventDefault();
      showHelpDialog();
    } else if (event.code === "Tab") {
      event.preventDefault();
      if (!isAnyDialogOpen()) {
        productCodeInput.focus();
      }
    } else if (event.key === "Delete") {
      event.preventDefault();
      var cart = document.getElementById("cart");
      if (cart.rows.length > 1) {
        cart.deleteRow(1);
        updateTotal();
        toggleCartVisibility();
        saveCartToLocalStorage();
      }
    }
  });

 document.addEventListener('keydown', function(event) {
        if (event.ctrlKey && (event.key === 'i' || event.key === 'I')) {
            event.preventDefault(); // Prevent browser's default Ctrl+I action
            showAiChatModal();
        }
    });

    // Listener for Send button
    const sendBtn = document.getElementById('sendButton');
    if (sendBtn) {
        sendBtn.addEventListener('click', sendMessageToAI);
    }

    // Listener for Enter key in input field
    const userInput = document.getElementById('userInput');
    if (userInput) {
        userInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission/newline
                sendMessageToAI();
            }
        });
    }

     // Listener for clicking outside the AI modal content to close
    const aiModal = document.getElementById('aiChatModal');
    if (aiModal) {
      aiModal.addEventListener('click', function(event) {
        // Check if the click is directly on the modal background (overlay)
        if (event.target === aiModal) {
          closeAiChatModal();
        }
      });
    }

// para abrir google
document.addEventListener('keydown', function(event) {
        // Check if Ctrl key is pressed and the key is 'g' or 'G'
        if (event.ctrlKey && (event.key === 'g' || event.key === 'G')) {
            // Prevent the default browser action (like Find)
            event.preventDefault();

            console.log("Ctrl+G detected - Opening Google.com");

            // Open Google in a new tab
            window.open('https://google.com', '_blank');
        }
    });



  // Event listener para F9 - Cuentas por Cobrar
  document.addEventListener("keydown", function(event) {
    if (event.code === "F9") {
      event.preventDefault();
      showCuentasPorCobrarModal();
    }
  });

  // Event Listeners para el campo de correo
  document.getElementById('newClientCorreo').addEventListener('input', function() {
    validateClientForm();
    
    // Validaci√≥n visual del formato de correo
    const correo = this.value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (correo && !emailRegex.test(correo)) {
      this.classList.add('border-red-500');
      this.classList.remove('border-green-500');
    } else if (correo && emailRegex.test(correo)) {
      this.classList.remove('border-red-500');
      this.classList.add('border-green-500');
    } else {
      this.classList.remove('border-red-500', 'border-green-500');
    }
  });
  
  document.getElementById('editClientCorreo').addEventListener('input', function() {
    const correo = this.value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    // Validar email y habilitar/deshabilitar bot√≥n de guardar
    document.getElementById('saveEditClientButton').disabled = !correo || !emailRegex.test(correo);
    
    // Mostrar indicador visual si el correo es v√°lido/inv√°lido
    if (correo && !emailRegex.test(correo)) {
      this.classList.add('border-red-500');
      this.classList.remove('border-green-500');
    } else if (correo && emailRegex.test(correo)) {
      this.classList.remove('border-red-500');
      this.classList.add('border-green-500');
    } else {
      this.classList.remove('border-red-500', 'border-green-500');
    }
  });

  // Event Listeners para gesti√≥n de clientes
  document.getElementById('clientSearchInput').addEventListener('input', searchClients);
  document.getElementById('newClientCedula').addEventListener('input', validateClientForm);
  document.getElementById('newClientRazonSocial').addEventListener('input', validateClientForm);
  document.getElementById('newClientDireccion').addEventListener('input', validateClientForm);
  document.getElementById('newClientTelefono').addEventListener('input', validateClientForm);
  document.getElementById('saveNewClientButton').addEventListener('click', saveNewClient);
  document.getElementById('saveEditClientButton').addEventListener('click', saveEditClient);
  document.getElementById('changeClientButton').addEventListener('click', changeClient);
  
  document.getElementById('clientSearchInput').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      const query = this.value.toLowerCase().trim();

      // Verificamos si hay resultados en la tabla
      const resultsTable = document.getElementById('clientSearchResults');
      const hasResults = resultsTable.querySelectorAll('tr').length > 0;

      // Verificamos si se muestran los botones de consulta
      const consultButton = resultsTable.querySelector('.consult-button');

      if (!hasResults || consultButton) {
        // No hay resultados o est√°n mostrando los botones de consulta
        if (/^\d+$/.test(query) && (query.length === 10 || query.length === 13)) {
          // Si es un n√∫mero de c√©dula o RUC v√°lido, consultamos directamente
          consultarIdentificacion(query);
        }
      } else {
        // Si hay resultados, podemos seleccionar el primer cliente al presionar Enter
        selectFirstClient();
      }
    }
  });

initEmailButtonsFeature();
  // Inicializar el toggle switch
  initializeToggleSwitch();

 initPromoMadreButton();
 
  console.log("Sistema inicializado correctamente.");


}

// Funci√≥n mejorada para cargar clientes
function loadClients() {
  
  google.script.run
    .withSuccessHandler(function(data) {
      clients = data;
      console.log("Clientes cargados:", clients.length);
      loadCurrentClientFromStorage();
      updateCurrentClientDisplay();
      hideScreenBlocker();
    })
    .withFailureHandler(function(error) {
      console.error("Error al cargar clientes:", error);
      hideScreenBlocker();
      showCustomAlert("Error al cargar la lista de clientes. Por favor, recargue la p√°gina.");
    })
    .getallclients();
}

// Funci√≥n mejorada para actualizar la visualizaci√≥n del cliente 
function updateCurrentClientDisplay() {
  const clientNameElement = document.getElementById('currentClientName');
  if (clientNameElement) {
    // Mostrar nombre y c√©dula/RUC
    clientNameElement.textContent = `${currentClient.razonSocial} (${currentClient.cedula})`;
    
    // A√±adir tooltip con m√°s informaci√≥n del cliente
    const clientInfo = `C√©dula/RUC: ${currentClient.cedula}
Direcci√≥n: ${currentClient.direccion}
Tel√©fono: ${currentClient.telefono}
Correo: ${currentClient.correo || 'No disponible'}`;
    
    clientNameElement.title = clientInfo;
    
    // Opcional: mostrar un indicador visual si es o no consumidor final
    if (currentClient.razonSocial === 'CONSUMIDOR FINAL') {
      clientNameElement.classList.add('text-gray-500');
    } else {
      clientNameElement.classList.remove('text-gray-500');
      clientNameElement.classList.add('text-blue-700', 'font-semibold');
    }
  }
}


  // Other Event Listeners

  document.addEventListener("keydown", handleArrowKeys);
  document.getElementById('customAlert').addEventListener('hide', function() {
    document.getElementById('productCode').focus();
  });

  // Payment Related Listeners
  document.getElementById("confirmPayment").addEventListener("click", processSale);
  document.getElementById("cancelPayment").addEventListener("click", hidePaymentModal);
  document.getElementById("amountPaid").addEventListener("input", function() {
    if (this.value.trim() === "") {
      document.getElementById("changeAmount").innerText = "$0.00";
      document.getElementById("confirmPayment").disabled = true;
    } else {
      calculateChange();
    }
  });
  document.getElementById("amountPaid").addEventListener("keypress", handlePaymentInput);

  // Modal and View Management
  document.addEventListener("keydown", function(event) {
    if (event.key === "Escape" && document.getElementById("paymentModal").style.display === "block") {
      hidePaymentModal();
    }
  });

  // Initialize System Components
  loadProducts();
  updateInventoryPeriodically();

  if (!currentSaleCode) {
    currentSaleCode = localStorage.getItem('currentSaleCode') || generateSaleCode();
  }

// Inicializaci√≥n del toggle switch
function initializeToggleSwitch() {
  // Verificar si los elementos existen
  var toggleThumb = document.getElementById('toggleThumb');
  var dragContainer = document.querySelector('.drag-container');
  var tipoDocumento = document.getElementById('tipoDocumento');
  var warningContainer = document.getElementById('switchInstruction');
  
  if (!toggleThumb || !dragContainer || !tipoDocumento || !warningContainer) {
    console.warn('Elementos del toggle switch no encontrados');
    return;
  }
  
  // Inicializar la variable global si no existe
  if (!window.facturaReservada) {
    window.facturaReservada = null;
  }
  
  let isDragging = false;
  let startX, currentX;
  let isReservando = false;
  
  // Manejador de inicio de arrastre
  dragContainer.addEventListener('mousedown', function(e) {
    isDragging = true;
    startX = e.clientX;
    this.style.cursor = 'grabbing';
    e.preventDefault();
  });
  
  // Manejador de movimiento durante arrastre
  document.addEventListener('mousemove', function(e) {
    if (!isDragging || isReservando) return;
    
    currentX = e.clientX;
    const containerRect = dragContainer.getBoundingClientRect();
    const containerWidth = containerRect.width;
    const thumbWidth = toggleThumb.offsetWidth;
    const maxTravel = containerWidth - thumbWidth - 2; // -2 para el padding
    
    // Calcular desplazamiento relativo al inicio del arrastre
    const deltaX = currentX - startX;
    
    // Si el desplazamiento es peque√±o, no hacer nada (para evitar cambios accidentales)
    if (Math.abs(deltaX) < 10) return;
    
    const parent = dragContainer.parentElement;
    
    // Toggle a FACTURA (hacia la derecha)
    if (deltaX > 10 && tipoDocumento.value === "RECIBO") {
      // Si ya tenemos un n√∫mero reservado, solo cambiamos la UI sin hacer una nueva reserva
      if (window.facturaReservada) {
        toggleThumb.style.transform = 'translateX(' + maxTravel + 'px)';
        parent.classList.add('toggle-active');
        tipoDocumento.value = "FACTURA";
        
        // Mostrar el n√∫mero ya reservado
        warningContainer.innerHTML = '<div class="factura-warning">¬°ATENCI√ìN! Se emitir√° FACTURA ELECTR√ìNICA #' + window.facturaReservada.docNumber + '</div>';
        return;
      }
      
      // Si no tenemos n√∫mero reservado, hacemos el proceso completo
      isReservando = true;
      dragContainer.classList.add('disabled-toggle');
      warningContainer.innerHTML = '<div class="bg-yellow-100 text-yellow-800 p-2 rounded">Reservando n√∫mero de factura...</div>';
      
      // Iniciar la reserva del n√∫mero
      reservarNumeroFactura()
        .then(function(resultado) {
          isReservando = false;
          
          // Habilitamos el switch una vez completado
          dragContainer.classList.remove('disabled-toggle');
          
          // Actualizamos la UI con el cambio
          toggleThumb.style.transform = 'translateX(' + maxTravel + 'px)';
          parent.classList.add('toggle-active');
          tipoDocumento.value = "FACTURA";
          
          // Actualizamos el mensaje con el n√∫mero reservado
          warningContainer.innerHTML = '<div class="factura-warning">¬°ATENCI√ìN! Se emitir√° FACTURA ELECTR√ìNICA #' + resultado.docNumber + '</div>';
          
          // Guardamos el n√∫mero reservado en la variable global
          window.facturaReservada = resultado;
          console.log("N√∫mero de factura reservado globalmente:", window.facturaReservada);
        })
        .catch(function(error) {
          isReservando = false;
          
          // En caso de error, dejamos el switch en su posici√≥n original
          dragContainer.classList.remove('disabled-toggle');
          toggleThumb.style.transform = 'translateX(0)';
          parent.classList.remove('toggle-active');
          tipoDocumento.value = "RECIBO";
          
          // Mostramos mensaje de error y restauramos la instrucci√≥n original
          showCustomAlert("No se pudo reservar el n√∫mero de factura: " + error.message);
          warningContainer.innerHTML = 'Desliza el interruptor para cambiar';
        });
    } 
    // Toggle a RECIBO (hacia la izquierda)
    else if (deltaX < -10 && tipoDocumento.value === "FACTURA") {
      toggleThumb.style.transform = 'translateX(0)';
      parent.classList.remove('toggle-active');
      tipoDocumento.value = "RECIBO";
      
      // Restaurar mensaje de instrucci√≥n original pero mantener el n√∫mero reservado
      warningContainer.innerHTML = 'Desliza el interruptor para cambiar';
    }
  });
  
  // Manejador para finalizar el arrastre
  document.addEventListener('mouseup', function() {
    if (!isDragging) return;
    
    isDragging = false;
    if (dragContainer) {
      dragContainer.style.cursor = 'grab';
    }
  });
  
  // Evitar que los clics simples cambien el estado
  dragContainer.addEventListener('click', function(e) {
    e.preventDefault();
  });
  
  // Escuchar el evento de venta completada para resetear
  document.addEventListener('venta-completada', function() {
    console.log("Venta completada, limpiando n√∫mero de factura reservado");
    window.facturaReservada = null;
    
    // Tambi√©n reseteamos la UI si est√° en FACTURA
    if (tipoDocumento.value === "FACTURA") {
      toggleThumb.style.transform = 'translateX(0)';
      dragContainer.parentElement.classList.remove('toggle-active');
      tipoDocumento.value = "RECIBO";
      warningContainer.innerHTML = 'Desliza el interruptor para cambiar';
    }
  });
}

//verificacion de caja inicial

let verificationCodeSent = '';

function checkInitialCashAndInit() {
  showScreenBlocker('Verificando caja inicial...');
  google.script.run
    .withSuccessHandler(function(result) {
      hideScreenBlocker();
      // Peque√±o retardo para asegurar que el screen blocker desaparece completamente
      setTimeout(() => {
        if (result.needsInitialCash) {
          showInitialCashModal(result.yesterdayCash);
        } else {
          initApp();
        }
      }, 100);
    })
    .withFailureHandler(function(error) {
      hideScreenBlocker();
      showCustomAlert("Error al verificar caja inicial: " + error);
    })
    .checkInitialCash();
}

function showInitialCashModal(yesterdayCash) {
  // Eliminar cualquier modal existente primero, usando el m√©todo correcto
  const existingModal = document.getElementById('initialCashModal');
  if (existingModal && existingModal.parentNode) {
    existingModal.parentNode.removeChild(existingModal);
  }
  
  // El resto de la funci√≥n igual...
  const modal = document.createElement('div');
  modal.id = 'initialCashModal';
  modal.style.position = 'fixed';
  modal.style.top = '0';
  modal.style.left = '0';
  modal.style.width = '100%';
  modal.style.height = '100%';
  modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
  modal.style.display = 'flex';
  modal.style.justifyContent = 'center';
  modal.style.alignItems = 'center';
  modal.style.zIndex = '99999'; // Valor extremadamente alto
  
  // Crear el contenido del modal
  const modalContent = document.createElement('div');
  modalContent.className = 'modal-content';
  modalContent.style.position = 'relative';
  modalContent.style.backgroundColor = 'white';
  modalContent.style.padding = '2.5rem';
  modalContent.style.borderRadius = '1rem';
  modalContent.style.width = '90%';
  modalContent.style.maxWidth = '500px';
  modalContent.style.boxShadow = '0 10px 25px rgba(0, 0, 0, 0.2)';
  
  // T√≠tulo
  const title = document.createElement('h2');
  title.className = 'text-2xl font-bold mb-6';
  title.textContent = 'Registro de Caja Inicial';
  modalContent.appendChild(title);
  
  // P√°rrafo de caja anterior
  const paragraph = document.createElement('p');
  paragraph.className = 'mb-4';
  paragraph.innerHTML = 'Caja del d√≠a anterior: <span id="yesterdayCash" class="font-bold">' + formatCurrency(yesterdayCash) + '</span>';
  modalContent.appendChild(paragraph);
  
  // Campo para el responsable
  const responsableLabel = document.createElement('p');
  responsableLabel.className = 'mb-2';
  responsableLabel.textContent = 'Responsable:';
  modalContent.appendChild(responsableLabel);
  
  const responsableInput = document.createElement('input');
  responsableInput.type = 'text';
  responsableInput.id = 'responsableCaja';
  responsableInput.placeholder = 'Nombre del responsable';
  responsableInput.className = 'w-full p-4 text-xl border-2 border-gray-300 rounded-lg mb-6 focus:border-primary focus:ring-2 focus:ring-primary/20';
  modalContent.appendChild(responsableInput);
  
  // Input para el monto
  const montoLabel = document.createElement('p');
  montoLabel.className = 'mb-2';
  montoLabel.textContent = 'Valor de caja:';
  modalContent.appendChild(montoLabel);
  
  const input = document.createElement('input');
  input.type = 'number';
  input.id = 'initialCashAmount';
  input.placeholder = 'Ingrese el valor de la caja f√≠sica';
  input.className = 'w-full p-4 text-xl border-2 border-gray-300 rounded-lg mb-6 focus:border-primary focus:ring-2 focus:ring-primary/20';
  input.step = '0.01';
  modalContent.appendChild(input);
  
  // Contenedor para c√≥digo de verificaci√≥n
  const verificationContainer = document.createElement('div');
  verificationContainer.id = 'verificationCodeContainer';
  verificationContainer.className = 'hidden';
  
  const verificationText = document.createElement('p');
  verificationText.className = 'text-red-600 mb-2';
  verificationText.textContent = 'El valor ingresado es menor al de ayer. Se ha enviado un c√≥digo de verificaci√≥n al correo.';
  verificationContainer.appendChild(verificationText);
  
  const verificationInput = document.createElement('input');
  verificationInput.type = 'text';
  verificationInput.id = 'verificationCode';
  verificationInput.placeholder = 'Ingrese el c√≥digo de verificaci√≥n';
  verificationInput.className = 'w-full p-4 text-xl border-2 border-gray-300 rounded-lg mb-6 focus:border-primary focus:ring-2 focus:ring-primary/20';
  verificationContainer.appendChild(verificationInput);
  
  modalContent.appendChild(verificationContainer);
  
  // Bot√≥n de guardar
  const saveButton = document.createElement('button');
  saveButton.id = 'saveInitialCash';
  saveButton.className = 'bg-primary hover:bg-primary/90 w-full p-3 text-white rounded-lg';
  saveButton.textContent = 'Guardar';
  modalContent.appendChild(saveButton);
  
  // A√±adir contenido al modal
  modal.appendChild(modalContent);
  
  // A√±adir el modal al cuerpo del documento
  document.body.appendChild(modal);
  
  // Enfocar el campo de responsable despu√©s de crear el modal
  setTimeout(function() {
    document.getElementById('responsableCaja').focus();
  }, 100);
  
  // Prevenir cierre por clic fuera del modal
  modal.onclick = function(e) {
    if (e.target === modal) {
      e.stopPropagation(); // Evitar cierre accidental
    }
  };
  
  // Configurar eventos
  document.getElementById('saveInitialCash').onclick = function() {
    handleInitialCashSave(yesterdayCash);
  };
  
  // Manejar tecla Enter para el campo de responsable
  document.getElementById('responsableCaja').onkeypress = function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.getElementById('initialCashAmount').focus();
    }
  };
  
  // Manejar tecla Enter para el campo de monto inicial
  document.getElementById('initialCashAmount').onkeypress = function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleInitialCashSave(yesterdayCash);
    }
  };
  
  // Manejar tecla Enter para el campo de c√≥digo de verificaci√≥n
  document.getElementById('verificationCode').onkeypress = function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleInitialCashSave(yesterdayCash);
    }
  };
}

function handleInitialCashSave(yesterdayCash) {
  const amount = parseFloat(document.getElementById('initialCashAmount').value);
  
  if (isNaN(amount) || amount <= 0) {
    showCustomAlert("Por favor ingrese un valor v√°lido");
    return;
  }
  
  // Obtener el nombre del responsable (puedes a√±adir este campo al modal)
  const responsable = document.getElementById('responsableCaja') ? 
                      document.getElementById('responsableCaja').value : 
                      "Usuario del sistema";
  
  // Obtener la hora actual
  const horaActual = new Date().toLocaleTimeString('es-EC', {
    hour: '2-digit',
    minute: '2-digit'
  });
  
  // Obtener la fecha actual
  const fechaActual = new Date().toLocaleDateString('es-EC', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
  
  // Verificaci√≥n para valores inferiores al esperado
  if (amount < yesterdayCash) {
    if (!verificationCodeSent) {
      showScreenBlocker('Enviando c√≥digo de verificaci√≥n...');
      google.script.run
        .withSuccessHandler(function(code) {
          hideScreenBlocker();
          verificationCodeSent = code;
          document.getElementById('verificationCodeContainer').classList.remove('hidden');
          document.getElementById('verificationCode').focus();
        })
        .withFailureHandler(function(error) {
          hideScreenBlocker();
          showCustomAlert("Error al enviar c√≥digo de verificaci√≥n: " + error);
        })
        .generateAndSendVerificationCode(amount, yesterdayCash);
      return; // Don't proceed until code is verified
    } else {
      const inputCode = document.getElementById('verificationCode').value.toUpperCase();
      if (!inputCode) {
        showCustomAlert("Debe ingresar el c√≥digo de verificaci√≥n");
        return;
      }
      if (inputCode !== verificationCodeSent) {
        showCustomAlert("C√≥digo de verificaci√≥n incorrecto");
        return;
      }
    }
  }
  
  const existingModal = document.getElementById('initialCashModal');
  if (existingModal) {
    existingModal.remove();
  }

  // Preparar los datos para la notificaci√≥n WhatsApp
  const datosCaja = {
    cajaEsperada: yesterdayCash,
    cajaRegistrada: amount,
    fecha: fechaActual,
    responsable: responsable,
    horaApertura: horaActual
  };

  showScreenBlocker('Guardando caja inicial...');
  
  // Primero enviar la notificaci√≥n WhatsApp
  google.script.run
    .withSuccessHandler(function(resultWhatsApp) {
      // Luego guardar la caja inicial
      google.script.run
        .withSuccessHandler(function(result) {
          hideScreenBlocker();
          if (result.success) {
            // Mostrar mensaje de √©xito
            if (resultWhatsApp && resultWhatsApp.success) {
              showCustomAlert("Caja inicial guardada correctamente y notificaci√≥n enviada");
            } else {
              showCustomAlert("Caja inicial guardada correctamente. La notificaci√≥n no pudo ser enviada.");
            }
            initApp();
          } else {
            showCustomAlert("Error al guardar caja inicial");
          }
        })
        .withFailureHandler(function(error) {
          hideScreenBlocker();
          showCustomAlert("Error al guardar caja inicial: " + error);
        })
        .saveInitialCash(amount);
    })
    .withFailureHandler(function(error) {
      // Aunque falle la notificaci√≥n, continuamos con guardar la caja
      console.error("Error al enviar notificaci√≥n: " + error);
      
      google.script.run
        .withSuccessHandler(function(result) {
          hideScreenBlocker();
          if (result.success) {
            showCustomAlert("Caja inicial guardada correctamente. La notificaci√≥n no pudo ser enviada.");
            initApp();
          } else {
            showCustomAlert("Error al guardar caja inicial");
          }
        })
        .withFailureHandler(function(error) {
          hideScreenBlocker();
          showCustomAlert("Error al guardar caja inicial: " + error);
        })
        .saveInitialCash(amount);
    })
    .enviarNotificacionCajaInicial(datosCaja);
}

//cuentas por cobrar
//cuentas por cobrar
// Variable para guardar la referencia al ID de cuenta por cobrar guardada
let cpcGuardadaId = null;
let cpcGuardadaCompleta = false; // Para saber si se guard√≥ correctamente

// Cargar lista de deudores para autocompletar
function loadDeudores() {
  google.script.run
    .withSuccessHandler(function(deudores) {
      var datalist = document.getElementById('deudoresList');
      datalist.innerHTML = '';
      
      deudores.forEach(function(deudor) {
        var option = document.createElement('option');
        option.value = deudor;
        datalist.appendChild(option);
      });
    })
    .withFailureHandler(function(error) {
      console.error('Error al cargar deudores:', error);
    })
    .getDeudores();
}

// Mostrar modal de Cuentas por Cobrar
function showCuentasPorCobrarModal() {
  // Verificar si hay productos en el carrito
  var cart = document.getElementById("cart");
  if (cart.rows.length <= 1) {
    showCustomAlert("No hay productos en el carrito para enviar a Cuentas por Cobrar.");
    return;
  }
  
  // Eliminar modal anterior si existe
  var oldModal = document.getElementById("cuentasPorCobrarModal");
  if (oldModal) {
    oldModal.parentNode.removeChild(oldModal);
  }
  
  // Calcular el total
  var total = parseFloat(document.getElementById("totalGeneral").innerText.replace('$', '').replace(',', ''));
  
  // Crear el modal nuevamente
  var modalHTML = `
  <div id="cuentasPorCobrarModal" class="modal" style="display: block; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 10% auto; padding: 20px; width: 80%; max-width: 600px; border-radius: 10px;">
      <span class="close" onclick="hideCuentasPorCobrarModal()" style="float: right; cursor: pointer; font-size: 24px;">&times;</span>
      <h2 style="margin-bottom: 20px; font-size: 1.5rem; font-weight: bold;">Enviar a Cuentas por Cobrar</h2>
      
      <div style="margin-bottom: 15px;">
        <p style="font-size: 1.2rem;">Total: <span id="cpcTotalAmount" style="font-weight: bold;">${formatCurrency(total)}</span></p>
        <p style="font-size: 1.2rem;">ID Venta: <span id="cpcVentaId" style="font-weight: bold;">${currentSaleCode || generateSaleCode()}</span></p>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label for="cpcDeudor" style="display: block; margin-bottom: 5px;">Deudor</label>
        <input list="deudoresList" type="text" id="cpcDeudor" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Nombre del deudor">
        <datalist id="deudoresList"></datalist>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label for="cpcMotivo" style="display: block; margin-bottom: 5px;">Motivo/Descripci√≥n</label>
        <input type="text" id="cpcMotivo" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Motivo de la cuenta por cobrar">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label for="cpcOtros" style="display: block; margin-bottom: 5px;">Otros Detalles (opcional)</label>
        <textarea id="cpcOtros" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Detalles adicionales"></textarea>
      </div>
      
      <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
        <button id="cpcGuardarBtn" onclick="guardarCuentaPorCobrar()" style="background-color: #fbc318; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
          Guardar CxC
        </button>
        <button id="cpcImprimirBtn" onclick="imprimirReciboCxC()" style="background-color: #2196F3; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
          Imprimir Recibo
        </button>
        <button onclick="hideCuentasPorCobrarModal()" style="background-color: #757575; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
          Cancelar
        </button>
      </div>
    </div>
  </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Generar un ID temporal para la cuenta por cobrar
  cpcGuardadaId = 'V' + new Date().getTime();
  cpcGuardadaCompleta = false;
  
  // Cargar deudores para autocompletar
  loadDeudores();
  
  // Enfocar el campo de deudor
  setTimeout(function() {
    document.getElementById("cpcDeudor").focus();
  }, 100);
}

// Mejora para la funci√≥n hideCuentasPorCobrarModal
function hideCuentasPorCobrarModal() {
  var modal = document.getElementById("cuentasPorCobrarModal");
  if (modal) {
    modal.style.display = "none";
    // Alternativamente, remover el modal completamente
    // modal.parentNode.removeChild(modal);
  }
  
  // Si se complet√≥ el guardado, limpiar el carrito
  if (cpcGuardadaCompleta) {
    clearCart();
  } else {
    // Si no se guard√≥ completamente, limpiamos el ID temporal
    cpcGuardadaId = null;
  }
  
  // Enfocar el campo de b√∫squeda
  document.getElementById("productCode").focus();
}


// Manejar teclas en el modal de CxC
function handleCpcModalKeydown(event) {
  if (event.key === "Escape") {
    hideCuentasPorCobrarModal();
  }
}

// Validar formulario de CxC
function validarFormularioCxC() {
  const deudor = document.getElementById("cpcDeudor").value.trim();
  const motivo = document.getElementById("cpcMotivo").value.trim();
  
  if (!deudor) {
    showCustomAlert("Debe ingresar el nombre del deudor.");
    return false;
  }
  
  if (!motivo) {
    showCustomAlert("Debe ingresar un motivo para la cuenta por cobrar.");
    return false;
  }
  
  return true;
}

// Funci√≥n para guardar cuenta por cobrar
function guardarCuentaPorCobrar() {
  // Si ya completamos el proceso, no permitir guardar de nuevo
  if (cpcGuardadaCompleta) {
    showCustomAlert("Esta cuenta ya ha sido guardada.");
    return;
  }
  
  // Validar formulario
  if (!validarFormularioCxC()) {
    return;
  }
  
  // Mostrar indicador de carga
  showScreenBlocker('Procesando venta y enviando a CxC...');
  
  // Primero procesamos la venta normalmente, pero sin mostrar el modal de cobro
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  var total = parseFloat(document.getElementById("totalGeneral").innerText.replace('$', '').replace(',', ''));
  
  var salesData = [];

  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    var productCode = cells[1].innerText;
    var quantity = parseFloat(cells[4].innerText);
    var price = parseFloat(cells[3].innerText.replace('$', '').replace(',', ''));
    var product = products.find(p => p.code == productCode);

    var sale = {
      saleCode: currentSaleCode,
      productCode: productCode,
      productName: product.name,
      quantity: quantity,
      price: price,
      client: currentClient.cedula,
      clientName: currentClient.razonSocial,
      amountPaid: total, // La venta se "paga" con el total (aunque sea fiada)
      change: 0 // Sin cambio/vuelto
    };
    salesData.push(sale);
  }
  
  // Procesar la venta
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        // La venta se proces√≥ correctamente, ahora registramos en Cuentas por Cobrar
        // Actualizar productos
        products = result.updatedProducts;
        
        // Obtener datos del formulario para CxC
        const datosCuenta = {
          deudor: document.getElementById("cpcDeudor").value.trim(),
          motivo: document.getElementById("cpcMotivo").value.trim(),
          otros: document.getElementById("cpcOtros").value.trim(),
          monto: total,
          idVenta: currentSaleCode
        };
        
        // Enviar a Cuentas por Cobrar
        google.script.run
          .withSuccessHandler(function(cpcResult) {
            hideScreenBlocker();
            
            if (cpcResult.success) {
              // Actualizamos el ID de la cuenta por cobrar con el real del servidor
              cpcGuardadaId = cpcResult.idCuenta;
              cpcGuardadaCompleta = true;
              
              // Mensaje de √©xito
              showCustomAlert("La venta y la cuenta por cobrar han sido registradas correctamente.");
              
              // Desactivar bot√≥n de guardar
              document.getElementById("cpcGuardarBtn").disabled = true;
              document.getElementById("cpcGuardarBtn").classList.add("opacity-50");
              
              // NO cerramos el modal para permitir imprimir
            } else {
              showCustomAlert("Error al guardar la cuenta por cobrar: " + cpcResult.message + "\nLa venta se proces√≥ correctamente, pero no se registr√≥ como cuenta por cobrar.");
            }
          })
          .withFailureHandler(function(error) {
            hideScreenBlocker();
            showCustomAlert("Error al guardar la cuenta por cobrar: " + error + "\nLa venta se proces√≥ correctamente, pero no se registr√≥ como cuenta por cobrar.");
          })
          .enviarACuentasPorCobrar(datosCuenta);
        
      } else {
        // Hubo un error al procesar la venta
        hideScreenBlocker();
        showCustomAlert("Error al procesar la venta: " + result.message);
      }
    })
    .withFailureHandler(function(error) {
      hideScreenBlocker();
      console.error("Error al guardar la venta:", error);
      showCustomAlert("Error al procesar la venta: " + error);
    })
    .recordSalesAndUpdateInventory(salesData);
}

// Funci√≥n para imprimir recibo de cuenta por cobrar
function imprimirReciboCxC() {
  // Verificar que los campos obligatorios est√©n completos
  if (!validarFormularioCxC()) {
    return;
  }
  
  // Si no se ha completado el guardado, primero guardar
  if (!cpcGuardadaCompleta) {
    showCustomAlert("Primero debe guardar la cuenta por cobrar para imprimir el recibo.");
    return;
  }
  
  showScreenBlocker('Preparando recibo...');
  
  // Obtener los datos necesarios
  const deudor = document.getElementById("cpcDeudor").value.trim();
  const total = parseFloat(document.getElementById("totalGeneral").innerText.replace('$', '').replace(',', ''));
  
  // Obtener los productos del carrito para el recibo
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  var cantidades = [];
  var servicios = [];
  var p_units = [];
  var p_total = [];
  
  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    cantidades.push(cells[4].innerText);
    servicios.push(encodeURIComponent(cells[2].innerText));
    p_units.push(cells[3].innerText.replace('$', '').replace(',', ''));
    p_total.push(cells[5].innerText.replace('$', '').replace(',', ''));
  }
  
  // Crear la URL con los par√°metros para la impresi√≥n
  var url = "https://pos.manasakilla.com/RECIBO.html" +
    "?fecha=" + encodeURIComponent(formatDateTimeEcuador()) +
    "&venta=" + encodeURIComponent(cpcGuardadaId) + // Usar el ID de CxC
    "&subtotal=" + encodeURIComponent(total.toFixed(2)) +
    "&descuento=0" +
    "&vendedor=CUENTASPORCOBRAR" +
    "&nombre_cliente=" + encodeURIComponent(deudor) +
    "&cedula_cliente=" + encodeURIComponent("") +
    "&direccion_cliente=" + encodeURIComponent("") +
    "&telefono_cliente=" + encodeURIComponent("") +
    "&cantidades=" + cantidades.join(',') +
    "&servicios=" + servicios.join(',') +
    "&p_units=" + p_units.join(',') +
    "&total=" + encodeURIComponent(total.toFixed(2)) +
    "&p_total=" + p_total.join(',');
  
  hideScreenBlocker();
  
  // Abrir la ventana de impresi√≥n
  window.open(url, '_blank');
  
  // Despu√©s de imprimir, preguntar si desea cerrar el modal
  setTimeout(function() {
    showConfirmDialog("¬øDesea finalizar el proceso?", function() {
      hideCuentasPorCobrarModal();
    });
  }, 500);
}

document.addEventListener("keydown", function(event) {
  if (event.code === "F9") {
    event.preventDefault();
    console.log("F9 presionado - Mostrando modal de Cuentas por Cobrar");
    showCuentasPorCobrarModal();
  }
});



//COTIZACIONES
// Muestra el modal para cargar una cotizaci√≥n
// Definimos el listener como funci√≥n nombrada
function cotizacionKeyListener(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    // Deshabilitar temporalmente el input para evitar m√∫ltiples disparos
    this.disabled = true;
    var raw = this.value;
    var numeric = raw.replace(/\D/g, "");
    if (numeric.length > 0) {
      this.value = numeric;
      loadCotizacionFromModal();
    } else {
      showCustomAlert("N√∫mero de cotizaci√≥n inv√°lido");
      this.disabled = false;
    }
  }
}

function showCotizacionModal() {
  // Si no existe, se crea el modal din√°micamente
  var existingModal = document.getElementById('cotizacionModal');
  if (!existingModal) {
    var modalHtml = `
      <div id="cotizacionModal" class="modal" style="display: flex; justify-content: center; align-items: center;">
        <div class="modal-content">
          <h2>Venta de una cotizaci√≥n</h2>
          <label for="cotizacionNumber">N√∫mero de cotizaci√≥n:</label>
          <input type="text" id="cotizacionNumber" placeholder="Ingrese n√∫mero de cotizaci√≥n" />
          <div style="margin-top: 1rem; text-align: center;">
            <button id="loadCotizacionBtn">Cargar Cotizaci√≥n</button>
            <button id="cancelCotizacionBtn">Cancelar</button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    // Asignar listeners a los botones
    document.getElementById('loadCotizacionBtn').addEventListener('click', loadCotizacionFromModal);
    document.getElementById('cancelCotizacionBtn').addEventListener('click', function() {
      closeCotizacionModal();
    });
    existingModal = document.getElementById('cotizacionModal');
  }
  existingModal.style.display = 'flex';
  
  // Reemplazar el input para eliminar cualquier listener previo
  var inputOld = document.getElementById('cotizacionNumber');
  var inputNew = inputOld.cloneNode(true);
  inputOld.parentNode.replaceChild(inputNew, inputOld);
  
  inputNew.value = "";
  inputNew.disabled = false;
  inputNew.focus();
  
  // Agregar el listener para la tecla Enter sin duplicar
  inputNew.addEventListener('keypress', cotizacionKeyListener);
}

function closeCotizacionModal() {
  var modal = document.getElementById('cotizacionModal');
  if (modal) {
    modal.style.display = 'none';
  }
}

// Funci√≥n que se ejecuta al presionar "Cargar Cotizaci√≥n" en el modal
function loadCotizacionFromModal() {
  var cotizacionNumber = document.getElementById('cotizacionNumber').value.trim();
  if (!cotizacionNumber) {
    showCustomAlert("Por favor ingrese un n√∫mero de cotizaci√≥n");
    return;
  }
  closeCotizacionModal();
  // Llamar a la funci√≥n en Apps Script para obtener la cabecera de la cotizaci√≥n
  google.script.run
    .withSuccessHandler(function(cotizacion) {
      if (!cotizacion) {
        showCustomAlert("Cotizaci√≥n no encontrada");
        return;
      }
      // Seleccionar el cliente basado en el ID de cliente de la cotizaci√≥n
      selectClientByCedula(cotizacion.idCliente);
      
      // Obtener los detalles de la cotizaci√≥n
      google.script.run
        .withSuccessHandler(function(detalles) {
          if (!detalles || detalles.length === 0) {
            showCustomAlert("No se encontraron detalles para la cotizaci√≥n");
            return;
          }
          // Para cada producto en la cotizaci√≥n, intentar agregarlo al carrito
          detalles.forEach(function(det) {
            // Buscar el producto en el array global "products"
            var product = products.find(function(p) {
              return p.code == det.idProducto;
            });
            if (!product) {
              Logger.log("Producto no encontrado para id: " + det.idProducto);
              return;
            }
            // Validar stock disponible
            var remainingStock = getRemainingStock(product.code);
            if (remainingStock < parseFloat(det.cantidad)) {
              showCustomAlert("Producto " + product.name + " no se pudo a√±adir por stock insuficiente");
              return; // Omitir este producto
            }
            // Crear un objeto producto para el carrito, sobreescribiendo el precio unitario con el indicado en la cotizaci√≥n
            var productForCart = Object.assign({}, product);
            productForCart.price = parseFloat(det.precio);
            // Agregar al carrito usando la cantidad especificada en la cotizaci√≥n
            addProductToCart(productForCart, parseFloat(det.cantidad));
          });
        })
        .withFailureHandler(function(error) {
          showCustomAlert("Error al cargar detalles de la cotizaci√≥n: " + error);
        })
        .getCotizacionDetalle(cotizacionNumber);
    })
    .withFailureHandler(function(error) {
      showCustomAlert("Error al cargar la cotizaci√≥n: " + error);
    })
    .getCotizacion(cotizacionNumber);
}

// Funci√≥n auxiliar para seleccionar un cliente basado en la c√©dula (IDCLIENTE de la cotizaci√≥n)
function selectClientByCedula(cedula) {
  // Convertir cedula a string por si viene como n√∫mero
  var cedulaStr = String(cedula || "").trim();
  // Quitar ap√≥strofe al inicio si existe
  var searchCedula = cedulaStr.replace(/^'/, '');

  var client = clients.find(function(c) {
    // Asegurarnos de que la c√©dula en clients tambi√©n es string
    var storedCedula = String(c.cedula || "").trim().replace(/^'/, '');
    return storedCedula === searchCedula;
  });

  if (client) {
    currentClient = client;
    saveCurrentClientToStorage();
    updateCurrentClientDisplay();
  } else {
    showCustomAlert("Cliente con c√©dula " + cedulaStr + " no encontrado.");
  }
}



// Agregar un listener para que al presionar F6 se abra este modal
document.addEventListener("keydown", function(event) {
  if (event.code === "F6") {
    event.preventDefault();
    showCotizacionModal();
  }
});

  
  //para boton ganancia
   //-----------------------------------------------------
  // NUEVA FUNCIONALIDAD: CALCULAR Y MOSTRAR GANANCIA
  //-----------------------------------------------------
   function calculateAndShowProfit() {
  var profitButton = document.getElementById('profitButton');

  // If profit is currently shown, clicking again should reset it
  if (isProfitShowing) {
    resetProfitButton();
    return;
  }

  // Prevent multiple clicks while loading
  if (profitButton.classList.contains('loading')) {
    return;
  }

  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');

  if (rows.length <= 1) {
    showCustomAlert("El carrito est√° vac√≠o. A√±ade productos para ver la ganancia.");
    return;
  }

  var cartItems = [];
  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    var quantity = parseFloat(cells[4].innerText);
    var priceText = cells[3].innerText.replace('$', '').replace(/,/g, '');
    var sellingPrice = parseFloat(priceText);

    if (!isNaN(quantity) && !isNaN(sellingPrice)) {
      cartItems.push({
        productCode: cells[1].innerText,
        quantity: quantity,
        sellingPrice: sellingPrice
      });
    } else {
      console.warn("Item inv√°lido en carrito, saltando:", cells[1].innerText);
    }
  }

  if (cartItems.length === 0) {
    showCustomAlert("No se pudieron procesar los items del carrito para calcular la ganancia.");
    return;
  }

  // --- Start Loading State ---
  profitButton.classList.add('loading');
  profitButton.disabled = true; // Disable button during load

  google.script.run
    .withSuccessHandler(showProfitOnButton) 
    .withFailureHandler(showProfitErrorOnButton)
    .getProfitForCart(cartItems);
}

// Funci√≥n actualizada para mostrar la ganancia en el bot√≥n principal y transformar botones de eliminar
function showProfitOnButton(result) {
  var profitButton = document.getElementById('profitButton');
  var profitTextSpan = profitButton.querySelector('.profit-text');
  var cartContainer = document.getElementById("cart-container");

  // --- Remove Loading State ---
  profitButton.classList.remove('loading');
  profitButton.disabled = false; // Re-enable button

  if (result && result.success) {
    var totalProfit = result.profit;
    
    // --- Transform to Capsule ---
    profitTextSpan.innerHTML = `Ganancia: <strong>${formatCurrency(totalProfit)}</strong>`;
    profitButton.classList.add('showing-profit');
    isProfitShowing = true;
    
    // Marcar el contenedor del carrito como en modo ganancia
    cartContainer.classList.add('profit-mode');
    
    // Transformar los botones de eliminar en botones de ganancia individual
    transformDeleteButtonsToProfitButtons(result.itemProfits);
  } else {
    // Handle controlled error from server
    showProfitErrorOnButton(result ? result.message : "Error desconocido al calcular ganancia.");
  }
}

// Nueva funci√≥n para transformar los botones de eliminar en botones de ganancia
function transformDeleteButtonsToProfitButtons(itemProfits) {
  var cart = document.getElementById("cart");
  var rows = cart.getElementsByTagName('tr');
  
  // Para cada fila del carrito (excepto el encabezado)
  for (var i = 1; i < rows.length; i++) {
    var cells = rows[i].getElementsByTagName('td');
    var productCode = cells[1].innerText; // El c√≥digo del producto
    var actionCell = cells[6]; // La celda de acci√≥n (√∫ltima celda)
    
    // Buscar la ganancia correspondiente para este producto
    var itemProfit = itemProfits.find(function(item) {
      return item.productCode === productCode;
    });
    
    // Si encontramos la ganancia y no hay error
    if (itemProfit && !itemProfit.error) {
      // Obtener el bot√≥n de ganancia
      var profitButton = actionCell.querySelector('.item-profit-button');
      if (profitButton) {
        // Actualizar el texto del bot√≥n con la ganancia formateada
        profitButton.innerHTML = `G: ${formatCurrency(itemProfit.profit)}`;
        
        // Asegurarnos de que el bot√≥n sea visible incluso si el modo a√∫n no se ha activado
        if (isProfitShowing) {
          // Agregar esta l√≠nea solo para asegurarnos
          profitButton.style.visibility = 'visible';
          profitButton.style.opacity = '1';
        }
      }
    }
  }
}

function deleteRow(button) {
  var row = button.closest('tr'); // Usar closest en lugar de parentElement.parentElement
  if (row) {
    row.remove();
    updateTotal();
    toggleCartVisibility();
    saveCartToLocalStorage();
  }
}

  // New error handler: Handles errors without screen blocker
  function showProfitErrorOnButton(error) {
    var profitButton = document.getElementById('profitButton');

    // --- Remove Loading State ---
    profitButton.classList.remove('loading');
    profitButton.disabled = false; // Re-enable button

    console.error("Error al calcular ganancia:", error);
    showCustomAlert("Error al calcular la ganancia: " + (error.message || error));
    resetProfitButton(); // Reset button state on error
  }


  function showProfit(result) {
    hideScreenBlocker(); // Ocultar indicador
    var profitDisplay = document.getElementById('profitDisplay');

    if (result && result.success) {
      var totalProfit = result.profit;
      profitDisplay.innerHTML = `Ganancia: <strong>${formatCurrency(totalProfit)}</strong>`;
      profitDisplay.style.display = 'block'; // Mostrar el display
      isProfitDisplayVisible = true;
    } else {
      // Si hubo un error en el servidor (controlado)
      showProfitError(result ? result.message : "Error desconocido al calcular ganancia.");
      profitDisplay.style.display = 'none';
      isProfitDisplayVisible = false;
    }
  }

  function showProfitError(error) {
    hideScreenBlocker(); // Ocultar indicador
    console.error("Error al calcular ganancia:", error);
    showCustomAlert("Error al calcular la ganancia: " + (error.message || error));
    var profitDisplay = document.getElementById('profitDisplay');
    profitDisplay.style.display = 'none'; // Asegurarse que est√© oculto
    isProfitDisplayVisible = false;
  }

  // Funci√≥n actualizada para resetear el bot√≥n de ganancia y restaurar botones de eliminar
function resetProfitButton() {
  var profitButton = document.getElementById('profitButton');
  var profitTextSpan = profitButton.querySelector('.profit-text');
  var cartContainer = document.getElementById("cart-container");
  
  profitButton.classList.remove('showing-profit');
  profitButton.classList.remove('loading'); // Just in case
  profitButton.disabled = false;
  profitTextSpan.textContent = 'G';
  isProfitShowing = false;
  
  // Quitar la clase profit-mode del contenedor del carrito
  cartContainer.classList.remove('profit-mode');
}

//botonera de ayuda
// --- Location Guide Modal Logic ---
function showLocationModal() {
  console.log("showLocationModal function EXECUTED!");
  const modal = document.getElementById('locationModal');
  console.log("Modal element found:", modal);

  if (modal) {
     console.log("Setting display to: block"); // Log what you're setting
     modal.style.display = 'block'; // <<< Use 'block'
     console.log("Current display style:", window.getComputedStyle(modal).display); // Log the actual computed style
  } else {
    console.error("Could not find element with ID 'locationModal'!");
  }
  document.addEventListener('keydown', handleLocationModalKeydown);
}

function closeLocationModal() {
  const modal = document.getElementById('locationModal');
  if (modal) {
    modal.style.display = 'none'; // <<< Use 'none' to hide
  }
  document.removeEventListener('keydown', handleLocationModalKeydown);
  document.getElementById("productCode").focus();
}

// Function to handle Escape key press for the location modal
function handleLocationModalKeydown(event) {
  if (event.key === 'Escape') {
    closeLocationModal();
  }
}

// Function to handle clicks on store buttons within the modal
function handleStoreButtonClick(event) {
    const button = event.currentTarget; // Use currentTarget to ensure it's the button
    const ferreteriaValue = button.dataset.ferreteria; // Get value from data-ferreteria
    const baseUrl = "https://pos.manasakilla.com/guiaubicacion.html";

    if (ferreteriaValue) {
        const finalUrl = `${baseUrl}?ferreteria=${ferreteriaValue}`;
        window.open(finalUrl, '_blank'); // Open in new tab
        closeLocationModal(); // Close modal after opening link
    } else {
        console.error("Missing data-ferreteria attribute on button:", button);
        showCustomAlert("Error: No se pudo determinar la ferreter√≠a.");
    }
}

//Funcionalidad IA
let chatHistory = []; // Array to store conversation history

// Function to show the AI chat modal
function showAiChatModal() {
  console.log("Showing AI Chat Modal");
  const modal = document.getElementById('aiChatModal');
  if (modal) {
    modal.style.display = 'flex'; // Use flex because the CSS uses it for layout
    // Reset chat history if needed, or load previous session
    // chatHistory = []; // Uncomment to clear history each time
    // Optional: Display initial AI message if history is empty
    const chatbox = document.getElementById('chatbox');
    if (chatbox.children.length <= 1) { // Only add if it's just the initial message placeholder
         // Clear potential old messages if any
         chatbox.innerHTML = '';
         displayMessage("¬°Hola! Soy ManaBot, tu asistente virtual de Ferreter√≠a FERRESOLUCIONES. ¬øEn qu√© puedo ayudarte hoy?", 'ai');
    }

    document.getElementById('userInput').focus(); // Focus input field
    scrollToBottom('chatbox');
  }
  document.addEventListener('keydown', handleAiChatModalKeydown); // Listener for Escape key
}

// Function to close the AI chat modal
function closeAiChatModal() {
  const modal = document.getElementById('aiChatModal');
  if (modal) {
    modal.style.display = 'none';
  }
  document.removeEventListener('keydown', handleAiChatModalKeydown);
  document.getElementById("productCode").focus(); // Focus back on main input
}

// Function to handle Escape key press for the AI chat modal
function handleAiChatModalKeydown(event) {
  // Close only if the target isn't the user input itself (to allow Esc inside input)
  if (event.key === 'Escape' && event.target.id !== 'userInput') {
    closeAiChatModal();
  }
}

// Function to display a message in the chatbox
function displayMessage(text, sender) {
  const chatbox = document.getElementById('chatbox');
  const messageDiv = document.createElement('div');
  messageDiv.classList.add('chat-message', sender + '-message');
  
  if (sender === 'ai') {
    try {
      // 1. Convertir Markdown a HTML
      const htmlContent = marked.parse(text);
      
      // 2. Sanitizar el HTML resultante para seguridad
      const cleanHtml = DOMPurify.sanitize(htmlContent, {
        ADD_TAGS: ['math', 'mrow', 'mi', 'mo', 'mn', 'msup', 'msub', 'mfrac'],
        ADD_ATTR: ['target', 'class'] // Permitir el atributo target y class para enlaces
      });
      
      // 3. Insertar el HTML limpio
      messageDiv.innerHTML = cleanHtml;
      
      // 4. Estilizar enlaces como botones y hacer que se abran en nueva pesta√±a
      const links = messageDiv.querySelectorAll('a');
      links.forEach(link => {
        // Aplicar clase de estilo bot√≥n
        link.classList.add('url-button');
        // Abrir en nueva pesta√±a
        link.setAttribute('target', '_blank');
        link.setAttribute('rel', 'noopener noreferrer');
      });
      
      // 5. Activar MathJax para procesar f√≥rmulas
      setTimeout(() => {
        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
          MathJax.typesetPromise([messageDiv])
            .catch(function(err) { 
              console.error('MathJax Typesetting Error:', err); 
            });
        }
      }, 100);
    } catch (error) {
      console.error("Error rendering message:", error);
      // Fallback en caso de error
      messageDiv.textContent = text;
    }
  } else {
    // Mensajes del usuario como texto plano
    messageDiv.textContent = text;
  }
  
  chatbox.appendChild(messageDiv);
  scrollToBottom('chatbox');
}

// Function to scroll chatbox to the bottom
function scrollToBottom(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.scrollTop = element.scrollHeight;
    }
}

// Function to send message to backend (Apps Script)
function sendMessageToAI() {
    const userInput = document.getElementById('userInput');
    const messageText = userInput.value.trim();
    const thinkingIndicator = document.getElementById('thinkingIndicator');
    const sendButton = document.getElementById('sendButton');


    if (!messageText) {
        return; // Don't send empty messages
    }

    // Display user message immediately
    displayMessage(messageText, 'user');
    // Add to history
    chatHistory.push({ role: 'user', content: messageText });

    // Clear input and show thinking indicator
    userInput.value = '';
    userInput.disabled = true; // Disable input while thinking
    sendButton.disabled = true; // Disable button while thinking
    thinkingIndicator.style.display = 'block';
    scrollToBottom('chatbox');


    console.log("Sending to Apps Script:", messageText);
    console.log("Current History:", JSON.stringify(chatHistory)); // Log history being sent

    // Call the backend function
    google.script.run
        .withSuccessHandler(handleAIResponse)
        .withFailureHandler(handleAIError)
        .callOpenAI(chatHistory); // Send the entire history
}

// Function to handle successful AI response from backend
function handleAIResponse(response) {
    console.log("Received from Apps Script:", response);
    const thinkingIndicator = document.getElementById('thinkingIndicator');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');

    thinkingIndicator.style.display = 'none'; // Hide thinking
    userInput.disabled = false; // Re-enable input
    sendButton.disabled = false; // Re-enable button

    if (response && response.reply) {
        displayMessage(response.reply, 'ai');
        // Add AI response to history
        chatHistory.push({ role: 'assistant', content: response.reply });
    } else {
        displayMessage("Hubo un problema al obtener la respuesta. Por favor, intenta de nuevo.", 'ai');
        chatHistory.push({ role: 'assistant', content: "Error: No reply received." }); // Log error in history
    }
     userInput.focus(); // Focus input field again
     // Optional: Limit chat history size
     // if (chatHistory.length > 10) { chatHistory = chatHistory.slice(-10); }
}

// Function to handle error from backend call
function handleAIError(error) {
    console.error("AI Error:", error);
    const thinkingIndicator = document.getElementById('thinkingIndicator');
    const userInput = document.getElementById('userInput');
    const sendButton = document.getElementById('sendButton');

    thinkingIndicator.style.display = 'none'; // Hide thinking
    userInput.disabled = false; // Re-enable input
    sendButton.disabled = false; // Re-enable button

    // Display a user-friendly error message
    displayMessage("Lo siento, ocurri√≥ un error al comunicarme con la IA. Detalles: " + error.message, 'ai');
    chatHistory.push({ role: 'assistant', content: "Error: " + error.message }); // Log error in history
    userInput.focus(); // Focus input field again
}


//para publicidad
// Script para la integraci√≥n de env√≠o de mensajes por WhatsApp
// A√±adir event listener para Ctrl+P
document.addEventListener('keydown', function(event) {
  // Verificar si Ctrl+P fue presionado (evitar conflicto con la impresi√≥n del navegador)
  if (event.ctrlKey && (event.key === 'p' || event.key === 'P')) {
    // Prevenir el comportamiento predeterminado (di√°logo de impresi√≥n)
    event.preventDefault();
    
    // Mostrar el modal para WhatsApp
    showWhatsAppModal();
  }
});

// Variable global para logs
const whatsappLogs = [];

// Funci√≥n para a√±adir entrada al log
function logMessage(level, message, data = null) {
  const timestamp = new Date().toISOString();
  const logEntry = {
    timestamp,
    level,
    message,
    data
  };
  
  whatsappLogs.push(logEntry);
  
  // Tambi√©n mostramos en la consola
  const formattedMessage = `[${timestamp}] [${level}] ${message}`;
  switch(level) {
    case 'ERROR':
      console.error(formattedMessage, data);
      break;
    case 'WARN':
      console.warn(formattedMessage, data);
      break;
    case 'INFO':
      console.info(formattedMessage, data);
      break;
    default:
      console.log(formattedMessage, data);
  }
  
  // Actualizar consola en el modal si est√° abierta
  updateLogConsole();
}

function updateLogConsole() {
  const logConsole = document.getElementById('logEntries');
  const completedLogConsole = document.getElementById('completedLogEntries');
  
  if (!logConsole && !completedLogConsole) return;
  
  // Formatear logs para mostrar
  const formattedLogs = whatsappLogs.map(log => {
    const time = log.timestamp.split('T')[1].split('.')[0];
    let logClass = '';
    
    switch(log.level) {
      case 'ERROR':
        logClass = 'text-red-500';
        break;
      case 'WARN':
        logClass = 'text-yellow-500';
        break;
      case 'SUCCESS':
        logClass = 'text-green-500';
        break;
      default:
        logClass = 'text-green-300';
    }
    
    return `<div class="${logClass}">[${time}] [${log.level}] ${log.message}</div>`;
  }).join('');
  
  // Actualizar ambas consolas si existen
  if (logConsole) logConsole.innerHTML = formattedLogs;
  if (completedLogConsole) completedLogConsole.innerHTML = formattedLogs;
  
  // Auto-scroll al final
  if (logConsole) logConsole.parentElement.scrollTop = logConsole.parentElement.scrollHeight;
  if (completedLogConsole) completedLogConsole.parentElement.scrollTop = completedLogConsole.parentElement.scrollHeight;
}

// Funci√≥n para mostrar el modal de WhatsApp
function showWhatsAppModal() {
  // Verificar si ya existe un modal y eliminarlo
  const existingModal = document.getElementById('whatsappModal');
  if (existingModal) {
    document.body.removeChild(existingModal);
  }
  
  // Crear el modal
  const modalHTML = `
    <div id="whatsappModal" class="modal" style="display: flex; justify-content: center; align-items: center; z-index: 2000;">
      <div id="whatsappModalContent" class="modal-content" style="width: 90%; max-width: 600px; padding: 25px;">
        <span class="close" onclick="closeWhatsAppModal()">&times;</span>
        
        <div id="uploadSection">
          <h2 class="text-2xl font-bold mb-4">Enviar Mensaje por WhatsApp</h2>
          
          <div class="mb-4">
            <label for="imageUpload" class="block mb-2 text-lg font-medium">Subir Imagen:</label>
            <input type="file" id="imageUpload" accept="image/*" class="block w-full p-2 border border-gray-300 rounded">
            <div id="imagePreviewContainer" class="mt-3 hidden">
              <img id="imagePreview" class="max-w-full h-auto max-h-56 border rounded" />
              <p id="imageUrl" class="mt-2 text-sm text-gray-600 break-all"></p>
            </div>
          </div>
          
          <div class="mb-4">
            <label for="messageText" class="block mb-2 text-lg font-medium">Mensaje:</label>
            <textarea id="messageText" rows="5" class="block w-full p-2 border border-gray-300 rounded" placeholder="Escriba su mensaje aqu√≠..."></textarea>
          </div>
          
          <div class="flex justify-between mt-6">
            <button id="previewButton" onclick="showMessagePreview()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition duration-300">Vista Previa</button>
            <button id="cancelButton" onclick="closeWhatsAppModal()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition duration-300">Cancelar</button>
          </div>
        </div>
        
        <div id="previewSection" class="hidden">
          <h2 class="text-2xl font-bold mb-4">Vista Previa del Mensaje</h2>
          
          <div class="bg-gray-100 rounded-lg p-4 mb-4">
            <div class="bg-green-100 p-3 rounded-lg" style="max-width: 80%; margin-left: auto; border-radius: 10px 0 10px 10px;">
              <div id="previewImageContainer" class="mb-2">
                <img id="previewImage" class="max-w-full h-auto max-h-56 rounded" />
              </div>
              <p id="previewText" class="text-gray-800 break-words"></p>
              <p class="text-xs text-gray-500 text-right mt-1">12:30 PM ‚úì‚úì</p>
            </div>
          </div>
          
          <div class="flex justify-between mt-6">
            <button id="backButton" onclick="backToEdit()" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded transition duration-300">Volver a Editar</button>
            <button id="sendButton" onclick="sendWhatsAppMessages()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition duration-300">Enviar Mensajes</button>
          </div>
        </div>
        
        <div id="sendingSection" class="hidden">
          <h2 class="text-2xl font-bold mb-4">Enviando Mensajes</h2>
          <div class="flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p id="sendingStatus" class="text-center">Verificando n√∫meros...</p>
            <p id="sendingProgress" class="text-center mt-2">0 de 0 mensajes enviados</p>
          </div>
        </div>
        
        <div id="completedSection" class="hidden">
          <h2 class="text-2xl font-bold mb-4">Env√≠o Completado</h2>
          <div class="text-center">
            <p class="text-green-600 text-4xl mb-3">‚úì</p>
            <p id="completedStatus" class="mb-3">Mensajes enviados correctamente.</p>
            <p id="completedStats" class="text-gray-600 mb-6"></p>
            <button onclick="closeWhatsAppModal()" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition duration-300">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Insertar el modal en el DOM
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // A√±adir event listener para la subida de im√°genes
  document.getElementById('imageUpload').addEventListener('change', previewImage);
  
  // A√±adir estilos CSS necesarios
  addWhatsAppStyles();
}

// Funci√≥n para a√±adir estilos necesarios para el modal
function addWhatsAppStyles() {
  const styleId = 'whatsAppStyles';
  
  // Evitar duplicar estilos
  if (document.getElementById(styleId)) {
    return;
  }
  
  const styleElement = document.createElement('style');
  styleElement.id = styleId;
  styleElement.innerHTML = `
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #ddd;
      border-bottom-color: #22c55e;
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  
  document.head.appendChild(styleElement);
}

// Funci√≥n para previsualizar la imagen seleccionada
function previewImage(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  const previewContainer = document.getElementById('imagePreviewContainer');
  const imagePreview = document.getElementById('imagePreview');
  const imageUrlElement = document.getElementById('imageUrl');
  
  reader.onload = function(e) {
    imagePreview.src = e.target.result;
    previewContainer.classList.remove('hidden');
    
    // Simular URL de la imagen (en realidad lo subir√≠amos a un servidor)
    imageUrlElement.textContent = "URL temporal: " + file.name;
    
    // Guardar la imagen como Data URL para usarla despu√©s
    document.getElementById('imageUpload').dataset.imageData = e.target.result;
  };
  
  reader.readAsDataURL(file);
}

// Funci√≥n para mostrar la vista previa del mensaje
function showMessagePreview() {
  const messageText = document.getElementById('messageText').value.trim();
  const imageData = document.getElementById('imageUpload').dataset.imageData;
  
  if (!messageText && !imageData) {
    alert("Por favor, suba una imagen o escriba un mensaje.");
    return;
  }
  
  // Crear un mensaje de ejemplo
  const sampleClientName = "CLIENTE DE EJEMPLO";
  const fullMessage = `ESTIMADO CLIENTE: ${sampleClientName}
${messageText}

Recuerde que en FERRESOLUCIONES usted es nuestra prioridad, por ende compartimos nuevos productos u ofertas con usted.`;
  
  // Actualizar la vista previa
  const previewText = document.getElementById('previewText');
  const previewImage = document.getElementById('previewImage');
  const previewImageContainer = document.getElementById('previewImageContainer');
  
  previewText.innerHTML = fullMessage.replace(/\n/g, '<br>');
  
  if (imageData) {
    previewImage.src = imageData;
    previewImageContainer.classList.remove('hidden');
  } else {
    previewImageContainer.classList.add('hidden');
  }
  
  // Cambiar a la secci√≥n de vista previa
  document.getElementById('uploadSection').classList.add('hidden');
  document.getElementById('previewSection').classList.remove('hidden');
}

// Funci√≥n para volver a la pantalla de edici√≥n
function backToEdit() {
  document.getElementById('previewSection').classList.add('hidden');
  document.getElementById('uploadSection').classList.remove('hidden');
}

// Funci√≥n para cerrar el modal
function closeWhatsAppModal() {
  const modal = document.getElementById('whatsappModal');
  if (modal) {
    document.body.removeChild(modal);
  }
}

// Funci√≥n principal para enviar los mensajes por WhatsApp
async function sendWhatsAppMessages() {
  // Mostrar la secci√≥n de env√≠o
  document.getElementById('previewSection').classList.add('hidden');
  document.getElementById('sendingSection').classList.remove('hidden');
  
  const messageText = document.getElementById('messageText').value.trim();
  const imageData = document.getElementById('imageUpload').dataset.imageData;
  
  logMessage('INFO', 'Iniciando proceso de env√≠o de mensajes');
  
  // Primero, necesitamos obtener todos los clientes de la hoja
  try {
    // Mostrar estado
    updateSendingStatus("Obteniendo lista de clientes...");
    logMessage('INFO', 'Obteniendo lista de clientes desde la hoja de c√°lculo');
    
    // En un caso real, usar√≠amos google.script.run para obtener los clientes
    google.script.run
      .withSuccessHandler(function(clients) {
        logMessage('SUCCESS', `Lista de clientes obtenida: ${clients.length} clientes encontrados`);
        processClientsForWhatsApp(clients, messageText, imageData);
      })
      .withFailureHandler(function(error) {
        const errorMsg = "Error al obtener clientes: " + error;
        logMessage('ERROR', errorMsg);
        showSendingError(errorMsg);
      })
      .getallclients();
  } catch (error) {
    const errorMsg = "Error inesperado: " + error;
    logMessage('ERROR', errorMsg);
    showSendingError(errorMsg);
  }
}

// Funci√≥n para procesar la lista de clientes y enviar mensajes
async function processClientsForWhatsApp(clients, messageText, imageData) {
  if (!Array.isArray(clients) || clients.length === 0) {
    const errorMsg = "No se encontraron clientes para enviar mensajes.";
    logMessage('ERROR', errorMsg);
    showSendingError(errorMsg);
    return;
  }
  
  // Filtrar clientes que tienen n√∫mero de tel√©fono

const clientsWithPhone = clients.filter(client => {
  if (!client.telefono) return false;
  // Convertir a string expl√≠citamente antes de usar trim()
  const phone = String(client.telefono).trim();
  return phone !== "";
});
  
  logMessage('INFO', `Encontrados ${clientsWithPhone.length} clientes con n√∫mero de tel√©fono.`);
  updateSendingStatus(`Encontrados ${clientsWithPhone.length} clientes con n√∫mero de tel√©fono.`);
  
  // Preparar la imagen para enviar
  updateSendingStatus("Subiendo imagen a Google Drive...");
  logMessage('INFO', 'Iniciando subida de imagen a Google Drive');
  
  // Subir la imagen usando google.script.run
  try {
    // En un caso real, primero subimos la imagen al servidor
    logMessage('INFO', 'Enviando imagen al servidor...');
    
    const uploadResult = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .uploadImage(imageData);
    });
    
    if (!uploadResult || !uploadResult.success) {
      throw new Error("Error al subir la imagen: " + (uploadResult?.error || "Error desconocido"));
    }
    
    logMessage('SUCCESS', `Imagen subida correctamente. ID: ${uploadResult.fileId}, URL: ${uploadResult.url}`);
    const imageUrl = uploadResult.url;
    updateSendingStatus(`Imagen subida correctamente. Iniciando env√≠o de mensajes...`);
    
    // Ahora, llamar al script del servidor para enviar los mensajes
    logMessage('INFO', 'Iniciando env√≠o de mensajes a todos los clientes');
    
    const sendResult = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .sendWhatsAppToClients(imageUrl, messageText);
    });
    
    // Registrar resultados detallados
    logMessage('SUCCESS', `Proceso de env√≠o completado. Enviados: ${sendResult.sent}, Fallidos: ${sendResult.failed}, Total: ${sendResult.totalClients}`);
    
    // Registrar detalles por cliente
    if (sendResult.details && Array.isArray(sendResult.details)) {
      sendResult.details.forEach(detail => {
        const logLevel = detail.status === 'SUCCESS' ? 'SUCCESS' : 'ERROR';
        logMessage(logLevel, `Cliente: ${detail.client} (${detail.phone}) - ${detail.message}`);
      });
    }
    
    // Mostrar resumen final
    showCompletedStatus(
      sendResult.sent || 0, 
      sendResult.failed || 0, 
      sendResult.totalClients || clientsWithPhone.length
    );
    
  } catch (error) {
    const errorMsg = "Error en el proceso de env√≠o: " + error.message;
    console.error(error);
    logMessage('ERROR', errorMsg, error);
    showSendingError(errorMsg);
  }
}

// Funci√≥n para formatear el n√∫mero de tel√©fono
function formatPhoneNumber(phoneNumber) {
  if (!phoneNumber) return null;
  
  // Eliminar espacios, guiones y otros caracteres no num√©ricos
  let cleaned = phoneNumber.replace(/\D/g, '');
  
  // Si el n√∫mero empieza con 0, eliminarlo
  if (cleaned.startsWith('0')) {
    cleaned = cleaned.substring(1);
  }
  
  // Tomar los √∫ltimos 9 d√≠gitos
  if (cleaned.length >= 9) {
    cleaned = cleaned.slice(-9);
  } else {
    // Si tiene menos de 9 d√≠gitos, el n√∫mero podr√≠a ser inv√°lido
    return null;
  }
  
  // A√±adir el prefijo de Ecuador
  return '+593' + cleaned;
}

// Esta funcionalidad ahora se maneja en el servidor (Apps Script)
// Las siguientes funciones se mantienen para compatibilidad pero no se usan directamente

// Funci√≥n para verificar si un n√∫mero existe en WhatsApp (ahora se hace en el servidor)
async function checkWhatsAppNumber(phoneNumber) {
  try {
    updateSendingStatus(`Verificando n√∫mero en WhatsApp: ${phoneNumber}`);
    
    // Ahora esta verificaci√≥n se hace en el servidor
    const result = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .checkWhatsAppNumber(phoneNumber);
    });
    
    return result && result.exists === true;
  } catch (error) {
    console.error('Error al verificar n√∫mero de WhatsApp:', error);
    return false;
  }
}

// Esta funci√≥n ya no se usa directamente, todo se maneja desde el servidor
async function sendWhatsAppMedia(phoneNumber, imageUrl, caption) {
  console.log('Esta funci√≥n ya no se usa directamente, se maneja desde el servidor');
  return false;
}

// Funci√≥n para actualizar el estado del env√≠o
function updateSendingStatus(message) {
  const statusElement = document.getElementById('sendingStatus');
  if (statusElement) {
    statusElement.textContent = message;
  }
}

// Funci√≥n para actualizar el progreso del env√≠o
function updateSendingProgress(sent, total) {
  const progressElement = document.getElementById('sendingProgress');
  if (progressElement) {
    progressElement.textContent = `${sent} de ${total} mensajes enviados`;
  }
}

// Funci√≥n para mostrar error durante el env√≠o
function showSendingError(message) {
  document.getElementById('sendingSection').classList.add('hidden');
  document.getElementById('completedSection').classList.remove('hidden');
  
  const statusElement = document.getElementById('completedStatus');
  if (statusElement) {
    statusElement.innerHTML = `<span class="text-red-600">Error: ${message}</span>`;
  }
  
  const statsElement = document.getElementById('completedStats');
  if (statsElement) {
    statsElement.textContent = "No se pudieron enviar los mensajes.";
  }
}

// Funci√≥n para mostrar el estado completado
function showCompletedStatus(sent, failed, total) {
  document.getElementById('sendingSection').classList.add('hidden');
  document.getElementById('completedSection').classList.remove('hidden');
  
  const statusElement = document.getElementById('completedStatus');
  if (statusElement) {
    if (sent > 0) {
      statusElement.innerHTML = `<span class="text-green-600">¬°Env√≠o completado!</span>`;
    } else {
      statusElement.innerHTML = `<span class="text-red-600">No se pudo enviar ning√∫n mensaje.</span>`;
    }
  }
  
  const statsElement = document.getElementById('completedStats');
  if (statsElement) {
    statsElement.textContent = `Enviados: ${sent} | Fallidos: ${failed} | Total: ${total}`;
  }
}

// Funci√≥n para simular la carga de la imagen al servidor (en producci√≥n, esto subir√≠a la imagen a un servidor real)
async function uploadImageToServer(imageData) {
  // Simular un retraso de carga
  await new Promise(resolve => setTimeout(resolve, 1500));
  
  // En una implementaci√≥n real, aqu√≠ subir√≠amos la imagen a un servidor y obtendr√≠amos una URL
  // Por ahora, simplemente devolvemos el Data URL
  return imageData;
}

// Integraci√≥n con Apps Script para obtener clientes y enviar mensajes

// Funci√≥n para obtener y transformar la imagen a una URL utilizable
async function prepareImageForSending(imageData) {
  if (!imageData) return null;
  
  // En un entorno real, aqu√≠ subir√≠amos la imagen a un servicio como Google Drive
  // y obtendr√≠amos una URL compartible
  
  try {
    // Simulaci√≥n: Normalmente llamar√≠amos a google.script.run para subir la imagen
    updateSendingStatus("Subiendo imagen...");
    
    // En un caso real, subir√≠amos la imagen y obtendr√≠amos una URL
    const imageUrl = await uploadImageToServer(imageData);
    
    return imageUrl;
  } catch (error) {
    console.error('Error al preparar la imagen:', error);
    showSendingError("Error al preparar la imagen: " + error.message);
    return null;
  }
}

// Iniciar la funci√≥n cuando la p√°gina est√© lista
document.addEventListener('DOMContentLoaded', function() {
  console.log('WhatsApp Integration Script loaded');
});

// 1. Modal para selecci√≥n de cliente
const clienteSelectionModal = `
<div id="clienteSelectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="min-h-screen px-4 text-center">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-black opacity-75"></div>
        </div>

        <div class="inline-block w-full max-w-3xl my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-xl rounded-lg">
            <div class="bg-white px-6 py-6">
                <!-- Cabecera -->
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Convertir Recibo a Factura</h2>
                    <button onclick="closeClienteSelectionModal()" class="text-gray-400 hover:text-primary focus:outline-none">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Info de la venta -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">Recibo:</p>
                            <p id="recibo-id" class="font-semibold"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Total:</p>
                            <p id="recibo-total" class="font-semibold"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Fecha original:</p>
                            <p id="recibo-fecha" class="font-semibold"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Fecha facturaci√≥n:</p>
                            <p id="factura-fecha" class="font-semibold text-primary"></p>
                        </div>
                    </div>
                </div>

                <!-- B√∫squeda de cliente -->
                <div class="mb-6">
                    <label for="cliente-search" class="block text-sm font-medium text-gray-700 mb-1">B√∫squeda de Cliente</label>
                    <div class="mt-1 relative rounded-md shadow-sm">
                        <input type="text" id="cliente-search" class="focus:ring-primary focus:border-primary block w-full pl-4 pr-10 py-3 border-gray-300 rounded-md" placeholder="Buscar por nombre, c√©dula o RUC">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Tabla de resultados -->
                <div class="overflow-x-auto max-h-72 overflow-y-auto mb-6 border rounded-lg">
                    <table id="cliente-results" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√©dula/RUC</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre/Raz√≥n Social</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Correo</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Resultados se insertan aqu√≠ -->
                        </tbody>
                    </table>
                </div>

                <!-- √Årea de consulta -->
                <div id="consulta-container" class="mb-6 p-4 bg-gray-50 rounded-lg hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Consulta de identificaci√≥n</h3>
                    <p class="text-sm text-gray-500 mb-4">No se encontr√≥ cliente registrado. Puede consultar la informaci√≥n en el servicio externo:</p>
                    <div class="flex space-x-2">
                        <div id="consulta-cedula-section" class="hidden">
                            <button id="consulta-cedula-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Consultar C√©dula</button>
                        </div>
                        <div id="consulta-ruc-section" class="hidden">
                            <button id="consulta-ruc-btn" class="px-4 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Consultar RUC</button>
                        </div>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="flex justify-center space-x-4 mt-6">
                    <button onclick="closeClienteSelectionModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>`;

// 2. Modal para registro/edici√≥n de cliente
const clienteFormModal = `
<div id="clienteFormModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="min-h-screen px-4 text-center">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-black opacity-75"></div>
        </div>

        <div class="inline-block w-full max-w-2xl my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-xl rounded-lg">
            <div class="bg-white px-6 py-6">
                <!-- Cabecera -->
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <h2 id="cliente-form-title" class="text-2xl font-bold text-gray-800">Registrar Cliente</h2>
                    <button onclick="closeClienteFormModal()" class="text-gray-400 hover:text-primary focus:outline-none">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Formulario -->
                <form id="cliente-form" class="space-y-4">
                    <input type="hidden" id="cliente-form-mode" value="new">
                    
                    <div>
                        <label for="cliente-cedula" class="block text-sm font-medium text-gray-700 mb-1">C√©dula/RUC *</label>
                        <input type="text" id="cliente-cedula" class="focus:ring-primary focus:border-primary block w-full px-4 py-2 border-gray-300 rounded-md" required readonly>
                    </div>
                    
                    <div>
                        <label for="cliente-razon-social" class="block text-sm font-medium text-gray-700 mb-1">Raz√≥n Social *</label>
                        <input type="text" id="cliente-razon-social" class="focus:ring-primary focus:border-primary block w-full px-4 py-2 border-gray-300 rounded-md" required>
                    </div>
                    
                    <div>
                        <label for="cliente-direccion" class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n *</label>
                        <input type="text" id="cliente-direccion" class="focus:ring-primary focus:border-primary block w-full px-4 py-2 border-gray-300 rounded-md" required>
                    </div>
                    
                    <div>
                        <label for="cliente-telefono" class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label>
                        <input type="text" id="cliente-telefono" class="focus:ring-primary focus:border-primary block w-full px-4 py-2 border-gray-300 rounded-md">
                    </div>
                    
                    <div>
                        <label for="cliente-correo" class="block text-sm font-medium text-gray-700 mb-1">Correo Electr√≥nico *</label>
                        <div class="flex items-center space-x-2">
                            <input type="email" id="cliente-correo" class="focus:ring-primary focus:border-primary block w-full px-4 py-2 border-gray-300 rounded-md" required>
                            <button type="button" id="no-correo-btn" class="px-2 py-1 bg-gray-200 text-gray-700 text-sm rounded hover:bg-gray-300 whitespace-nowrap">
                                Sin correo
                            </button>
                        </div>
                        <p class="text-sm text-red-500 mt-1">El correo es obligatorio para facturaci√≥n electr√≥nica</p>
                    </div>
                    
                    <div class="flex justify-center space-x-4 pt-4 border-t">
                        <button type="button" onclick="closeClienteFormModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-opacity-90 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit" id="cliente-save-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>`;

// 3. Modal de previsualizaci√≥n de factura
const facturaPreviewModal = `
<div id="facturaPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="min-h-screen px-4 text-center">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-black opacity-75"></div>
        </div>

        <div class="inline-block w-full max-w-4xl my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-xl rounded-lg">
            <div class="bg-white px-6 py-6">
                <!-- Cabecera -->
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Vista Previa de Factura</h2>
                    <button onclick="closeFacturaPreviewModal()" class="text-gray-400 hover:text-primary focus:outline-none">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Datos de factura -->
                <div class="mb-6 grid grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Datos de emisi√≥n</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Fecha:</span>
                                <span id="preview-fecha" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Tipo:</span>
                                <span class="font-medium text-primary">FACTURA</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Total:</span>
                                <span id="preview-total" class="font-medium"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-700 mb-2">Cliente</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-500">Identificaci√≥n:</span>
                                <span id="preview-cliente-id" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Raz√≥n Social:</span>
                                <span id="preview-cliente-nombre" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-500">Correo:</span>
                                <span id="preview-cliente-correo" class="font-medium"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detalles -->
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Detalles de la venta</h3>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">C√≥digo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="preview-detalle" class="bg-white divide-y divide-gray-200">
                                <!-- Filas de detalles se a√±aden aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Advertencia -->
                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-yellow-700">
                        <span class="font-bold">Importante:</span> Al generar la factura, se cambiar√° el tipo de documento a FACTURA y se actualizar√°n los datos del cliente, manteniendo los dem√°s detalles de la venta.
                    </p>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="flex justify-center space-x-4 mt-6">
                    <button onclick="closeFacturaPreviewModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        Cancelar
                    </button>
                    <button id="generar-factura-btn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        Generar Factura
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>`;

// 4. Modal para mostrar el progreso y resultado
const facturaProgressModal = `
<div id="facturaProgressModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="min-h-screen px-4 text-center">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-black opacity-75"></div>
        </div>

        <div class="inline-block w-full max-w-xl my-8 overflow-hidden text-left align-middle transition-all transform bg-white shadow-xl rounded-lg">
            <div class="bg-white px-6 py-6">
                <!-- Cabecera -->
                <div class="flex justify-between items-center mb-4 border-b pb-4">
                    <h2 id="progress-title" class="text-2xl font-bold text-gray-800">Procesando Factura</h2>
                    <button id="progress-close-btn" onclick="closeFacturaProgressModal()" class="text-gray-400 hover:text-primary focus:outline-none" style="display: none;">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Progreso -->
                <div id="progress-container" class="mb-6 py-8 flex flex-col items-center">
                    <div class="loader mb-4"></div>
                    <p id="progress-message" class="text-lg text-gray-700">Procesando la factura...</p>
                    <p id="progress-detail" class="text-sm text-gray-500 mt-2"></p>
                </div>

                <!-- Resultado (√©xito) -->
                <div id="success-container" class="mb-6 py-8 flex flex-col items-center hidden">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">¬°Factura procesada con √©xito!</h3>
                    <p id="success-message" class="text-center text-gray-600 mb-4"></p>
                    <div id="success-details" class="w-full bg-gray-50 p-4 rounded-lg text-sm">
                        <!-- Detalles del √©xito -->
                    </div>
                </div>

                <!-- Resultado (error) -->
                <div id="error-container" class="mb-6 py-8 flex flex-col items-center hidden">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Error al procesar factura</h3>
                    <p id="error-message" class="text-center text-gray-600 mb-4"></p>
                    <div id="error-details" class="w-full bg-gray-50 p-4 rounded-lg text-sm overflow-auto max-h-40">
                        <!-- Detalles del error -->
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div id="action-buttons" class="flex justify-center space-x-4 mt-6" style="display: none;">
                    <button onclick="closeFacturaProgressModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-opacity-90 transition-colors">
                        Cerrar
                    </button>
                    <button id="imprimir-factura-btn" onclick="imprimirFacturaGenerada()" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-opacity-90 transition-colors hidden">
                        Imprimir Factura
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>`;

// Agregar todos los modales al HTML
document.body.insertAdjacentHTML('beforeend', clienteSelectionModal);
document.body.insertAdjacentHTML('beforeend', clienteFormModal);
document.body.insertAdjacentHTML('beforeend', facturaPreviewModal);
document.body.insertAdjacentHTML('beforeend', facturaProgressModal);

// Variables para almacenar informaci√≥n durante el proceso
let currentSaleForFactura = null;
let selectedClientForFactura = null;
let generatedFacturaData = null;

//dia de las madres
// Variables para la funcionalidad de Promo Madre
let promoMadreActive = false;
let originalPrices = {};


// Funci√≥n para inicializar el bot√≥n de Promo Madre
function initPromoMadreButton() {
  const button = document.getElementById('promoMadreButton');
  if (button) {
    button.addEventListener('click', togglePromoMadre);
    
    // Recuperar estado guardado
    const savedState = localStorage.getItem('promoMadreActive');
    if (savedState === 'true') {
      promoMadreActive = true;
      button.classList.add('active');
      button.textContent = 'Quitar Promo Madre'; // Establecer texto inicial
      document.body.classList.add('promo-madre-active');
      applyPromoMadre();
    } else {
      // Asegurarse de que el texto sea correcto cuando est√° desactivado
      button.textContent = 'Aplicar Promo Madre';
    }
  }
}



// Funci√≥n para alternar el estado de Promo Madre
function togglePromoMadre() {
  const button = document.getElementById('promoMadreButton');
  const body = document.body;
  
  promoMadreActive = !promoMadreActive;
  
  if (promoMadreActive) {
    button.classList.add('active');
    button.textContent = 'Quitar Promo Madre'; // Cambiar texto a "Quitar"
    body.classList.add('promo-madre-active');
    applyPromoMadre();
  } else {
    button.classList.remove('active');
    button.textContent = 'Aplicar Promo Madre'; // Cambiar texto a "Aplicar"
    body.classList.remove('promo-madre-active');
    removePromoMadre();
  }
  
  // Guardar estado
  localStorage.setItem('promoMadreActive', promoMadreActive);
}

// Funci√≥n para aplicar el descuento del 10%
function applyPromoMadre() {
  const cart = document.getElementById("cart");
  const rows = cart.getElementsByTagName('tr');
  
  // Guardar precios originales y aplicar descuento
  for (let i = 1; i < rows.length; i++) {
    const cells = rows[i].getElementsByTagName('td');
    const priceCell = cells[3];
    const productCode = cells[1].innerText;
    
    // Obtener precio actual sin formato
    const currentPrice = parseFloat(priceCell.innerText.replace('$', '').replace(',', ''));
    
    // Guardar precio original si a√∫n no est√° guardado
    if (!originalPrices[productCode]) {
      originalPrices[productCode] = currentPrice;
    }
    
    // Calcular y aplicar precio con descuento
    const discountedPrice = originalPrices[productCode] * 0.9; // 10% de descuento
    priceCell.innerHTML = `<strong>${formatCurrency(discountedPrice)}</strong>`;
    
    // Actualizar el total de la fila
    updateCellTotal(priceCell);
  }
  
  // Mostrar notificaci√≥n
  showCustomAlert("¬°Promo Madre aplicada! 10% de descuento en todos los productos.");
}

// Funci√≥n para restaurar precios originales
function removePromoMadre() {
  const cart = document.getElementById("cart");
  const rows = cart.getElementsByTagName('tr');
  
  // Restaurar precios originales
  for (let i = 1; i < rows.length; i++) {
    const cells = rows[i].getElementsByTagName('td');
    const priceCell = cells[3];
    const productCode = cells[1].innerText;
    
    // Restaurar precio original si existe
    if (originalPrices[productCode]) {
      priceCell.innerHTML = `<strong>${formatCurrency(originalPrices[productCode])}</strong>`;
      
      // Actualizar el total de la fila
      updateCellTotal(priceCell);
    }
  }
  
  // Mostrar notificaci√≥n
  showCustomAlert("Promo Madre desactivada. Precios restaurados.");
}

// Funci√≥n para aplicar la promo a un nuevo producto agregado
function applyPromoToNewProduct(productCode, priceCell, originalPrice) {
  if (promoMadreActive) {
    // Guardar precio original
    originalPrices[productCode] = originalPrice;
    
    // Aplicar descuento
    const discountedPrice = originalPrice * 0.9;
    priceCell.innerHTML = `<strong>${formatCurrency(discountedPrice)}</strong>`;
    
    // Actualizar el total de la fila
    updateCellTotal(priceCell);
    return true;
  }
  return false;
}

</script>

</body>
</html>